{
  if (!isLoaded()) {
synchronized (NativeOsmandLibrary.class) {
      if (!isLoaded()) {
        isNativeSupported=false;
        try {
          log.debug("Loading native gnustl_shared...");
          System.loadLibrary("gnustl_shared");
          log.debug("Loading native cpufeatures_proxy...");
          System.loadLibrary("cpufeatures_proxy");
          if (android.os.Build.VERSION.SDK_INT >= 8) {
            log.debug("Loading jnigraphics, since Android >= 2.2 ...");
            System.loadLibrary("jnigraphics");
          }
          final String libCpuSuffix=cpuHasNeonSupport() ? "_neon" : "";
          log.debug("Loading native libraries...");
          try {
            loadNewCore(libCpuSuffix);
            log.debug("Creating NativeOsmandLibrary instance...");
            library=new NativeOsmandLibrary(true);
            isNativeSupported=true;
          }
 catch (          Error e) {
            log.error("Failed to load new native library",e);
          }
          if (!isNativeSupported) {
            loadOldCore(libCpuSuffix);
            log.debug("Creating NativeOsmandLibrary instance...");
            library=new NativeOsmandLibrary(false);
            log.debug("Initializing rendering rules storage...");
            NativeOsmandLibrary.initRenderingRulesStorage(storage);
            isNativeSupported=true;
          }
        }
 catch (        Throwable e) {
          log.error("Failed to load native library",e);
        }
      }
    }
  }
  return library;
}
