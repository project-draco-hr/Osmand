{
  interruptedSearch=false;
  searching=true;
  return searchUICore.search(text,new ResultMatcher<SearchResult>(){
    SearchResultCollection regionResultCollection=null;
    SearchCoreAPI regionResultApi=null;
    List<SearchResult> results=new ArrayList<>();
    @Override public boolean publish(    SearchResult object){
      if (paused) {
        if (results.size() > 0) {
          getResultCollection().getCurrentSearchResults().addAll(results);
        }
        return false;
      }
switch (object.objectType) {
case SEARCH_API_FINISHED:
        final SearchCoreAPI searchApi=(SearchCoreAPI)object.object;
      final List<SearchResult> apiResults;
    final SearchPhrase phrase=object.requiredSearchPhrase;
  final SearchCoreAPI regionApi=regionResultApi;
final SearchResultCollection regionCollection=regionResultCollection;
final boolean hasRegionCollection=(searchApi == regionApi && regionCollection != null);
if (hasRegionCollection) {
apiResults=regionCollection.getCurrentSearchResults();
}
 else {
apiResults=results;
searchUICore.sortSearchResults(phrase,apiResults);
}
regionResultApi=null;
regionResultCollection=null;
results=new ArrayList<>();
app.runInUIThread(new Runnable(){
@Override public void run(){
if (!paused) {
boolean appended=false;
if (getResultCollection() == null || getResultCollection().getPhrase() != phrase) {
setResultCollection(new SearchResultCollection(apiResults,phrase));
}
 else {
getResultCollection().getCurrentSearchResults().addAll(apiResults);
appended=true;
}
if (!hasRegionCollection) {
updateSearchResult(getResultCollection(),appended);
}
}
}
}
);
break;
case SEARCH_API_REGION_FINISHED:
regionResultApi=(SearchCoreAPI)object.object;
final List<SearchResult> regionResults=new ArrayList<>(results);
final SearchPhrase regionPhrase=object.requiredSearchPhrase;
searchUICore.sortSearchResults(regionPhrase,regionResults);
app.runInUIThread(new Runnable(){
@Override public void run(){
if (!paused) {
boolean appended=getResultCollection() != null && getResultCollection().getPhrase() == regionPhrase;
regionResultCollection=new SearchResultCollection(regionResults,regionPhrase);
if (appended) {
List<SearchResult> res=new ArrayList<>(getResultCollection().getCurrentSearchResults());
res.addAll(regionResults);
SearchResultCollection resCollection=new SearchResultCollection(res,regionPhrase);
updateSearchResult(resCollection,true);
}
 else {
updateSearchResult(regionResultCollection,false);
}
}
}
}
);
break;
case PARTIAL_LOCATION:
app.runInUIThread(new Runnable(){
@Override public void run(){
foundPartialLocation=true;
updateToolbarButton();
}
}
);
break;
default :
results.add(object);
}
return false;
}
@Override public boolean isCancelled(){
return paused;
}
}
);
}
