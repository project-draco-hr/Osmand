{
  final String eglExtensions=egl.eglQueryString(display,EGL10.EGL_EXTENSIONS);
  Log.i(NATIVE_TAG,"EGL extensions: " + eglExtensions);
  final String eglVersion=egl.eglQueryString(display,EGL10.EGL_VERSION);
  Log.i(NATIVE_TAG,"EGL version: " + eglVersion);
  Log.i(NATIVE_TAG,"Creating main context...");
  final int[] contextAttribList={EGL14.EGL_CONTEXT_CLIENT_VERSION,2,EGL10.EGL_NONE};
  EGLContext mainContext=null;
  try {
    mainContext=egl.eglCreateContext(display,eglConfig,EGL10.EGL_NO_CONTEXT,contextAttribList);
  }
 catch (  Exception e) {
    Log.e(NATIVE_TAG,"Failed to create main context",e);
  }
  if (mainContext == null || mainContext == EGL10.EGL_NO_CONTEXT) {
    Log.e(NATIVE_TAG,"Failed to create main context: " + egl.eglGetError());
    mainContext=null;
    System.exit(0);
  }
  Log.i(NATIVE_TAG,"Creating GPU worker context...");
  try {
    gpuWorkerContext=egl.eglCreateContext(display,eglConfig,mainContext,contextAttribList);
  }
 catch (  Exception e) {
    Log.e(NATIVE_TAG,"Failed to create GPU worker context",e);
  }
  if (gpuWorkerContext == null || gpuWorkerContext == EGL10.EGL_NO_CONTEXT) {
    Log.e(NATIVE_TAG,"Failed to create GPU worker context: " + egl.eglGetError());
    gpuWorkerContext=null;
  }
  if (gpuWorkerContext != null) {
    Log.i(NATIVE_TAG,"Creating GPU worker fake surface...");
    try {
      final int[] surfaceAttribList={EGL10.EGL_WIDTH,1,EGL10.EGL_HEIGHT,1,EGL10.EGL_NONE};
      gpuWorkerFakeSurface=egl.eglCreatePbufferSurface(display,eglConfig,surfaceAttribList);
    }
 catch (    Exception e) {
      Log.e(NATIVE_TAG,"Failed to create GPU worker fake surface",e);
    }
    if (gpuWorkerFakeSurface == null || gpuWorkerFakeSurface == EGL10.EGL_NO_SURFACE) {
      Log.e(NATIVE_TAG,"Failed to create GPU worker fake surface: " + egl.eglGetError());
      gpuWorkerFakeSurface=null;
    }
  }
  MapRendererSetupOptions rendererSetupOptions=new MapRendererSetupOptions();
  if (gpuWorkerContext != null && gpuWorkerFakeSurface != null) {
    rendererSetupOptions.setGpuWorkerThreadEnabled(true);
    gpuWorkerThreadPrologue=new GpuWorkerThreadPrologue(egl,display,gpuWorkerContext,gpuWorkerFakeSurface);
    rendererSetupOptions.setGpuWorkerThreadPrologue(gpuWorkerThreadPrologue.getBinding());
    gpuWorkerThreadEpilogue=new GpuWorkerThreadEpilogue(egl);
    rendererSetupOptions.setGpuWorkerThreadEpilogue(gpuWorkerThreadEpilogue.getBinding());
  }
 else {
    rendererSetupOptions.setGpuWorkerThreadEnabled(false);
  }
  renderRequestCallback=new RenderRequestCallback();
  rendererSetupOptions.setFrameUpdateRequestCallback(renderRequestCallback.getBinding());
  mapRenderer.setup(rendererSetupOptions);
  return mainContext;
}
