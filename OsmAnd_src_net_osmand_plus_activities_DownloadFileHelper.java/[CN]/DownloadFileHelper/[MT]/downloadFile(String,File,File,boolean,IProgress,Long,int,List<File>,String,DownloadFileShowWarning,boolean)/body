{
  FileOutputStream out=null;
  try {
    out=new FileOutputStream(fileToDownload);
    try {
      if (parts == 1) {
        URL url=new URL("http://download.osmand.net/download?file=" + fileName + "&"+ Version.getVersionAsURLParam());
        downloadFile(fileName,out,url,null,indexOfAllFiles,progress,forceWifi);
      }
 else {
        for (int i=1; i <= parts; i++) {
          URL url=new URL("http://download.osmand.net/download?file=" + fileName + "-"+ i+ "&"+ Version.getVersionAsURLParam());
          downloadFile(fileName,out,url," [" + i + "/"+ parts+ "]",indexOfAllFiles,progress,forceWifi);
        }
      }
    }
  finally {
      out.close();
      out=null;
    }
    File toIndex=fileToDownload;
    if (fileToDownload.getName().endsWith(".zip")) {
      if (!unzipToDir) {
        toIndex=fileToUnZip;
      }
 else {
        fileToUnZip.mkdirs();
      }
      ZipInputStream zipIn=new ZipInputStream(new FileInputStream(fileToDownload));
      ZipEntry entry=null;
      boolean first=true;
      while ((entry=zipIn.getNextEntry()) != null) {
        int size=(int)entry.getSize();
        progress.startTask(ctx.getString(R.string.unzipping_file),size);
        File fs;
        if (!unzipToDir) {
          if (first) {
            fs=toIndex;
            first=false;
          }
 else {
            String name=entry.getName();
            int ind=name.lastIndexOf('_');
            if (ind > 0) {
              int i=name.indexOf('.',ind);
              if (i > 0) {
                name=name.substring(0,ind) + name.substring(i,name.length());
              }
            }
            fs=new File(fileToUnZip.getParent(),name);
            toIndex=fs;
          }
        }
 else {
          fs=new File(fileToUnZip,entry.getName());
        }
        out=new FileOutputStream(fs);
        int read;
        byte[] buffer=new byte[BUFFER_SIZE];
        while ((read=zipIn.read(buffer)) != -1) {
          out.write(buffer,0,read);
          progress.progress(read);
        }
        out.close();
      }
      zipIn.close();
      fileToDownload.delete();
    }
    ArrayList<String> warnings=new ArrayList<String>();
    ResourceManager manager=((OsmandApplication)ctx.getApplicationContext()).getResourceManager();
    if (dateModified != null) {
      toIndex.setLastModified(dateModified);
    }
    if (toIndex.getName().endsWith(IndexConstants.POI_INDEX_EXT)) {
      manager.indexingPoi(progress,warnings,toIndex);
    }
    if (dateModified != null) {
      toIndex.setLastModified(dateModified);
      manager.updateIndexLastDateModified(toIndex);
    }
    toReIndex.add(toIndex);
    if (warnings.isEmpty()) {
      showWarningCallback.showWarning(ctx.getString(R.string.download_index_success));
    }
 else {
      showWarningCallback.showWarning(warnings.get(0));
    }
    return true;
  }
 catch (  IOException e) {
    log.error("Exception ocurred",e);
    showWarningCallback.showWarning(ctx.getString(R.string.error_io_error));
    if (out != null) {
      try {
        out.close();
      }
 catch (      IOException e1) {
      }
    }
    fileToDownload.delete();
    return false;
  }
catch (  InterruptedException e) {
    fileToDownload.delete();
    throw e;
  }
}
