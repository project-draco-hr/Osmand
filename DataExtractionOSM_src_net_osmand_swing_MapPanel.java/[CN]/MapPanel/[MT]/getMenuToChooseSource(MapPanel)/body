{
  final JMenu tiles=new JMenu(Messages.getString("MapPanel.SOURCE.OF.TILES"));
  final JMenu downloadedMenu=new JMenu("Additional");
  final File tilesDirectory=DataExtractionSettings.getSettings().getTilesDirectory();
  Map<String,TileSourceTemplate> udf=getCommonTemplates(tilesDirectory);
  final List<TileSourceTemplate> downloaded=TileSourceManager.downloadTileSourceTemplates(MapCreatorVersion.APP_VERSION);
  final Map<TileSourceTemplate,JCheckBoxMenuItem> items=new IdentityHashMap<TileSourceTemplate,JCheckBoxMenuItem>();
  tiles.add(downloadedMenu);
  for (  final TileSourceTemplate l : udf.values()) {
    if (l == null) {
      continue;
    }
    JCheckBoxMenuItem menuItem=new JCheckBoxMenuItem(l.getName());
    tiles.add(menuItem);
    items.put(l,menuItem);
    menuItem.addActionListener(new ActionListener(){
      @Override public void actionPerformed(      ActionEvent e){
        for (        final Map.Entry<TileSourceTemplate,JCheckBoxMenuItem> es : items.entrySet()) {
          es.getValue().setSelected(l.equals(es.getKey()));
        }
        File dir=new File(tilesDirectory,l.getName());
        try {
          dir.mkdirs();
          TileSourceManager.createMetaInfoFile(dir,l,false);
        }
 catch (        IOException e1) {
        }
        panel.setMapName(l);
      }
    }
);
  }
  if (downloaded != null) {
    for (    final TileSourceTemplate l : downloaded) {
      if (l == null) {
        continue;
      }
      JCheckBoxMenuItem menuItem=new JCheckBoxMenuItem(l.getName());
      downloadedMenu.add(menuItem);
      items.put(l,menuItem);
      menuItem.addActionListener(new ActionListener(){
        @Override public void actionPerformed(        ActionEvent e){
          for (          final Map.Entry<TileSourceTemplate,JCheckBoxMenuItem> es : items.entrySet()) {
            es.getValue().setSelected(l.equals(es.getKey()));
          }
          File dir=new File(tilesDirectory,l.getName());
          try {
            dir.mkdirs();
            TileSourceManager.createMetaInfoFile(dir,l,true);
          }
 catch (          IOException e1) {
          }
          panel.setMapName(l);
        }
      }
);
    }
  }
  for (  final Map.Entry<TileSourceTemplate,JCheckBoxMenuItem> em : items.entrySet()) {
    if (Algoritms.objectEquals(panel.getMap(),em.getKey())) {
      em.getValue().setSelected(true);
    }
  }
  tiles.addSeparator();
  tiles.add(createNewTileSourceAction(panel,tiles,items));
  return tiles;
}
