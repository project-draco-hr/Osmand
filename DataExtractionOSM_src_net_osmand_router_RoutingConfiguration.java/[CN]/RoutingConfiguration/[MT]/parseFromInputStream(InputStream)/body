{
  try {
    final SAXParser parser=SAXParserFactory.newInstance().newSAXParser();
    final RoutingConfiguration.Builder config=new RoutingConfiguration.Builder();
    DefaultHandler handler=new DefaultHandler(){
      String currentSelectedRouter=null;
      GeneralRouter currentRouter=null;
      String previousKey=null;
      String previousTag=null;
      @Override public void startElement(      String uri,      String localName,      String qName,      Attributes attributes) throws SAXException {
        String name=parser.isNamespaceAware() ? localName : qName;
        if ("osmand_routing_config".equals(name)) {
          config.defaultRouter=attributes.getValue("defaultProfile");
        }
 else         if ("attribute".equals(name)) {
          previousKey=attributes.getValue("name");
          previousTag=name;
          if (currentSelectedRouter != null) {
            previousKey=currentSelectedRouter + "$" + previousKey;
          }
          config.attributes.put(previousKey,attributes.getValue("value"));
        }
 else         if ("routingProfile".equals(name)) {
          currentSelectedRouter=attributes.getValue("name");
          Map<String,String> attrs=new LinkedHashMap<String,String>();
          for (int i=0; i < attributes.getLength(); i++) {
            attrs.put(parser.isNamespaceAware() ? attributes.getLocalName(i) : attributes.getQName(i),attributes.getValue(i));
          }
          currentRouter=new GeneralRouter(GeneralRouterProfile.valueOf(attributes.getValue("baseProfile").toUpperCase()),attrs);
          config.routers.put(currentSelectedRouter,currentRouter);
        }
 else         if ("specialization".equals(name)) {
          String in=attributes.getValue("input");
          if (previousKey != null) {
            String k=in + ":" + previousKey;
            if (attributes.getValue("penalty") != null) {
              double penalty=parseSilentDouble(attributes.getValue("penalty"),0);
              currentRouter.obstacles.put(k,penalty);
              double routingPenalty=parseSilentDouble(attributes.getValue("routingPenalty"),penalty);
              currentRouter.routingObstacles.put(k,routingPenalty);
            }
            if (attributes.getValue("priority") != null) {
              currentRouter.highwayPriorities.put(k,parseSilentDouble(attributes.getValue("priority"),0));
            }
            if (attributes.getValue("dynamicPriority") != null) {
              currentRouter.highwayFuturePriorities.put(k,parseSilentDouble(attributes.getValue("dynamicPriority"),0));
            }
            if (attributes.getValue("speed") != null) {
              currentRouter.highwaySpeed.put(k,parseSilentDouble(attributes.getValue("speed"),0));
            }
            if ("avoid".equals(previousTag)) {
              double priority=parseSilentDouble(attributes.getValue("decreasedPriority"),0);
              if (priority == 0) {
                currentRouter.avoid.put(k,priority);
              }
 else {
                currentRouter.highwayPriorities.put(k,priority);
              }
            }
          }
        }
 else         if ("road".equals(name)) {
          previousTag=name;
          previousKey=attributes.getValue("tag") + "$" + attributes.getValue("value");
          currentRouter.highwayPriorities.put(previousKey,parseSilentDouble(attributes.getValue("priority"),1));
          currentRouter.highwayFuturePriorities.put(previousKey,parseSilentDouble(attributes.getValue("dynamicPriority"),1));
          currentRouter.highwaySpeed.put(previousKey,parseSilentDouble(attributes.getValue("speed"),10));
        }
 else         if ("obstacle".equals(name)) {
          previousTag=name;
          previousKey=attributes.getValue("tag") + "$" + attributes.getValue("value");
          double penalty=parseSilentDouble(attributes.getValue("penalty"),0);
          currentRouter.obstacles.put(previousKey,penalty);
          double routingPenalty=parseSilentDouble(attributes.getValue("routingPenalty"),penalty);
          currentRouter.routingObstacles.put(previousKey,routingPenalty);
        }
 else         if ("avoid".equals(name)) {
          previousTag=name;
          previousKey=attributes.getValue("tag") + "$" + attributes.getValue("value");
          double priority=parseSilentDouble(attributes.getValue("decreasedPriority"),0);
          if (priority == 0) {
            currentRouter.avoid.put(previousKey,priority);
          }
 else {
            currentRouter.highwayPriorities.put(previousKey,priority);
          }
        }
      }
    }
;
    parser.parse(is,handler);
    return config;
  }
 catch (  ParserConfigurationException e) {
    throw new SAXException(e);
  }
}
