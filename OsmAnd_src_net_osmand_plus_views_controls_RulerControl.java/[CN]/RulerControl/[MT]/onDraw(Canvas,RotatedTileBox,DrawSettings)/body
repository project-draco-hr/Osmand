{
  if (!mapActivity.getMyApplication().getSettings().SHOW_RULER.get()) {
    return;
  }
  OsmandMapTileView view=mapActivity.getMapView();
  boolean isNight=nightMode == null ? false : nightMode.isNightMode();
  if (view.isZooming()) {
    cacheRulerText=null;
  }
 else   if (((isNight != isNightRemembered) || (tb.getZoom() != cacheRulerZoom) || Math.abs(tb.getCenterTileX() - cacheRulerTileX) + Math.abs(tb.getCenterTileY() - cacheRulerTileY) > 1) && tb.getPixWidth() > 0) {
    cacheRulerZoom=(tb.getZoom());
    cacheRulerTileX=tb.getCenterTileX();
    cacheRulerTileY=tb.getCenterTileY();
    final double dist=tb.getDistance(0,tb.getPixHeight() / 2,tb.getPixWidth(),tb.getPixHeight() / 2);
    double pixDensity=tb.getPixWidth() / dist;
    double roundedDist=OsmAndFormatter.calculateRoundedDist(dist * screenRulerPercent,view.getApplication());
    int cacheRulerDistPix=(int)(pixDensity * roundedDist);
    cacheRulerText=ShadowText.create(OsmAndFormatter.getFormattedDistance((float)roundedDist,view.getApplication()));
    cacheRulerTextLen=rulerTextPaint.measureText(cacheRulerText.getText());
    rulerDrawable=(isNight ? mapActivity.getResources().getDrawable(R.drawable.ruler_night) : mapActivity.getResources().getDrawable(R.drawable.ruler));
    Rect bounds=rulerDrawable.getBounds();
    bounds.left=bounds.right - cacheRulerDistPix;
    rulerDrawable.setBounds(bounds);
    rulerDrawable.invalidateSelf();
  }
  if (cacheRulerText != null) {
    Rect bounds=rulerDrawable.getBounds();
    rulerDrawable.draw(canvas);
    int shadowColor=isNight == true ? mapActivity.getResources().getColor(R.color.widgettext_shadow_night) : Color.WHITE;
    cacheRulerText.draw(canvas,bounds.left + (bounds.width() - cacheRulerTextLen) / 2,bounds.bottom - 8 * scaleCoefficient,rulerTextPaint,shadowColor);
  }
  isNightRemembered=isNight;
}
