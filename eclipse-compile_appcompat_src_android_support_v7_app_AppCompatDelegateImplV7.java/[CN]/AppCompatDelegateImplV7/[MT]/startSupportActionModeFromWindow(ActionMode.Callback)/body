{
  if (mActionMode != null) {
    mActionMode.finish();
  }
  final ActionMode.Callback wrappedCallback=new ActionModeCallbackWrapper(callback);
  final Context context=getActionBarThemedContext();
  if (mActionModeView == null) {
    if (mIsFloating) {
      mActionModeView=new ActionBarContextView(context);
      mActionModePopup=new PopupWindow(context,null,R.attr.actionModePopupWindowStyle);
      mActionModePopup.setContentView(mActionModeView);
      mActionModePopup.setWidth(ViewGroup.LayoutParams.MATCH_PARENT);
      TypedValue heightValue=new TypedValue();
      mContext.getTheme().resolveAttribute(R.attr.actionBarSize,heightValue,true);
      final int height=TypedValue.complexToDimensionPixelSize(heightValue.data,mContext.getResources().getDisplayMetrics());
      mActionModeView.setContentHeight(height);
      mActionModePopup.setHeight(ViewGroup.LayoutParams.WRAP_CONTENT);
      mShowActionModePopup=new Runnable(){
        public void run(){
          mActionModePopup.showAtLocation(mActionModeView,Gravity.TOP | Gravity.FILL_HORIZONTAL,0,0);
        }
      }
;
    }
 else {
      ViewStubCompat stub=(ViewStubCompat)mSubDecor.findViewById(R.id.action_mode_bar_stub);
      if (stub != null) {
        stub.setLayoutInflater(LayoutInflater.from(context));
        mActionModeView=(ActionBarContextView)stub.inflate();
      }
    }
  }
  if (mActionModeView != null) {
    mActionModeView.killMode();
    ActionMode mode=new StandaloneActionMode(context,mActionModeView,wrappedCallback,mActionModePopup == null);
    if (callback.onCreateActionMode(mode,mode.getMenu())) {
      mode.invalidate();
      mActionModeView.initForMode(mode);
      mActionModeView.setVisibility(View.VISIBLE);
      mActionMode=mode;
      if (mActionModePopup != null) {
        mWindow.getDecorView().post(mShowActionModePopup);
      }
      mActionModeView.sendAccessibilityEvent(AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED);
      if (mActionModeView.getParent() != null) {
        ViewCompat.requestApplyInsets((View)mActionModeView.getParent());
      }
    }
 else {
      mActionMode=null;
    }
  }
  if (mActionMode != null && mAppCompatCallback != null) {
    mAppCompatCallback.onSupportActionModeStarted(mActionMode);
  }
  return mActionMode;
}
