{
  final OsmandSettings settings=getApplication().getSettings();
  final ContextMenuAdapter adapter=new ContextMenuAdapter(activity);
  String appMode=settings.getApplicationMode().toHumanString(view.getApplication());
  adapter.registerItem(R.string.layer_map_appearance + " [" + appMode+ "] ",R.drawable.list_activities_config);
  adapter.registerSelectedItem(R.string.layer_poi,settings.SHOW_POI_OVER_MAP.get() ? 1 : 0,R.drawable.list_activities_poi);
  adapter.registerSelectedItem(R.string.layer_poi_label,settings.SHOW_POI_LABEL.get() ? 1 : 0,R.drawable.list_activities_poi_labels);
  adapter.registerSelectedItem(R.string.layer_favorites,settings.SHOW_FAVORITES.get() ? 1 : 0,R.drawable.list_activities_favorites2);
  adapter.registerSelectedItem(R.string.layer_gpx_layer,getApplication().getGpxFileToDisplay() != null ? 1 : 0,R.drawable.list_activities_gpx_tracks);
  adapter.registerSelectedItem(R.string.layer_transport,settings.SHOW_TRANSPORT_OVER_MAP.get() ? 1 : 0,R.drawable.list_activities_transport_stops);
  if (TransportRouteHelper.getInstance().routeIsCalculated()) {
    adapter.registerSelectedItem(R.string.layer_transport_route,1,R.drawable.list_activities_transport_stops);
  }
  OsmandPlugin.registerLayerContextMenu(mapView,adapter,activity);
  final LayerMenuListener listener=new LayerMenuListener(adapter,mapView,settings);
  Builder b=new AlertDialog.Builder(activity);
  final int padding=(int)(12 * activity.getResources().getDisplayMetrics().density + 0.5f);
  ListAdapter listAdapter=new ArrayAdapter<String>(activity,R.layout.list_menu_item,R.id.title,adapter.getItemNames()){
    @Override public View getView(    final int position,    View convertView,    ViewGroup parent){
      View v=activity.getLayoutInflater().inflate(R.layout.list_menu_item,null);
      TextView tv=(TextView)v.findViewById(R.id.title);
      tv.setText(adapter.getItemName(position));
      if (adapter.getImageId(position) != 0) {
        tv.setCompoundDrawablesWithIntrinsicBounds(adapter.getImageId(position),0,0,0);
      }
 else {
        tv.setCompoundDrawablesWithIntrinsicBounds(R.drawable.list_activities_transparent,0,0,0);
      }
      tv.setCompoundDrawablePadding(padding);
      final CheckBox ch=((CheckBox)v.findViewById(R.id.check_item));
      if (adapter.getSelection(position) == -1) {
        ch.setVisibility(View.INVISIBLE);
      }
 else {
        ch.setOnCheckedChangeListener(null);
        ch.setChecked(adapter.getSelection(position) > 0);
        ch.setOnCheckedChangeListener(new OnCheckedChangeListener(){
          @Override public void onCheckedChanged(          CompoundButton buttonView,          boolean isChecked){
            listener.onClick(position,isChecked);
          }
        }
);
      }
      return v;
    }
  }
;
  b.setAdapter(listAdapter,new OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int position){
      if (adapter.getSelection(position) >= 0) {
        listener.onClick(position,!(adapter.getSelection(position) > 0));
      }
 else {
        listener.onClick(position,adapter.getSelection(position) > 0);
      }
    }
  }
);
  final AlertDialog dlg=b.create();
  listener.setDialog(dlg);
  dlg.setCanceledOnTouchOutside(true);
  dlg.show();
}
