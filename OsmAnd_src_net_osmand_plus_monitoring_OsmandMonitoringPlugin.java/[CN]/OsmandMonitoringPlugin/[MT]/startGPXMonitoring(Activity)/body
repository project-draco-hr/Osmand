{
  final ValueHolder<Integer> vs=new ValueHolder<Integer>();
  final ValueHolder<Boolean> choice=new ValueHolder<Boolean>();
  vs.value=settings.SAVE_GLOBAL_TRACK_INTERVAL.get();
  choice.value=settings.SAVE_GLOBAL_TRACK_REMEMBER.get();
  final Runnable runnable=new Runnable(){
    public void run(){
      app.getSavingTrackHelper().startNewSegment();
      settings.SAVE_GLOBAL_TRACK_INTERVAL.set(vs.value);
      settings.SAVE_GLOBAL_TRACK_TO_GPX.set(true);
      settings.SAVE_GLOBAL_TRACK_REMEMBER.set(choice.value);
      if (settings.SAVE_GLOBAL_TRACK_INTERVAL.get() < 30000) {
        settings.SERVICE_OFF_INTERVAL.set(0);
      }
 else {
        settings.SERVICE_OFF_INTERVAL.set(settings.SAVE_GLOBAL_TRACK_INTERVAL.get());
      }
      app.startNavigationService(NavigationService.USED_BY_GPX);
    }
  }
;
  if (choice.value) {
    runnable.run();
  }
 else {
    showIntervalChooseDialog(map,app.getString(R.string.save_track_interval_globally) + " : %s",app.getString(R.string.save_track_to_gpx_globally),SECONDS,MINUTES,choice,vs,new OnClickListener(){
      @Override public void onClick(      DialogInterface dialog,      int which){
        runnable.run();
      }
    }
);
  }
  String stop=map.getResources().getString(R.string.shared_string_control_stop);
  Intent stopIntent=new Intent(NavigationService.OSMAND_STOP_SERVICE_ACTION);
  PendingIntent stopPendingIntent=PendingIntent.getBroadcast(map,0,stopIntent,PendingIntent.FLAG_UPDATE_CURRENT);
  String save=map.getResources().getString(R.string.shared_string_save);
  Intent saveIntent=new Intent(OSMAND_SAVE_SERVICE_ACTION);
  PendingIntent savePendingIntent=PendingIntent.getBroadcast(map,0,saveIntent,PendingIntent.FLAG_UPDATE_CURRENT);
  BroadcastReceiver saveBroadcastReceiver=new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      final OsmandMonitoringPlugin plugin=OsmandPlugin.getEnabledPlugin(OsmandMonitoringPlugin.class);
      if (plugin != null) {
        plugin.saveCurrentTrack();
      }
    }
  }
;
  map.registerReceiver(saveBroadcastReceiver,new IntentFilter(OSMAND_SAVE_SERVICE_ACTION));
  final NotificationCompat.Builder notificationBuilder=new android.support.v7.app.NotificationCompat.Builder(map).setContentTitle(map.getResources().getString(R.string.map_widget_monitoring)).setSmallIcon(R.drawable.ic_action_polygom_dark).setOngoing(true).addAction(R.drawable.ic_action_rec_stop,stop,stopPendingIntent).addAction(R.drawable.ic_action_save,save,savePendingIntent);
  NotificationManager mNotificationManager=(NotificationManager)map.getSystemService(Context.NOTIFICATION_SERVICE);
  mNotificationManager.notify(notificationId,notificationBuilder.build());
}
