{
  if (mapView != null) {
    if (isMapLinkedToLocation() && location != null) {
      if (settings.AUTO_ZOOM_MAP.get()) {
        autozoom(location);
      }
      int currentMapRotation=settings.ROTATE_MAP.get();
      if (currentMapRotation == OsmandSettings.ROTATE_MAP_BEARING) {
        if (location.hasBearing()) {
          if (location.getBearing() != 0f) {
            mapView.setRotate(-location.getBearing());
          }
        }
 else         if (app.getRoutingHelper().isFollowingMode() && settings.USE_COMPASS_IN_NAVIGATION.get()) {
          long now=System.currentTimeMillis();
          OsmAndLocationProvider provider=app.getLocationProvider();
          Float lastSensorRotation=provider.getHeading();
          if (lastSensorRotation != null && Math.abs(MapUtils.degreesDiff(mapView.getRotate(),-lastSensorRotation)) > 15) {
            if (now - lastTimeSensorMapRotation > 3500) {
              lastTimeSensorMapRotation=now;
              mapView.setRotate(-lastSensorRotation);
            }
          }
        }
      }
      mapView.setLatLon(location.getLatitude(),location.getLongitude());
      RoutingHelper routingHelper=app.getRoutingHelper();
      boolean enableSensorNavigation=false;
      if (routingHelper.isFollowingMode() && settings.USE_COMPASS_IN_NAVIGATION.get()) {
        enableSensorNavigation=!location.hasBearing();
      }
      registerUnregisterSensor(location,enableSensorNavigation);
    }
    RoutingHelper routingHelper=app.getRoutingHelper();
    if (!routingHelper.isFollowingMode() && followingMode) {
      app.runInUIThread(new Runnable(){
        @Override public void run(){
          settings.APPLICATION_MODE.set(settings.DEFAULT_APPLICATION_MODE.get());
        }
      }
);
    }
    followingMode=routingHelper.isFollowingMode();
    mapView.refreshMap();
  }
}
