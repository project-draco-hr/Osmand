{
  if (mapView != null) {
    if (isMapLinkedToLocation() && location != null) {
      if (settings.AUTO_ZOOM_MAP.get() != AutoZoomMap.NONE) {
        autozoom(location);
      }
      int currentMapRotation=settings.ROTATE_MAP.get();
      boolean enableCompass=false;
      if (currentMapRotation == OsmandSettings.ROTATE_MAP_BEARING) {
        boolean smallSpeed=!location.hasSpeed() || location.getSpeed() < 0.5;
        boolean fMode=app.getRoutingHelper().isFollowingMode();
        enableCompass=(!location.hasBearing() || smallSpeed) && fMode && settings.USE_COMPASS_IN_NAVIGATION.get();
        if (location.hasBearing() && !smallSpeed) {
          if (location.getBearing() != 0f) {
            mapView.setRotate(-location.getBearing());
          }
        }
 else         if (enableCompass) {
          long now=System.currentTimeMillis();
          OsmAndLocationProvider provider=app.getLocationProvider();
          Float lastSensorRotation=provider.getHeading();
          if (lastSensorRotation != null && Math.abs(MapUtils.degreesDiff(mapView.getRotate(),-lastSensorRotation)) > 15) {
            if (now - lastTimeSensorMapRotation > 3500) {
              lastTimeSensorMapRotation=now;
              mapView.setRotate(-lastSensorRotation);
            }
          }
        }
      }
      registerUnregisterSensor(location,enableCompass);
      mapView.setLatLon(location.getLatitude(),location.getLongitude());
    }
    RoutingHelper routingHelper=app.getRoutingHelper();
    if (!routingHelper.isFollowingMode() && followingMode) {
      app.runInUIThread(new Runnable(){
        @Override public void run(){
          settings.APPLICATION_MODE.set(settings.DEFAULT_APPLICATION_MODE.get());
        }
      }
);
    }
    followingMode=routingHelper.isFollowingMode();
    if (routePlanningMode != routingHelper.isRoutePlanningMode()) {
      switchToRoutePlanningMode();
    }
    mapView.refreshMap();
  }
}
