{
  MapPoiTypes poiTypes=getMyApplication().getPoiTypes();
  Set<String> excludedPoiAdditionalCategories=new LinkedHashSet<>();
  for (  Entry<PoiCategory,LinkedHashSet<String>> entry : filter.getAcceptedTypes().entrySet()) {
    boolean needTopLevelExclude=false;
    Set<String> excluded=new LinkedHashSet<>();
    if (entry.getValue() != null) {
      for (      String keyName : entry.getValue()) {
        PoiType poiType=poiTypes.getPoiTypeByKey(keyName);
        if (poiType != null) {
          collectExcludedPoiAdditionalCategories(poiType,excluded);
          if (!poiType.isReference()) {
            needTopLevelExclude=true;
            PoiFilter poiFilter=poiType.getFilter();
            if (poiFilter != null) {
              collectExcludedPoiAdditionalCategories(poiFilter,excluded);
            }
            PoiCategory poiCategory=poiType.getCategory();
            if (poiCategory != null) {
              collectExcludedPoiAdditionalCategories(poiCategory,excluded);
            }
          }
        }
      }
    }
 else {
      needTopLevelExclude=true;
    }
    if (excludedPoiAdditionalCategories.size() == 0) {
      excludedPoiAdditionalCategories.addAll(excluded);
    }
 else {
      excludedPoiAdditionalCategories.retainAll(excluded);
    }
    if (needTopLevelExclude && entry.getKey().getExcludedPoiAdditionalCategories() != null) {
      excludedPoiAdditionalCategories.addAll(entry.getKey().getExcludedPoiAdditionalCategories());
    }
  }
  return excludedPoiAdditionalCategories;
}
