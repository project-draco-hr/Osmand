{
  closePreparedStatements(mapBinaryStat,mapLowLevelBinaryStat);
  mapConnection.commit();
  try {
    writer.startWriteMapIndex(regionName);
    writer.writeMapEncodingRules(renderingTypes.getEncodingRuleTypes());
    TLongObjectHashMap<BinaryFileReference> bounds=new TLongObjectHashMap<BinaryFileReference>();
    for (int i=0; i < mapZooms.size(); i++) {
      RTree rtree=mapTree[i];
      long rootIndex=rtree.getFileHdr().getRootIndex();
      rtree.Node root=rtree.getReadNode(rootIndex);
      Rect rootBounds=calcBounds(root);
      if (rootBounds != null) {
        boolean last=nodeIsLastSubTree(rtree,rootIndex);
        writer.startWriteMapLevelIndex(mapZooms.getLevel(i).getMinZoom(),mapZooms.getLevel(i).getMaxZoom(),rootBounds.getMinX(),rootBounds.getMaxX(),rootBounds.getMinY(),rootBounds.getMaxY());
        if (last) {
          BinaryFileReference ref=writer.startMapTreeElement(rootBounds.getMinX(),rootBounds.getMaxX(),rootBounds.getMinY(),rootBounds.getMaxY(),true);
          bounds.put(rootIndex,ref);
        }
        writeBinaryMapTree(root,rtree,writer,bounds);
        if (last) {
          writer.endWriteMapTreeElement();
        }
        writer.endWriteMapLevelIndex();
      }
    }
    PreparedStatement selectData=mapConnection.prepareStatement("SELECT nodes, types, name FROM binary_map_objects WHERE id = ?");
    for (int i=0; i < mapZooms.size(); i++) {
      RTree rtree=mapTree[i];
      long rootIndex=rtree.getFileHdr().getRootIndex();
      rtree.Node root=rtree.getReadNode(rootIndex);
      Rect rootBounds=calcBounds(root);
      if (rootBounds != null) {
        writeBinaryMapBlock(root,rtree,writer,selectData,bounds);
      }
    }
    selectData.close();
    writer.endWriteMapIndex();
    writer.flush();
  }
 catch (  RTreeException e) {
    throw new IllegalStateException(e);
  }
}
