{
  if (OsmandSettings.isUsingInternetToDownloadTiles(getContext())) {
    MapTileDownloader.getInstance().refuseAllPreviousRequests();
  }
  int tileSize=getTileSize();
  float tileX=getXTile();
  float tileY=getYTile();
  float w=getCenterPointX();
  float h=getCenterPointY();
  SurfaceHolder holder=getHolder();
synchronized (holder) {
    Canvas canvas=holder.lockCanvas();
    if (canvas != null) {
      ResourceManager mgr=ResourceManager.getResourceManager();
      boolean useInternet=OsmandSettings.isUsingInternetToDownloadTiles(getContext());
      canvas.save();
      canvas.rotate(rotate,w,h);
      boundsRect.set(0,0,getWidth(),getHeight());
      calculateTileRectangle(boundsRect,w,h,tileX,tileY,tilesRect);
      try {
        int left=(int)FloatMath.floor(tilesRect.left);
        int top=(int)FloatMath.floor(tilesRect.top);
        int width=(int)(FloatMath.ceil(tilesRect.right) - left);
        int height=(int)(FloatMath.ceil(tilesRect.bottom) - top);
        for (int i=0; i < width; i++) {
          for (int j=0; j < height; j++) {
            float x1=(i + left - tileX) * tileSize + w;
            float y1=(j + top - tileY) * tileSize + h;
            Bitmap bmp=mgr.getTileImageForMapAsync(map,left + i,top + j,zoom,useInternet);
            if (bmp == null) {
              drawEmptyTile(canvas,(int)x1,(int)y1);
            }
 else {
              canvas.drawBitmap(bmp,x1,y1,paintBitmap);
            }
          }
        }
        drawOverMap(canvas);
      }
  finally {
        holder.unlockCanvasAndPost(canvas);
      }
    }
  }
}
