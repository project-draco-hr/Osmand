{
  if (location == null) {
    if (sensorRegistered) {
      ((SensorManager)getSystemService(SENSOR_SERVICE)).unregisterListener(this);
      sensorRegistered=false;
      locationLayer.setHeading(null,true);
    }
  }
 else {
    if (!sensorRegistered && OsmandSettings.isShowingViewAngle(this)) {
      SensorManager sensorMgr=(SensorManager)getSystemService(SENSOR_SERVICE);
      Sensor s=sensorMgr.getDefaultSensor(Sensor.TYPE_ORIENTATION);
      if (s != null) {
        sensorMgr.registerListener(this,s,SensorManager.SENSOR_DELAY_UI);
      }
      sensorRegistered=true;
    }
  }
  locationLayer.setLastKnownLocation(location,true);
  if (location != null) {
    if (isMapLinkedToLocation()) {
      if (location.hasBearing() && OsmandSettings.isRotateMapToBearing(this)) {
        mapView.setRotateWithLocation(-location.getBearing(),location.getLatitude(),location.getLongitude());
      }
 else {
        mapView.setLatLon(location.getLatitude(),location.getLongitude());
      }
    }
 else {
      mapView.refreshMap();
      if (backToLocation.getVisibility() != View.VISIBLE) {
        backToLocation.setVisibility(View.VISIBLE);
      }
    }
  }
 else {
    if (backToLocation.getVisibility() != View.INVISIBLE) {
      backToLocation.setVisibility(View.INVISIBLE);
    }
  }
}
