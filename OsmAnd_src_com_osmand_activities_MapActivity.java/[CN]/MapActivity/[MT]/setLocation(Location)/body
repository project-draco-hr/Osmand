{
  if (location == null) {
    if (sensorRegistered) {
      Log.d(LogUtil.TAG,"Disable sensor");
      ((SensorManager)getSystemService(SENSOR_SERVICE)).unregisterListener(this);
      sensorRegistered=false;
      locationLayer.setHeading(null);
    }
  }
 else {
    if (!sensorRegistered && OsmandSettings.isShowingViewAngle(this)) {
      Log.d(LogUtil.TAG,"Enable sensor");
      SensorManager sensorMgr=(SensorManager)getSystemService(SENSOR_SERVICE);
      Sensor s=sensorMgr.getDefaultSensor(Sensor.TYPE_ORIENTATION);
      if (s != null) {
        sensorMgr.registerListener(this,s,SensorManager.SENSOR_DELAY_UI);
      }
      sensorRegistered=true;
    }
  }
  if (!location.hasSpeed() && locationLayer.getLastKnownLocation() != null) {
    float d=location.distanceTo(locationLayer.getLastKnownLocation());
    if (d > 100) {
      d=100;
    }
    location.setSpeed(d);
  }
  if (!location.hasBearing() && locationLayer.getLastKnownLocation() != null) {
    if (locationLayer.getLastKnownLocation().distanceTo(location) > 10) {
      location.setBearing(locationLayer.getLastKnownLocation().bearingTo(location));
    }
  }
  locationLayer.setLastKnownLocation(location);
  routingHelper.setCurrentLocation(location);
  if (location != null) {
    if (isMapLinkedToLocation()) {
      if (OsmandSettings.isAutoZoomEnabled(this) && location.hasSpeed()) {
        int z=defineZoomFromSpeed(location.getSpeed(),mapView.getZoom());
        if (mapView.getZoom() != z) {
          mapView.setZoom(z);
        }
      }
      if (location.hasBearing() && OsmandSettings.isRotateMapToBearing(this)) {
        mapView.setRotate(-location.getBearing());
      }
      mapView.setLatLon(location.getLatitude(),location.getLongitude());
    }
 else {
      if (backToLocation.getVisibility() != View.VISIBLE) {
        backToLocation.setVisibility(View.VISIBLE);
      }
    }
  }
 else {
    if (backToLocation.getVisibility() != View.INVISIBLE) {
      backToLocation.setVisibility(View.INVISIBLE);
    }
  }
}
