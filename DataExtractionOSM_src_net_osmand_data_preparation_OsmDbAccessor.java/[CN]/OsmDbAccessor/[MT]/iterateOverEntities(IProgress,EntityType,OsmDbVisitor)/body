{
  Statement statement=dbConn.createStatement();
  PreparedStatement select;
  int count=0;
  computeRealCounts(statement);
  statement.close();
  BlockingQueue<Entity> toProcess=new ArrayBlockingQueue<Entity>(100000);
  AbstractProducer entityProducer=null;
  if (type == EntityType.NODE) {
    select=iterateNodes;
    count=allNodes;
  }
 else   if (type == EntityType.WAY) {
    select=iterateWays;
    count=allWays;
  }
 else   if (type == EntityType.WAY_BOUNDARY) {
    select=iterateWayBoundaries;
    count=allBoundaries;
  }
 else {
    select=iterateRelations;
    count=allRelations;
  }
  entityProducer=new EntityProducer(toProcess,type,select);
  progress.startWork(count);
  entityProducer.start();
  Entity entityToProcess=null;
  Entity endEntity=entityProducer.getEndingEntity();
  while ((entityToProcess=toProcess.take()) != endEntity) {
    if (progress != null) {
      progress.progress(1);
    }
    visitor.iterateEntity(entityToProcess,this);
  }
  return count;
}
