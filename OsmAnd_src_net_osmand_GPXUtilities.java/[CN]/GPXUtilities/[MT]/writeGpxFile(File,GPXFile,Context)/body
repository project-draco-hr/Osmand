{
  try {
    SimpleDateFormat format=new SimpleDateFormat(GPX_TIME_FORMAT);
    format.setTimeZone(TimeZone.getTimeZone("UTC"));
    FileOutputStream output=new FileOutputStream(fout);
    XmlSerializer serializer=Xml.newSerializer();
    serializer.setOutput(output,"UTF-8");
    serializer.setFeature("http://xmlpull.org/v1/doc/features.html#indent-output",true);
    serializer.startDocument("UTF-8",true);
    serializer.startTag(null,"gpx");
    serializer.attribute(null,"version","1.1");
    serializer.attribute(null,"creator",Version.APP_NAME_VERSION);
    serializer.attribute(null,"xmlns","http://www.topografix.com/GPX/1/1");
    serializer.attribute(null,"xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");
    serializer.attribute(null,"xsi:schemaLocation","http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd");
    for (    Track track : file.tracks) {
      serializer.startTag(null,"trk");
      for (      TrkSegment segment : track.segments) {
        serializer.startTag(null,"trkseg");
        for (        WptPt p : segment.points) {
          serializer.startTag(null,"trkpt");
          writeWpt(format,serializer,p);
          serializer.endTag(null,"trkpt");
        }
        serializer.endTag(null,"trkseg");
      }
      serializer.endTag(null,"trk");
    }
    for (    WptPt l : file.points) {
      serializer.startTag(null,"wpt");
      serializer.attribute(null,"lat",latLonFormat.format(l.lat));
      serializer.attribute(null,"lon",latLonFormat.format(l.lon));
      if (l.time != 0) {
        serializer.startTag(null,"time");
        serializer.text(format.format(new Date(l.time)));
        serializer.endTag(null,"time");
      }
      serializer.startTag(null,"name");
      serializer.text(l.name);
      serializer.endTag(null,"name");
      serializer.endTag(null,"wpt");
    }
    serializer.endTag(null,"gpx");
    serializer.flush();
    serializer.endDocument();
  }
 catch (  RuntimeException e) {
    log.error("Error saving gpx",e);
    return ctx.getString(R.string.error_occurred_saving_gpx);
  }
catch (  IOException e) {
    log.error("Error saving gpx",e);
    return ctx.getString(R.string.error_occurred_saving_gpx);
  }
  return null;
}
