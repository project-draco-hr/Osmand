{
  BinaryMapIndexReader[] files=app.getResourceManager().getRoutingMapFiles();
  BinaryRoutePlanner router=new BinaryRoutePlanner(files);
  RoutingContext ctx=new RoutingContext();
  ctx.setUsingShortestWay(!fast);
  if (mode == ApplicationMode.BICYCLE) {
    ctx.setRouter(new BicycleRouter());
    ctx.setUseStrategyOfIncreasingRoadPriorities(false);
    ctx.setUseDynamicRoadPrioritising(true);
  }
 else   if (mode == ApplicationMode.PEDESTRIAN) {
    ctx.setRouter(new PedestrianRouter());
    ctx.setUseStrategyOfIncreasingRoadPriorities(false);
    ctx.setUseDynamicRoadPrioritising(false);
    ctx.setHeuristicCoefficient(2);
  }
 else {
    ctx.setRouter(new CarRouter());
    ctx.setUseStrategyOfIncreasingRoadPriorities(true);
    ctx.setUseDynamicRoadPrioritising(true);
  }
  RouteSegment st=router.findRouteSegment(start.getLatitude(),start.getLongitude(),ctx);
  if (st == null) {
    return new RouteCalculationResult("Start point is far from allowed road.");
  }
  RouteSegment en=router.findRouteSegment(end.getLatitude(),end.getLongitude(),ctx);
  if (en == null) {
    return new RouteCalculationResult("End point is far from allowed road.");
  }
  List<Location> res=new ArrayList<Location>();
  try {
    List<RouteSegmentResult> result=router.searchRoute(ctx,st,en);
    for (    RouteSegmentResult s : result) {
      boolean plus=s.startPointIndex < s.endPointIndex;
      int i=s.startPointIndex;
      while (true) {
        Location n=new Location("");
        n.setLatitude(MapUtils.get31LatitudeY(s.object.getPoint31YTile(i)));
        n.setLongitude(MapUtils.get31LongitudeX(s.object.getPoint31XTile(i)));
        res.add(n);
        if (i == s.endPointIndex) {
          break;
        }
        if (plus) {
          i++;
        }
 else {
          i--;
        }
      }
    }
    return new RouteCalculationResult(res,null,start,end,null);
  }
 catch (  OutOfMemoryError e) {
    return new RouteCalculationResult("No enough memory to calculate route.");
  }
}
