{
  String deviceKey=app.getSettings().OSMO_DEVICE_KEY.get();
  HttpClient httpclient=new DefaultHttpClient();
  HttpPost httppost=new HttpPost("http://api.osmo.mobi/prepare");
  try {
    List<NameValuePair> nameValuePairs=new ArrayList<NameValuePair>(2);
    nameValuePairs.add(new BasicNameValuePair("key",deviceKey));
    nameValuePairs.add(new BasicNameValuePair("protocol","1"));
    httppost.setEntity(new UrlEncodedFormEntity(nameValuePairs));
    HttpResponse response=httpclient.execute(httppost);
    InputStream cm=response.getEntity().getContent();
    BufferedReader reader=new BufferedReader(new InputStreamReader(cm));
    String r=reader.readLine();
    reader.close();
    log.info("Authorization key : " + r);
    final JSONObject obj=new JSONObject(r);
    if (obj.has("error")) {
      throw new RuntimeException(obj.getString("error"));
    }
    if (!obj.has("port")) {
      throw new RuntimeException("Port not specified");
    }
    if (!obj.has("address")) {
      throw new RuntimeException("Host name not specified");
    }
    if (!obj.has("token")) {
      throw new RuntimeException("Token not specified");
    }
    SessionInfo si=new SessionInfo();
    String a=obj.getString("address");
    int i=a.indexOf(':');
    si.hostName=a.substring(0,i);
    si.port=a.substring(i + 1);
    si.token=obj.getString("token");
    return si;
  }
 catch (  ClientProtocolException e) {
    throw new IOException(e);
  }
catch (  IOException e) {
    throw e;
  }
catch (  JSONException e) {
    throw new IOException(e);
  }
}
