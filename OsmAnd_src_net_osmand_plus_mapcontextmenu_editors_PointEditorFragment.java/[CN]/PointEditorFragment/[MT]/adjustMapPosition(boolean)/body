{
  OsmandMapTileView map=getMapActivity().getMapView();
  MapContextMenu menu=getMapActivity().getContextMenu();
  double markerLat=menu.getLatLon().getLatitude();
  double markerLon=menu.getLatLon().getLongitude();
  RotatedTileBox box=map.getCurrentRotatedTileBox();
  int origMarkerY=(int)box.getPixYFromLatLon(markerLat,markerLon);
  int markerPaddingPx=AndroidUtils.dpToPx(getMapActivity(),MapContextMenuFragment.MARKER_PADDING_DP);
  int y=view.getHeight() - mainViewHeight;
  if (!menu.isLandscapeLayout()) {
    int markerY=(int)box.getPixYFromLatLon(markerLat,markerLon);
    if (markerY + markerPaddingPx > y || markerY < origMarkerY) {
      int dy=markerY - (y - markerPaddingPx);
      if (markerY - dy <= origMarkerY) {
        QuadPoint cp=box.getCenterPixelPoint();
        LatLon latlon=box.getLatLonFromPixel(cp.x + 0,cp.y + dy);
        double destLat=latlon.getLatitude();
        double destLon=latlon.getLongitude();
        if (animated) {
          AnimateDraggingMapThread thread=map.getAnimatedDraggingThread();
          int fZoom=map.getZoom();
          double flat=destLat;
          double flon=destLon;
          RotatedTileBox cbox=map.getCurrentRotatedTileBox().copy();
          cbox.setCenterLocation(0.5f,0.5f);
          cbox.setLatLonCenter(flat,flon);
          flat=cbox.getLatFromPixel(cbox.getPixWidth() / 2,cbox.getPixHeight() / 2);
          flon=cbox.getLonFromPixel(cbox.getPixWidth() / 2,cbox.getPixHeight() / 2);
          thread.startMoving(flat,flon,fZoom,true);
        }
 else {
          map.setLatLon(destLat,destLon);
        }
      }
    }
  }
}
