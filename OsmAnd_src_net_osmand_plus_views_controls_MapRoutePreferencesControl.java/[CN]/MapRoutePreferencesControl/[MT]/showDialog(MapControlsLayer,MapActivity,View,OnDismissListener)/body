{
  final boolean switched=controlsLayer.switchToRoutePlanningLayout();
  final RoutePrepareDialog dialog=new RoutePrepareDialog(mapActivity);
  WindowManager.LayoutParams lp=new WindowManager.LayoutParams();
  final int maxHeight;
  boolean portrait=AndroidUiHelper.isOrientationPortrait(mapActivity);
  if (portrait) {
    maxHeight=(int)mapActivity.getResources().getDimension(R.dimen.map_route_planning_max_height);
    lp.width=WindowManager.LayoutParams.MATCH_PARENT;
    lp.height=WindowManager.LayoutParams.WRAP_CONTENT;
    lp.gravity=Gravity.BOTTOM;
  }
 else {
    maxHeight=-1;
    lp.height=WindowManager.LayoutParams.MATCH_PARENT;
    lp.width=(int)mapActivity.getResources().getDimension(R.dimen.map_route_planning_land_width);
    lp.gravity=Gravity.LEFT;
  }
  dialog.getContext().setTheme(R.style.Dialog_Fullscreen);
  dialog.getWindow().clearFlags(WindowManager.LayoutParams.FLAG_DIM_BEHIND);
  dialog.getWindow().requestFeature(Window.FEATURE_NO_TITLE);
  dialog.setContentView(ll,new LayoutParams(WindowManager.LayoutParams.MATCH_PARENT,portrait ? WindowManager.LayoutParams.WRAP_CONTENT : WindowManager.LayoutParams.MATCH_PARENT));
  dialog.setCanceledOnTouchOutside(true);
  dialog.getWindow().setAttributes(lp);
  if (maxHeight != -1) {
    ll.getViewTreeObserver().addOnGlobalLayoutListener(new OnGlobalLayoutListener(){
      boolean wrap=true;
      @Override public void onGlobalLayout(){
        if (ll.getHeight() > maxHeight) {
          dialog.setContentView(ll,new LayoutParams(WindowManager.LayoutParams.MATCH_PARENT,maxHeight));
          wrap=false;
        }
 else         if (ll.getHeight() < maxHeight && !wrap) {
          dialog.setContentView(ll,new LayoutParams(WindowManager.LayoutParams.MATCH_PARENT,ll.getHeight()));
          wrap=true;
        }
      }
    }
);
  }
  if (!portrait) {
    mapActivity.getMapView().setMapPositionX(1);
    mapActivity.getMapView().refreshMap();
  }
  dialog.show();
  if (!AndroidUiHelper.isXLargeDevice(mapActivity)) {
    AndroidUiHelper.updateVisibility(mapActivity.findViewById(R.id.map_right_widgets_panel),false);
    AndroidUiHelper.updateVisibility(mapActivity.findViewById(R.id.map_left_widgets_panel),false);
  }
  if (!portrait) {
    AndroidUiHelper.updateVisibility(mapActivity.findViewById(R.id.map_route_land_left_margin),true);
  }
  OnDismissListener dismissList=new OnDismissListener(){
    @Override public void onDismiss(    DialogInterface dlg){
      mapActivity.getMapView().setMapPositionX(0);
      mapActivity.getMapView().refreshMap();
      AndroidUiHelper.updateVisibility(mapActivity.findViewById(R.id.map_route_land_left_margin),false);
      AndroidUiHelper.updateVisibility(mapActivity.findViewById(R.id.map_right_widgets_panel),true);
      AndroidUiHelper.updateVisibility(mapActivity.findViewById(R.id.map_left_widgets_panel),true);
      if (switched) {
        controlsLayer.switchToRouteFollowingLayout();
      }
      if (dismiss != null) {
        dismiss.onDismiss(dialog);
      }
    }
  }
;
  dialog.setOnDismissListener(dismissList);
  return dialog;
}
