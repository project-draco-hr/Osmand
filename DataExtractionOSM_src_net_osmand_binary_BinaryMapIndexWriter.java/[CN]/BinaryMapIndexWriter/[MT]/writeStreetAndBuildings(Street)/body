{
  checkPeekState(CITY_INDEX_INIT,POSTCODES_INDEX_INIT);
  StreetIndex.Builder streetBuilder=OsmandOdb.StreetIndex.newBuilder();
  streetBuilder.setName(street.getName());
  if (street.getEnName() != null) {
    streetBuilder.setNameEn(street.getEnName());
  }
  streetBuilder.setId(street.getId());
  LatLon location=cityOrPostcode.getLocation();
  int cx=MapUtils.get31TileNumberX(location.getLongitude());
  int cy=MapUtils.get31TileNumberY(location.getLatitude());
  int sx=MapUtils.get31TileNumberX(street.getLocation().getLongitude());
  int sy=MapUtils.get31TileNumberY(street.getLocation().getLatitude());
  streetBuilder.setX((sx - cx) >> 7);
  streetBuilder.setY((sy - cy) >> 7);
  for (  Building b : street.getBuildings()) {
    OsmandOdb.BuildingIndex.Builder bbuilder=OsmandOdb.BuildingIndex.newBuilder();
    int bx=MapUtils.get31TileNumberX(b.getLocation().getLongitude());
    int by=MapUtils.get31TileNumberY(b.getLocation().getLatitude());
    bbuilder.setX((bx - sx) >> 7);
    bbuilder.setY((by - sy) >> 7);
    bbuilder.setId(b.getId());
    bbuilder.setName(b.getName());
    if (b.getEnName() != null) {
      bbuilder.setNameEn(b.getEnName());
    }
    streetBuilder.addBuildings(bbuilder.build());
  }
  if (state.peek() == CITY_INDEX_INIT) {
    codedOutStream.writeMessage(OsmandOdb.CityIndex.STREETS_FIELD_NUMBER,streetBuilder.build());
  }
 else {
    throw new UnsupportedOperationException();
  }
}
