{
  checkPeekState(POI_INDEX_INIT);
  codedOutStream.writeTag(OsmandOdb.OsmAndPoiIndex.NAMEINDEX_FIELD_NUMBER,WireFormat.WIRETYPE_FIXED32_LENGTH_DELIMITED);
  preserveInt32Size();
  Map<String,MessageLite> message=new LinkedHashMap<String,MessageLite>();
  Map<String,Integer> indexedTable=new LinkedHashMap<String,Integer>();
  Map<PoiTileBox,TLongList> fpToWriteSeeks=new LinkedHashMap<PoiTileBox,TLongList>();
  int previousSize=0;
  for (  Map.Entry<String,Set<PoiTileBox>> e : namesIndex.entrySet()) {
    OsmandOdb.OsmAndPoiNameIndexData.Builder builder=OsmandOdb.OsmAndPoiNameIndexData.newBuilder();
    List<PoiTileBox> tileBoxes=new ArrayList<PoiTileBox>(e.getValue());
    for (    PoiTileBox box : tileBoxes) {
      OsmandOdb.OsmAndPoiNameIndexDataAtom.Builder bs=OsmandOdb.OsmAndPoiNameIndexDataAtom.newBuilder();
      bs.setX(box.getX());
      bs.setY(box.getY());
      bs.setZoom(box.getZoom());
      bs.setShiftTo(0);
      OsmAndPoiNameIndexDataAtom atom=bs.build();
      builder.addAtoms(atom);
    }
    OsmAndPoiNameIndexData msg=builder.build();
    message.put(e.getKey(),msg);
    indexedTable.put(e.getKey(),previousSize);
    previousSize+=CodedOutputStream.computeMessageSize(OsmandOdb.OsmAndPoiNameIndex.DATA_FIELD_NUMBER,msg);
    int accumulateSize=4;
    for (int i=tileBoxes.size() - 1; i >= 0; i--) {
      PoiTileBox box=tileBoxes.get(i);
      if (!fpToWriteSeeks.containsKey(box)) {
        fpToWriteSeeks.put(box,new TLongArrayList());
      }
      fpToWriteSeeks.get(box).add(previousSize - accumulateSize);
      accumulateSize+=CodedOutputStream.computeMessageSize(OsmandOdb.OsmAndPoiNameIndexData.ATOMS_FIELD_NUMBER,msg.getAtoms(i));
    }
  }
  writeIndexedTable(OsmandOdb.OsmAndPoiNameIndex.TABLE_FIELD_NUMBER,indexedTable);
  codedOutStream.flush();
  long l=raf.getFilePointer();
  for (  TLongList es : fpToWriteSeeks.values()) {
    for (int i=0; i < es.size(); i++) {
      es.set(i,es.get(i) + l);
    }
  }
  for (  Map.Entry<String,MessageLite> s : message.entrySet()) {
    codedOutStream.writeMessage(OsmandOdb.OsmAndPoiNameIndex.DATA_FIELD_NUMBER,s.getValue());
  }
  writeInt32Size();
  return fpToWriteSeeks;
}
