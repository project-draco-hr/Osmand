{
  String langId=app.getSettings().MAP_PREFERRED_LOCALE.get();
  LanguagePreference langPref=LanguagePreference.LocalizedOrNative;
  String rendName=app.getSettings().RENDERER.get();
  if (rendName.length() == 0 || rendName.equals(RendererRegistry.DEFAULT_RENDER)) {
    rendName="default";
  }
  if (!mapStyles.containsKey(rendName)) {
    mapStyles.put(rendName,mapStylesCollection.getResolvedStyleByName(rendName));
  }
  ResolvedMapStyle mapStyle=mapStyles.get(rendName);
  CachedMapPresentation pres=new CachedMapPresentation(langId,langPref,mapStyle,displayDensityFactor);
  if (this.presentationObjectParams == null || !this.presentationObjectParams.equalsFields(pres)) {
    this.presentationObjectParams=pres;
    mapPresentationEnvironment=new MapPresentationEnvironment(mapStyle,displayDensityFactor,langId,langPref);
  }
  OsmandSettings prefs=app.getSettings();
  RenderingRulesStorage storage=app.getRendererRegistry().getCurrentSelectedRenderer();
  Map<String,String> props=new HashMap<String,String>();
  for (  RenderingRuleProperty customProp : storage.PROPS.getCustomRules()) {
    if (customProp.isBoolean()) {
      CommonPreference<Boolean> pref=prefs.getCustomRenderBooleanProperty(customProp.getAttrName());
      props.put(customProp.getAttrName(),pref.get() + "");
    }
 else {
      CommonPreference<String> settings=prefs.getCustomRenderProperty(customProp.getAttrName());
      String res=settings.get();
      if (!Algorithms.isEmpty(res)) {
        props.put(customProp.getAttrName(),res);
      }
    }
  }
  QStringStringHash convertedStyleSettings=new QStringStringHash();
  for (Iterator<Map.Entry<String,String>> itSetting=props.entrySet().iterator(); itSetting.hasNext(); ) {
    Map.Entry<String,String> setting=itSetting.next();
    convertedStyleSettings.set(setting.getKey(),setting.getValue());
  }
  if (nightMode) {
    convertedStyleSettings.set("nightMode","true");
  }
  mapPresentationEnvironment.setSettings(convertedStyleSettings);
  if (mapPrimitiviser != null) {
    updateMapPrimitiviser();
  }
}
