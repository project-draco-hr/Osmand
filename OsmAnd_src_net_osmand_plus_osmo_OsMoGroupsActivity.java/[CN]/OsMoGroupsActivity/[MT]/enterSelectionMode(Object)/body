{
  if (!checkOperationIsNotRunning()) {
    return;
  }
  actionMode=startSupportActionMode(new ActionMode.Callback(){
    private OsMoDevice device;
    private OsMoGroup group;
    private Menu menu;
    @Override public boolean onCreateActionMode(    ActionMode mode,    Menu menu){
      selectedObject=o;
      boolean portrait=ScreenOrientationHelper.isOrientationPortrait(OsMoGroupsActivity.this);
      if (portrait) {
        menu=getClearToolbar(true).getMenu();
      }
 else {
        getClearToolbar(false);
      }
      this.menu=menu;
      device=(OsMoDevice)(o instanceof OsMoDevice ? o : null);
      group=(OsMoGroup)(o instanceof OsMoGroup ? o : null);
      MenuItem mi=null;
      if (device != null) {
        mi=createMenuItem(menu,ON_OFF_ACTION_ID,R.string.shared_string_ok,0,0,MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
      }
      if (device != null && device.getLastLocation() != null) {
        createMenuItem(menu,SHOW_ON_MAP_ID,R.string.shared_string_show_on_map,R.drawable.ic_action_marker_dark,MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
      }
      createMenuItem(menu,SHARE_ID,R.string.shared_string_share,R.drawable.ic_action_gshare_dark,device != null && device.getLastLocation() != null ? MenuItemCompat.SHOW_AS_ACTION_NEVER : MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
      if (device != null) {
        createMenuItem(menu,SETTINGS_DEV_ID,R.string.shared_string_settings,R.drawable.ic_action_settings_enabled_dark,device.getLastLocation() != null ? MenuItemCompat.SHOW_AS_ACTION_NEVER : MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
      }
      if (device != null && device.getLastLocation() != null) {
        MenuItem menuItem=createMenuItem(menu,TRACK_DEV_ID,R.string.osmo_set_moving_target,R.drawable.ic_action_flage_dark,device.getLastLocation() != null ? MenuItemCompat.SHOW_AS_ACTION_NEVER : MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
        menuItem.setTitleCondensed(getString(R.string.osmo_follow));
      }
      if (group != null) {
        createMenuItem(menu,GROUP_INFO,R.string.osmo_group_info,R.drawable.ic_action_info_dark,MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
      }
      if ((group != null && !group.isMainGroup()) || (device != null && device.getGroup().isMainGroup())) {
        createMenuItem(menu,DELETE_ACTION_ID,R.string.shared_string_delete,R.drawable.ic_action_delete_dark,MenuItemCompat.SHOW_AS_ACTION_ALWAYS);
      }
      if (mi != null) {
        final LayoutInflater inflater=LayoutInflater.from(OsMoGroupsActivity.this);
        View view=inflater.inflate(R.layout.check_item_rel,null);
        final CompoundButton check=(CompoundButton)view.findViewById(R.id.check_item);
        check.setChecked((device != null && device.isActive() && device.isEnabled()) || (group != null && group.isActive() && group.isEnabled()));
        check.setOnCheckedChangeListener(new OnCheckedChangeListener(){
          @Override public void onCheckedChanged(          CompoundButton buttonView,          boolean isChecked){
            onOffAction(check);
          }
        }
);
        MenuItemCompat.setActionView(mi,view);
      }
      return true;
    }
    @Override public boolean onPrepareActionMode(    ActionMode mode,    Menu menu){
      return false;
    }
    @Override public void onDestroyActionMode(    ActionMode mode){
      selectedObject=null;
      refreshList();
      if (ScreenOrientationHelper.isOrientationPortrait(OsMoGroupsActivity.this)) {
        onCreateOptionsMenu(menu);
      }
    }
    @Override public boolean onActionItemClicked(    ActionMode mode,    MenuItem item){
      if (item.getItemId() == TRACK_DEV_ID) {
        if (device != null) {
          OsMoPositionLayer.setFollowDestination(device);
          MapActivity.launchMapActivityMoveToTop(OsMoGroupsActivity.this);
        }
      }
 else       if (item.getItemId() == SETTINGS_DEV_ID) {
        showSettingsDialog(device);
      }
 else       if (item.getItemId() == DELETE_ACTION_ID) {
        Builder bld=new AlertDialog.Builder(OsMoGroupsActivity.this);
        String name=(selectedObject instanceof OsMoDevice) ? ((OsMoDevice)selectedObject).getVisibleName() : ((OsMoGroup)selectedObject).getVisibleName(OsMoGroupsActivity.this);
        bld.setTitle(getString(selectedObject instanceof OsMoDevice ? R.string.delete_confirmation_msg : R.string.osmo_leave_confirmation_msg,name));
        bld.setPositiveButton(R.string.shared_string_yes,new DialogInterface.OnClickListener(){
          @Override public void onClick(          DialogInterface dialog,          int which){
            Object obj=selectedObject;
            quitSelectionMode();
            deleteObject(obj);
          }
        }
);
        bld.setNegativeButton(R.string.shared_string_no,null);
        bld.show();
      }
 else       if (item.getItemId() == GROUP_INFO) {
        showGroupInfo(group);
      }
 else       if (item.getItemId() == SHARE_ID) {
        if (device != null) {
          shareTrackerId(device.getVisibleName(),device.getTrackerId());
        }
 else {
          shareOsMoGroup(group.getVisibleName(app),group.getGroupId());
        }
      }
 else       if (item.getItemId() == SHOW_ON_MAP_ID) {
        if (device != null) {
          Location location=device.getLastLocation();
          MapActivity.getSingleMapViewTrackingUtilities().setMapLinkedToLocation(false);
          if (location != null) {
            app.getSettings().setMapLocationToShow(location.getLatitude(),location.getLongitude(),app.getSettings().getLastKnownMapZoom(),new PointDescription(PointDescription.POINT_TYPE_MARKER,device.getVisibleName()),false,device);
          }
          OsMoPositionLayer.setFollowTrackerId(device);
          MapActivity.launchMapActivityMoveToTop(OsMoGroupsActivity.this);
        }
      }
 else       if (item.getItemId() == ON_OFF_ACTION_ID) {
        CompoundButton bt=((CompoundButton)MenuItemCompat.getActionView(item).findViewById(R.id.check_item));
        onOffAction(bt);
      }
      return true;
    }
    private void onOffAction(    CompoundButton bt){
      if ((selectedObject instanceof OsMoDevice)) {
        OsMoDevice d=(OsMoDevice)selectedObject;
        if (bt.isChecked()) {
          osMoPlugin.getGroups().connectDevice(d);
        }
 else {
          osMoPlugin.getGroups().disconnectDevice(d);
        }
      }
 else {
        OsMoGroup g=(OsMoGroup)selectedObject;
        if (bt.isChecked()) {
          String operation=osMoPlugin.getGroups().connectGroup(g);
          startLongRunningOperation(operation);
        }
 else {
          String operation=osMoPlugin.getGroups().disconnectGroup(g);
          startLongRunningOperation(operation);
        }
      }
      quitSelectionMode();
    }
  }
);
  refreshList();
}
