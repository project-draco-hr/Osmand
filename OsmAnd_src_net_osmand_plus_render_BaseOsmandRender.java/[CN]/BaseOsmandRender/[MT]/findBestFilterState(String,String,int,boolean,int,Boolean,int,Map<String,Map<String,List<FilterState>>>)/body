{
  if (mapTag != null) {
    Map<String,List<FilterState>> map=mapTag.get(tag);
    if (map != null) {
      List<FilterState> list=map.get(val);
      if (list != null) {
        FilterState bestResult=null;
        boolean prevDayNightMatches=false;
        boolean prevLayerMatches=false;
        int sz=list.size();
        for (int i=0; i < sz; i++) {
          FilterState f=list.get(i);
          if (f.minzoom <= zoom && (zoom <= f.maxzoom || f.maxzoom == -1)) {
            if (ref != null && !checkRefTextRule(f,ref.booleanValue())) {
              continue;
            }
            if (f.textLength != nameLength) {
              continue;
            }
            boolean dayNightMatches=(f.nightMode != null && f.nightMode.booleanValue() == nightMode) || (!nightMode && f.nightMode == null);
            boolean layerMatches=f.layer == layer;
            boolean defLayerMatches=f.layer == 0;
            if (dayNightMatches || !prevDayNightMatches) {
              if (dayNightMatches && !prevDayNightMatches) {
                if (layerMatches || defLayerMatches) {
                  prevDayNightMatches=true;
                  prevLayerMatches=false;
                }
              }
              if (layerMatches) {
                prevLayerMatches=true;
                bestResult=f;
              }
 else               if (defLayerMatches && !prevLayerMatches) {
                bestResult=f;
              }
            }
          }
        }
        return bestResult;
      }
    }
  }
  return null;
}
