{
  final ITileSource mapSource=mapView.getMap();
  if (mapSource == null || !mapSource.couldBeDownloadedFromInternet()) {
    Toast.makeText(ctx,R.string.maps_could_not_be_downloaded,Toast.LENGTH_SHORT).show();
    return;
  }
  final int max=mapSource.getMaximumZoomSupported();
  final int zoom=mapView.getZoom();
  Rect boundsRect=new Rect(0,0,mapView.getWidth(),mapView.getHeight());
  float tileX=(float)MapUtils.getTileNumberX(zoom,mapView.getLongitude());
  float tileY=(float)MapUtils.getTileNumberY(zoom,mapView.getLatitude());
  float w=mapView.getCenterPointX();
  float h=mapView.getCenterPointY();
  RectF tilesRect=new RectF();
  final RectF latlonRect=new RectF();
  mapView.calculateTileRectangle(boundsRect,w,h,tileX,tileY,tilesRect);
  latlonRect.top=(float)MapUtils.getLatitudeFromTile(zoom,tilesRect.top);
  latlonRect.left=(float)MapUtils.getLongitudeFromTile(zoom,tilesRect.left);
  latlonRect.bottom=(float)MapUtils.getLatitudeFromTile(zoom,tilesRect.bottom);
  latlonRect.right=(float)MapUtils.getLongitudeFromTile(zoom,tilesRect.right);
  Builder builder=new AlertDialog.Builder(ctx);
  LayoutInflater inflater=(LayoutInflater)ctx.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
  View view=inflater.inflate(R.layout.download_tiles,null);
  ((TextView)view.findViewById(R.id.MinZoom)).setText(zoom + "");
  ((TextView)view.findViewById(R.id.MaxZoom)).setText(max + "");
  final SeekBar seekBar=(SeekBar)view.findViewById(R.id.ZoomToDownload);
  seekBar.setMax(max - zoom);
  seekBar.setProgress((max - zoom) / 2);
  final TextView downloadText=((TextView)view.findViewById(R.id.DownloadDescription));
  final String template=ctx.getString(R.string.tiles_to_download_estimated_size);
  updateLabel(zoom,latlonRect,downloadText,template,seekBar.getProgress());
  seekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener(){
    @Override public void onProgressChanged(    SeekBar seekBar,    int progress,    boolean fromUser){
      updateLabel(zoom,latlonRect,downloadText,template,progress);
    }
    @Override public void onStartTrackingTouch(    SeekBar seekBar){
    }
    @Override public void onStopTrackingTouch(    SeekBar seekBar){
    }
  }
);
  builder.setPositiveButton(R.string.download_files,new DialogInterface.OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      dialog.dismiss();
      run(zoom,seekBar.getProgress(),latlonRect,mapSource);
    }
  }
);
  builder.setNegativeButton(R.string.default_buttons_cancel,null);
  builder.setView(view);
  builder.show();
}
