{
  interrupted=false;
  if (currentRenderingContext != null) {
    currentRenderingContext=null;
  }
  try {
    OsmandApplication app=((OsmandApplication)context.getApplicationContext());
    Boolean renderDay=app.getDaynightHelper().getDayNightRenderer();
    boolean nightMode=renderDay != null && !renderDay.booleanValue();
    RenderingRulesStorage storage=app.getRendererRegistry().getCurrentSelectedRenderer();
    RenderingRuleSearchRequest renderingReq=new RenderingRuleSearchRequest(storage);
    renderingReq.setBooleanFilter(renderingReq.ALL.R_NIGHT_MODE,nightMode);
    for (    RenderingRuleProperty customProp : storage.PROPS.getCustomRules()) {
      if (customProp.isBoolean()) {
        CommonPreference<Boolean> pref=prefs.getCustomRenderBooleanProperty(customProp.getAttrName());
        renderingReq.setBooleanFilter(customProp,pref.get());
      }
 else {
        CommonPreference<String> settings=prefs.getCustomRenderProperty(customProp.getAttrName());
        String res=settings.get();
        if (!Algoritms.isEmpty(res)) {
          if (customProp.isString()) {
            renderingReq.setStringFilter(customProp,res);
          }
 else           if (customProp.isBoolean()) {
            renderingReq.setBooleanFilter(customProp,"true".equalsIgnoreCase(res));
          }
 else {
            try {
              renderingReq.setIntFilter(customProp,Integer.parseInt(res));
            }
 catch (            NumberFormatException e) {
              e.printStackTrace();
            }
          }
        }
      }
    }
    renderingReq.saveState();
    NativeOsmandLibrary nativeLib=prefs.NATIVE_RENDERING.get() ? NativeOsmandLibrary.getLibrary(storage) : null;
    requestedBox=new RotatedTileBox(tileRect);
    RectF dataBox=requestedBox.calculateLatLonBox(new RectF());
    long now=System.currentTimeMillis();
    if (cObjectsBox.left > dataBox.left || cObjectsBox.top > dataBox.top || cObjectsBox.right < dataBox.right || cObjectsBox.bottom < dataBox.bottom || (nativeLib != null) == (cNativeObjects == null)) {
      if ((dataBox.right - dataBox.left) > (dataBox.top - dataBox.bottom)) {
        double wi=(dataBox.right - dataBox.left) * .2;
        dataBox.left-=wi;
        dataBox.right+=wi;
      }
 else {
        double hi=(dataBox.top - dataBox.bottom) * .2;
        dataBox.top+=hi;
        dataBox.bottom-=hi;
      }
      validateLatLonBox(dataBox);
      boolean loaded;
      if (nativeLib != null) {
        cObjects=new LinkedList<BinaryMapDataObject>();
        loaded=loadVectorDataNative(dataBox,requestedBox.getIntZoom(),renderingReq,nativeLib);
      }
 else {
        cNativeObjects=null;
        loaded=loadVectorData(dataBox,requestedBox.getIntZoom(),renderingReq);
      }
      if (!loaded || checkWhetherInterrupted()) {
        return;
      }
    }
    final long searchTime=System.currentTimeMillis() - now;
    currentRenderingContext=new OsmandRenderer.RenderingContext(context);
    renderingReq.clearState();
    renderingReq.setIntFilter(renderingReq.ALL.R_MINZOOM,requestedBox.getIntZoom());
    if (renderingReq.searchRenderingAttribute(RenderingRuleStorageProperties.A_DEFAULT_COLOR)) {
      currentRenderingContext.defaultColor=renderingReq.getIntPropertyValue(renderingReq.ALL.R_ATTR_COLOR_VALUE);
    }
    renderingReq.clearState();
    renderingReq.setIntFilter(renderingReq.ALL.R_MINZOOM,requestedBox.getIntZoom());
    if (renderingReq.searchRenderingAttribute(RenderingRuleStorageProperties.A_SHADOW_RENDERING)) {
      currentRenderingContext.shadowRenderingMode=renderingReq.getIntPropertyValue(renderingReq.ALL.R_ATTR_INT_VALUE);
      currentRenderingContext.shadowRenderingColor=renderingReq.getIntPropertyValue(renderingReq.ALL.R_SHADOW_COLOR);
    }
    currentRenderingContext.leftX=requestedBox.getLeftTileX();
    currentRenderingContext.topY=requestedBox.getTopTileY();
    currentRenderingContext.zoom=requestedBox.getIntZoom();
    currentRenderingContext.rotate=requestedBox.getRotate();
    currentRenderingContext.width=(int)(requestedBox.getTileWidth() * OsmandRenderer.TILE_SIZE);
    currentRenderingContext.height=(int)(requestedBox.getTileHeight() * OsmandRenderer.TILE_SIZE);
    currentRenderingContext.nightMode=nightMode;
    currentRenderingContext.useEnglishNames=prefs.USE_ENGLISH_NAMES.get();
    currentRenderingContext.setDensityValue(prefs.USE_HIGH_RES_MAPS.get(),prefs.MAP_TEXT_SIZE.get(),renderer.getDensity());
    currentRenderingContext.tileDivisor=(float)MapUtils.getPowZoom(31 - requestedBox.getZoom());
    if (checkWhetherInterrupted()) {
      return;
    }
    now=System.currentTimeMillis();
    Bitmap bmp;
    boolean transparent=false;
    RenderingRuleProperty rr=storage.PROPS.get("noPolygons");
    if (rr != null) {
      transparent=renderingReq.getIntPropertyValue(rr) > 0;
    }
    Bitmap reuse=prevBmp;
    this.prevBmp=this.bmp;
    this.prevBmpLocation=this.bmpLocation;
    if (reuse != null && reuse.getWidth() == currentRenderingContext.width && reuse.getHeight() == currentRenderingContext.height) {
      bmp=reuse;
      bmp.eraseColor(currentRenderingContext.defaultColor);
    }
 else {
      if (reuse != null) {
        log.error(String.format("Create new image ? %d != %d (w) %d != %d (h) ",currentRenderingContext.width,reuse.getWidth(),currentRenderingContext.height,reuse.getHeight()));
      }
      bmp=Bitmap.createBitmap(currentRenderingContext.width,currentRenderingContext.height,Config.RGB_565);
    }
    this.bmp=bmp;
    this.bmpLocation=tileRect;
    if (nativeLib != null) {
      renderer.generateNewBitmapNative(currentRenderingContext,nativeLib,cNativeObjects,bmp,renderingReq,notifyList);
    }
 else {
      renderer.generateNewBitmap(currentRenderingContext,cObjects,bmp,renderingReq,notifyList);
    }
    if (renderingReq != null) {
      log.info("Debug :" + renderingReq != null);
    }
    String renderingDebugInfo=currentRenderingContext.renderingDebugInfo;
    currentRenderingContext.ended=true;
    if (checkWhetherInterrupted()) {
      if (currentRenderingContext.lastRenderedKey < 35) {
        reuse=this.bmp;
        this.bmp=this.prevBmp;
        this.bmpLocation=this.prevBmpLocation;
        this.prevBmp=reuse;
        this.prevBmpLocation=null;
      }
      currentRenderingContext=null;
      return;
    }
    currentRenderingContext=null;
    this.prevBmpLocation=null;
    if (prefs.DEBUG_RENDERING_INFO.get()) {
      String timeInfo="Searching: " + searchTime + " ms";
      if (renderingDebugInfo != null) {
        timeInfo+="\n" + renderingDebugInfo;
      }
      final String msg=timeInfo;
      log.info(msg);
      handler.post(new Runnable(){
        @Override public void run(){
          AccessibleToast.makeText(context,msg,Toast.LENGTH_LONG).show();
        }
      }
);
    }
  }
 catch (  RuntimeException e) {
    log.error("Runtime memory exception",e);
    handler.post(new Runnable(){
      @Override public void run(){
        AccessibleToast.makeText(context,R.string.rendering_exception,Toast.LENGTH_SHORT).show();
      }
    }
);
  }
catch (  OutOfMemoryError e) {
    log.error("Out of memory error",e);
    cObjects=new ArrayList<BinaryMapDataObject>();
    cObjectsBox=new RectF();
    handler.post(new Runnable(){
      @Override public void run(){
        ActivityManager activityManager=(ActivityManager)context.getSystemService(Context.ACTIVITY_SERVICE);
        ActivityManager.MemoryInfo memoryInfo=new ActivityManager.MemoryInfo();
        activityManager.getMemoryInfo(memoryInfo);
        AccessibleToast.makeText(context,context.getString(R.string.rendering_out_of_memory) + " (" + memoryInfo.availMem / 1048576L + " MB available) ",Toast.LENGTH_SHORT).show();
      }
    }
);
  }
 finally {
    if (currentRenderingContext != null) {
      currentRenderingContext.ended=true;
    }
  }
}
