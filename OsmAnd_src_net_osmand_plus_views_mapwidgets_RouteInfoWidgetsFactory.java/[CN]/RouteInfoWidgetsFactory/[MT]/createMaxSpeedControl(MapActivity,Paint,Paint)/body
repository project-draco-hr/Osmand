{
  final RoutingHelper rh=map.getMyApplication().getRoutingHelper();
  final OsmAndLocationProvider locationProvider=map.getMyApplication().getLocationProvider();
  final MapViewTrackingUtilities trackingUtilities=map.getMapViewTrackingUtilities();
  final TextInfoWidget speedControl=new TextInfoWidget(map,3,paintText,paintSubText){
    private float cachedSpeed=0;
    @Override public boolean updateInfo(){
      float mx=0;
      if ((rh == null || !rh.isFollowingMode()) && trackingUtilities.isMapLinkedToLocation()) {
        RouteDataObject ro=locationProvider.getLastKnownRouteSegment();
        if (ro != null) {
          mx=ro.getMaximumSpeed();
        }
      }
 else {
        mx=rh.getCurrentMaxSpeed();
      }
      if (cachedSpeed != mx) {
        cachedSpeed=mx;
        if (cachedSpeed == 0) {
          setText(null,null);
        }
 else         if (cachedSpeed == RouteDataObject.NONE_MAX_SPEED) {
          setText(map.getString(R.string.max_speed_none),"");
        }
 else {
          String ds=OsmAndFormatter.getFormattedSpeed(cachedSpeed,map.getMyApplication());
          int ls=ds.lastIndexOf(' ');
          if (ls == -1) {
            setText(ds,null);
          }
 else {
            setText(ds.substring(0,ls),ds.substring(ls + 1));
          }
        }
        return true;
      }
      return false;
    }
  }
;
  speedControl.setImageDrawable(map.getResources().getDrawable(R.drawable.info_max_speed));
  speedControl.setText(null,null);
  return speedControl;
}
