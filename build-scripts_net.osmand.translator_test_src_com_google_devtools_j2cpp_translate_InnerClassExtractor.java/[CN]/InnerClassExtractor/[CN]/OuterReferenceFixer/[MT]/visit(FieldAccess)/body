{
  if (node.getExpression() instanceof ThisExpression) {
    ThisExpression thisExpr=(ThisExpression)node.getExpression();
    Name qualifier=thisExpr.getQualifier();
    if (qualifier != null) {
      TypeSymbol outer=Symbols.resolve(Types.getTypeBinding(qualifier));
      TypeSymbol current=Symbols.resolve(getCurrentType());
      if (getCurrentType().isTopLevel() || outer.equals(current)) {
        thisExpr.setQualifier(null);
      }
 else {
        AST ast=node.getAST();
        Name outerQualifier=makeOuterQualifier(outer,current,ast);
        ITypeBinding tb=(ITypeBinding)outer.getBinding();
        if (outerQualifier.isQualifiedName()) {
          String name=((QualifiedName)outerQualifier).getName().getIdentifier();
          IVariableBinding binding=new GeneratedVariableBinding(name,0,tb,true,false,tb,null);
          Types.addBinding(outerQualifier,binding);
          node.setExpression(outerQualifier);
        }
 else {
          SimpleName name=(SimpleName)outerQualifier;
          IVariableBinding binding=new GeneratedVariableBinding(name.getIdentifier(),0,tb,true,false,tb,null);
          Types.addBinding(outerQualifier,binding);
          ThisExpression newThis=ast.newThisExpression();
          Types.addBinding(newThis,tb);
          FieldAccess innerFieldAccess=ast.newFieldAccess();
          innerFieldAccess.setName(name);
          innerFieldAccess.setExpression(newThis);
          Types.addBinding(innerFieldAccess,binding);
          node.setExpression(innerFieldAccess);
        }
      }
    }
    return false;
  }
  return true;
}
