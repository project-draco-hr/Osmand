{
  if (groups.size() == 0)   return;
  Osmformat.PrimitiveBlock.Builder primblock=Osmformat.PrimitiveBlock.newBuilder();
  stringtable.clear();
  for (  PrimGroupWriterInterface i : groups)   i.addStringsToStringtable();
  stringtable.finish();
  for (  PrimGroupWriterInterface i : groups) {
    PrimitiveGroup group=i.serialize();
    if (group != null)     primblock.addPrimitivegroup(group);
  }
  primblock.setStringtable(stringtable.serialize());
  primblock.setGranularity(this.granularity);
  primblock.setDateGranularity(this.date_granularity);
  Osmformat.PrimitiveBlock message=primblock.build();
  debug_bytes+=message.getSerializedSize();
  if (false)   System.out.format("    =======>  %.2f / %.2f   (%dk)\n",message.getSerializedSize() / 1024.0,debug_bytes / 1024 / 1024.0,total_entities / 1000);
  try {
    output.write(FileBlock.newInstance("OSMData",message.toByteString(),null));
  }
 catch (  IOException e) {
    e.printStackTrace();
    throw new Error(e);
  }
 finally {
    batch_size=0;
    groups.clear();
  }
}
