{
  try {
    final Dialog dlg=new Dialog(mapActivity);
    final File f=getBaseFileName(lat,lon,app,IMG_EXTENSION);
    lastTakingPhoto=f;
    SurfaceView view=new SurfaceView(dlg.getContext());
    view.getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);
    view.getHolder().addCallback(new Callback(){
      @Override public void surfaceDestroyed(      SurfaceHolder holder){
      }
      public void setCameraDisplayOrientation(      android.hardware.Camera camera,      Parameters parameters){
        int rotation=mapActivity.getWindowManager().getDefaultDisplay().getRotation();
        int degrees=0;
switch (rotation) {
case 0:
          degrees=0;
        break;
case 1:
      degrees=90;
    break;
case 2:
  degrees=180;
break;
case 3:
degrees=270;
break;
}
parameters.set("rotation",(90 + 360 - degrees) % 360);
}
@Override public void surfaceCreated(SurfaceHolder holder){
try {
if (AV_PHOTO_PLAY_SOUND.get()) {
if (sp == null) sp=new SoundPool(5,AudioManager.STREAM_MUSIC,0);
log.info("Play sound on photo");
if (shotId == 0) {
shotId=sp.load(app.getAssets().openFd("sounds/camera_click.ogg"),1);
log.debug("loaded file sound ID: " + shotId);
}
}
Parameters parameters=cam.getParameters();
List<Camera.Size> psps=parameters.getSupportedPictureSizes();
int index=AV_CAMERA_PICTURE_SIZE.get();
log.debug("takePhotoWithCamera() index=" + index);
if (index == AV_PHOTO_SIZE_DEFAULT) {
index=cameraPictureSizeDefault;
log.debug("takePhotoWithCamera() Default value of picture size. Set index to cameraPictureSizeDefault. Now index=" + index);
}
Camera.Size selectedCamPicSize=psps.get(index);
parameters.setPictureSize(selectedCamPicSize.width,selectedCamPicSize.height);
log.debug("takePhotoWithCamera() set Picture size: width=" + selectedCamPicSize.width + " height="+ selectedCamPicSize.height);
boolean autofocus=true;
parameters.setGpsLatitude(lat);
parameters.setGpsLongitude(lon);
switch (AV_CAMERA_FOCUS_TYPE.get()) {
case AV_CAMERA_FOCUS_HIPERFOCAL:
parameters.setFocusMode(Parameters.FOCUS_MODE_FIXED);
autofocus=false;
log.info("Osmand:AudioNotes set camera FOCUS_MODE_FIXED");
break;
case AV_CAMERA_FOCUS_EDOF:
parameters.setFocusMode(Parameters.FOCUS_MODE_EDOF);
autofocus=false;
log.info("Osmand:AudioNotes set camera FOCUS_MODE_EDOF");
break;
case AV_CAMERA_FOCUS_INFINITY:
parameters.setFocusMode(Parameters.FOCUS_MODE_INFINITY);
autofocus=false;
log.info("Osmand:AudioNotes set camera FOCUS_MODE_INFINITY");
break;
case AV_CAMERA_FOCUS_MACRO:
parameters.setFocusMode(Parameters.FOCUS_MODE_MACRO);
log.info("Osmand:AudioNotes set camera FOCUS_MODE_MACRO");
break;
case AV_CAMERA_FOCUS_CONTINUOUS:
parameters.setFocusMode(Parameters.FOCUS_MODE_CONTINUOUS_PICTURE);
log.info("Osmand:AudioNotes set camera FOCUS_MODE_CONTINUOUS_PICTURE");
break;
default :
parameters.setFocusMode(Parameters.FOCUS_MODE_AUTO);
log.info("Osmand:AudioNotes set camera FOCUS_MODE_AUTO");
break;
}
parameters.setWhiteBalance(Parameters.WHITE_BALANCE_AUTO);
parameters.setFlashMode(Parameters.FLASH_MODE_AUTO);
setCameraDisplayOrientation(cam,parameters);
cam.setParameters(parameters);
cam.setPreviewDisplay(holder);
cam.startPreview();
if (!autofocus) {
printCamParams(parameters,!autofocus);
cam.takePicture(null,null,new AudioVideoPhotoHandler(dlg,f));
}
 else {
cam.autoFocus(new AutoFocusCallback(){
@Override public void onAutoFocus(boolean success,Camera camera){
cam.takePicture(null,null,new AudioVideoPhotoHandler(dlg,f));
}
}
);
}
}
 catch (Exception e) {
logErr(e);
cam.release();
e.printStackTrace();
}
}
private void printCamParams(Parameters parameters,boolean autoExposure){
log.info("Cam params auto exposure=" + autoExposure + " focus_distances="+ parameters.get("focus-distances"));
}
@Override public void surfaceChanged(SurfaceHolder holder,int format,int width,int height){
}
}
);
dlg.setContentView(view);
dlg.show();
}
 catch (RuntimeException e) {
logErr(e);
cam.release();
}
}
