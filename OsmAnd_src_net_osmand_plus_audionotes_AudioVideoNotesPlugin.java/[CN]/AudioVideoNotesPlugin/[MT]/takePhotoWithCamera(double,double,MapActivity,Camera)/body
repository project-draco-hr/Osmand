{
  try {
    final Dialog dlg=new Dialog(mapActivity);
    final File f=getBaseFileName(lat,lon,app,IMG_EXTENSION);
    lastTakingPhoto=f;
    SurfaceView view=new SurfaceView(dlg.getContext());
    view.getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);
    view.getHolder().addCallback(new Callback(){
      @Override public void surfaceDestroyed(      SurfaceHolder holder){
      }
      public void setCameraDisplayOrientation(      android.hardware.Camera camera,      Parameters parameters){
        int rotation=mapActivity.getWindowManager().getDefaultDisplay().getRotation();
        int degrees=0;
switch (rotation) {
case 0:
          degrees=0;
        break;
case 1:
      degrees=90;
    break;
case 2:
  degrees=180;
break;
case 3:
degrees=270;
break;
}
parameters.set("rotation",(90 + 360 - degrees) % 360);
}
@Override public void surfaceCreated(SurfaceHolder holder){
try {
Parameters parameters=cam.getParameters();
boolean autofocus=true;
parameters.setGpsLatitude(lat);
parameters.setGpsLongitude(lon);
if (autofocus) {
parameters.setFocusMode(Parameters.FOCUS_MODE_AUTO);
}
 else {
}
parameters.setWhiteBalance(Parameters.WHITE_BALANCE_AUTO);
parameters.setFlashMode(Parameters.FLASH_MODE_AUTO);
setCameraDisplayOrientation(cam,parameters);
cam.setParameters(parameters);
cam.setPreviewDisplay(holder);
cam.startPreview();
if (!autofocus) {
printCamParams(parameters,!autofocus);
cam.takePicture(null,null,new AudioVideoPhotoHandler(dlg,f));
}
 else {
cam.autoFocus(new AutoFocusCallback(){
@Override public void onAutoFocus(boolean success,Camera camera){
cam.takePicture(null,null,new AudioVideoPhotoHandler(dlg,f));
}
}
);
}
}
 catch (Exception e) {
logErr(e);
cam.release();
e.printStackTrace();
}
}
private void printCamParams(Parameters parameters,boolean autoExposure){
log.info("Cam params auto exposure=" + autoExposure + " focus_distances="+ parameters.get("focus-distances"));
}
@Override public void surfaceChanged(SurfaceHolder holder,int format,int width,int height){
}
}
);
dlg.setContentView(view);
dlg.show();
}
 catch (RuntimeException e) {
logErr(e);
cam.release();
}
}
