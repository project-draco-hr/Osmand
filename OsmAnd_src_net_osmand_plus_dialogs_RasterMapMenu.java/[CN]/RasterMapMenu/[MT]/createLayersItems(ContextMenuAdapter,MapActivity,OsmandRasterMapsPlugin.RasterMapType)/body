{
  OsmandApplication app=mapActivity.getMyApplication();
  final OsmandSettings settings=app.getSettings();
  final OsmandRasterMapsPlugin plugin=OsmandPlugin.getEnabledPlugin(OsmandRasterMapsPlugin.class);
  final MapTileLayer rasterMapLayer;
  final OsmandSettings.CommonPreference<Integer> mapTransparencyPreference;
  final OsmandSettings.CommonPreference<String> mapTypePreference;
  @StringRes final int mapTypeString;
  @StringRes final int mapTypeStringTransparency;
  if (type == OsmandRasterMapsPlugin.RasterMapType.OVERLAY) {
    rasterMapLayer=plugin.getOverlayLayer();
    mapTransparencyPreference=settings.MAP_OVERLAY_TRANSPARENCY;
    mapTypePreference=settings.MAP_OVERLAY;
    mapTypeString=R.string.map_overlay;
    mapTypeStringTransparency=R.string.overlay_transparency;
  }
 else   if (type == OsmandRasterMapsPlugin.RasterMapType.UNDERLAY) {
    rasterMapLayer=plugin.getUnderlayLayer();
    mapTransparencyPreference=settings.MAP_TRANSPARENCY;
    mapTypePreference=settings.MAP_UNDERLAY;
    mapTypeString=R.string.map_underlay;
    mapTypeStringTransparency=R.string.map_transparency;
  }
 else {
    throw new RuntimeException("Unexpected raster map type");
  }
  final OsmandSettings.CommonPreference<Boolean> hidePolygonsPref=mapActivity.getMyApplication().getSettings().getCustomRenderBooleanProperty("noPolygons");
  String mapTypeDescr=mapTypePreference.get();
  final boolean selected=mapTypeDescr != null;
  final int toggleActionStringId=selected ? R.string.shared_string_enable : R.string.shared_string_disable;
  final OsmandRasterMapsPlugin.OnMapSelectedCallback onMapSelectedCallback=new OsmandRasterMapsPlugin.OnMapSelectedCallback(){
    @Override public void onMapSelected(){
      mapActivity.getDashboard().refreshContent(true);
      if (type == OsmandRasterMapsPlugin.RasterMapType.UNDERLAY && selected) {
        Toast.makeText(mapActivity,R.string.consider_turning_polygons_off,Toast.LENGTH_SHORT).show();
      }
    }
  }
;
  ContextMenuAdapter.OnRowItemClick l=new ContextMenuAdapter.OnRowItemClick(){
    @Override public boolean onRowItemClick(    ArrayAdapter<?> adapter,    View view,    int itemId,    int pos){
      Log.v(TAG,"onRowItemClick(" + "adapter=" + adapter + ", view="+ view+ ", itemId="+ itemId+ ", pos="+ pos+ ")");
      if (itemId == mapTypeString) {
        if (selected) {
          plugin.selectMapOverlayLayer(mapActivity.getMapView(),mapTypePreference,mapActivity,onMapSelectedCallback);
        }
        return false;
      }
      return super.onRowItemClick(adapter,view,itemId,pos);
    }
    @Override public boolean onContextMenuClick(    final ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      if (itemId == toggleActionStringId) {
        MapActivityLayers mapLayers=mapActivity.getMapLayers();
        if (isChecked) {
          mapLayers.getMapControlsLayer().showTransparencyBar(mapTransparencyPreference);
        }
 else {
          mapLayers.getMapControlsLayer().hideTransparencyBar(mapTransparencyPreference);
        }
        plugin.toggleUnderlayState(mapActivity,type,onMapSelectedCallback);
      }
 else       if (itemId == R.string.show_polygons) {
        hidePolygonsPref.set(!isChecked);
        refreshMapComplete(mapActivity);
      }
      return false;
    }
  }
;
  int selectedCode=selected ? 1 : 0;
  mapTypeDescr=selected ? mapTypeDescr : mapActivity.getString(R.string.shared_string_none);
  contextMenuAdapter.item(toggleActionStringId).listen(l).selected(selectedCode).reg();
  contextMenuAdapter.item(mapTypeString).listen(l).layout(R.layout.two_line_list_item).description(mapTypeDescr).reg();
  ContextMenuAdapter.OnIntegerValueChangedListener integerListener=new ContextMenuAdapter.OnIntegerValueChangedListener(){
    @Override public boolean onIntegerValueChangedListener(    int newValue){
      mapTransparencyPreference.set(newValue);
      mapActivity.getMapView().refreshMap();
      return false;
    }
  }
;
  contextMenuAdapter.item(mapTypeStringTransparency).layout(R.layout.progress_list_item).progress(mapTransparencyPreference.get()).listenInteger(integerListener).reg();
  if (type == OsmandRasterMapsPlugin.RasterMapType.UNDERLAY) {
    contextMenuAdapter.item(R.string.show_polygons).listen(l).selected(hidePolygonsPref.get() ? 0 : 1).reg();
  }
}
