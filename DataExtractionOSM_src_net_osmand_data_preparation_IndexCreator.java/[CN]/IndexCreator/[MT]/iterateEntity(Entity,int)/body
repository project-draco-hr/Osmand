{
  if (step == STEP_MAIN) {
    if (indexPOI && Amenity.isAmenity(e)) {
      loadEntityData(e,false);
      if (poiPreparedStatement != null) {
        Amenity a=new Amenity(e);
        if (a.getLocation() != null) {
          convertEnglishName(a);
          DataIndexWriter.insertAmenityIntoPoi(poiPreparedStatement,pStatements,a,BATCH_SIZE);
        }
      }
    }
    if (indexTransport) {
      if (e instanceof Relation && e.getTag(OSMTagKey.ROUTE) != null) {
        loadEntityData(e,true);
        TransportRoute route=indexTransportRoute((Relation)e);
        if (route != null) {
          DataIndexWriter.insertTransportIntoIndex(transRouteStat,transRouteStopsStat,transStopsStat,visitedStops,route,pStatements,BATCH_SIZE);
        }
      }
    }
    if (indexMap && (e instanceof Way) || (e instanceof Node)) {
      loadEntityData(e,true);
      int type=MapRenderingTypes.encodeEntityWithType(e,0);
      int type1=MapRenderingTypes.encodeEntityWithType(e,1);
      int type2=MapRenderingTypes.encodeEntityWithType(e,2);
      boolean inverse="-1".equals(e.getTag(OSMTagKey.ONEWAY));
      boolean point=(type & MapRenderingTypes.TYPE_MASK) == MapRenderingTypes.POINT_TYPE;
      long id=e.getId() << 3;
      if (type != 0) {
        if (e instanceof Way) {
          id|=1;
        }
        DataIndexWriter.insertMapRenderObjectIndex(pStatements,mapWaysStat,mapWayLocsStat,e,MapRenderingTypes.getEntityName(e),id,type,inverse,point,BATCH_SIZE);
      }
      if (type1 != 0) {
        id|=2;
        boolean skip=false;
        if (e instanceof Way) {
          id|=1;
          List<Node> nodes=((Way)e).getNodes();
          Way way=new Way(id);
          int prevX=0;
          int prevY=0;
          for (int i=0; i < nodes.size() - 1; i++) {
            int r=i < nodes.size() - 1 ? 4 : 1;
            int x=(int)(MapUtils.getTileNumberX(14,nodes.get(i).getLongitude()) * 256d);
            int y=(int)(MapUtils.getTileNumberY(14,nodes.get(i).getLatitude()) * 256d);
            if (Math.abs(x - prevX) > r || Math.abs(y - prevY) > r) {
              way.addNode(nodes.get(i));
              prevX=x;
              prevY=y;
            }
          }
          e=way;
          skip=way.getNodes().size() < 2;
        }
        if (!skip) {
          DataIndexWriter.insertMapRenderObjectIndex(pStatements,mapWaysStat,mapWayLocsStatLevel2,e,MapRenderingTypes.getEntityName(e),id,type,inverse,point,BATCH_SIZE);
        }
      }
      if (type2 != 0) {
        id|=4;
        boolean skip=false;
        if (e instanceof Way) {
          id|=1;
          List<Node> nodes=((Way)e).getNodes();
          Way way=new Way(id);
          int prevX=0;
          int prevY=0;
          for (int i=0; i < nodes.size() - 1; i++) {
            int r=i < nodes.size() - 1 ? 4 : 1;
            int x=(int)(MapUtils.getTileNumberX(9,nodes.get(i).getLongitude()) * 256d);
            int y=(int)(MapUtils.getTileNumberY(9,nodes.get(i).getLatitude()) * 256d);
            if (Math.abs(x - prevX) > r || Math.abs(y - prevY) > r) {
              way.addNode(nodes.get(i));
              prevX=x;
              prevY=y;
            }
          }
          e=way;
          skip=way.getNodes().size() < 2;
        }
        if (!skip) {
          DataIndexWriter.insertMapRenderObjectIndex(pStatements,mapWaysStat,mapWayLocsStatLevel3,e,MapRenderingTypes.getEntityName(e),id,type,inverse,point,BATCH_SIZE);
        }
      }
    }
    if (indexAddress) {
      if (e.getTag(OSMTagKey.ADDR_HOUSE_NUMBER) != null && e.getTag(OSMTagKey.ADDR_STREET) != null) {
        boolean exist=false;
        if (loadInMemory) {
          exist=addressBuildingLocalSet.contains(e.getId());
        }
 else {
          addressSearchBuildingStat.setLong(1,e.getId());
          ResultSet rs=addressSearchBuildingStat.executeQuery();
          exist=rs.next();
          rs.close();
        }
        if (!exist) {
          loadEntityData(e,false);
          LatLon l=e.getLatLon();
          City city=getClosestCity(l);
          Long idStreet=getStreetInCity(city,e.getTag(OSMTagKey.ADDR_STREET),l,e.getId());
          if (idStreet != null) {
            Building building=new Building(e);
            building.setName(e.getTag(OSMTagKey.ADDR_HOUSE_NUMBER));
            convertEnglishName(building);
            DataIndexWriter.writeBuilding(addressBuildingStat,pStatements,idStreet,building,BATCH_SIZE);
          }
        }
      }
      if (e instanceof Way && e.getTag(OSMTagKey.HIGHWAY) != null && e.getTag(OSMTagKey.NAME) != null) {
        boolean exist=false;
        if (loadInMemory) {
          exist=addressStreetNodeLocalSet.contains(e.getId());
        }
 else {
          addressSearchStreetNodeStat.setLong(1,e.getId());
          ResultSet rs=addressSearchStreetNodeStat.executeQuery();
          exist=rs.next();
          rs.close();
        }
        if (!exist) {
          loadEntityData(e,false);
          LatLon l=e.getLatLon();
          City city=getClosestCity(l);
          Long idStreet=getStreetInCity(city,e.getTag(OSMTagKey.NAME),l,e.getId());
          if (idStreet != null && saveAddressWays) {
            DataIndexWriter.writeStreetWayNodes(addressStreetNodeStat,pStatements,idStreet,(Way)e,BATCH_SIZE);
          }
        }
      }
      if (e instanceof Relation) {
        if (e.getTag(OSMTagKey.POSTAL_CODE) != null) {
          loadEntityData(e,false);
          postalCodeRelations.add((Relation)e);
        }
      }
    }
  }
 else   if (step == STEP_ADDRESS_RELATIONS) {
    if (e instanceof Relation && "address".equals(e.getTag(OSMTagKey.TYPE))) {
      indexAddressRelation((Relation)e);
    }
  }
 else   if (step == STEP_CITY_NODES) {
    registerCityIfNeeded(e);
  }
}
