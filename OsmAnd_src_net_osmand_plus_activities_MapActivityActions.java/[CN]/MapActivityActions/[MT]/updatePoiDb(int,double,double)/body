{
  if (zoom < 15) {
    Toast.makeText(mapActivity,getString(R.string.update_poi_is_not_available_for_zoom),Toast.LENGTH_SHORT).show();
    return;
  }
  final List<AmenityIndexRepository> repos=((OsmandApplication)mapActivity.getApplication()).getResourceManager().searchAmenityRepositories(latitude,longitude);
  if (repos.isEmpty()) {
    Toast.makeText(mapActivity,getString(R.string.update_poi_no_offline_poi_index),Toast.LENGTH_SHORT).show();
    return;
  }
  final OsmandMapTileView mapView=mapActivity.getMapView();
  Rect pixRect=new Rect(-mapView.getWidth() / 2,-mapView.getHeight() / 2,3 * mapView.getWidth() / 2,3 * mapView.getHeight() / 2);
  RectF tileRect=new RectF();
  mapView.calculateTileRectangle(pixRect,mapView.getCenterPointX(),mapView.getCenterPointY(),mapView.getXTile(),mapView.getYTile(),tileRect);
  final double leftLon=MapUtils.getLongitudeFromTile(zoom,tileRect.left);
  final double topLat=MapUtils.getLatitudeFromTile(zoom,tileRect.top);
  final double rightLon=MapUtils.getLongitudeFromTile(zoom,tileRect.right);
  final double bottomLat=MapUtils.getLatitudeFromTile(zoom,tileRect.bottom);
  ProgressDialog progressDlg=ProgressDialog.show(mapActivity,getString(R.string.loading),getString(R.string.loading_data));
  mapActivity.setProgressDlg(progressDlg);
  new Thread(new Runnable(){
    @Override public void run(){
      try {
        List<Amenity> amenities=new ArrayList<Amenity>();
        boolean loadingPOIs=AmenityIndexRepositoryOdb.loadingPOIs(amenities,leftLon,topLat,rightLon,bottomLat);
        if (!loadingPOIs) {
          showToast(getString(R.string.update_poi_error_loading));
        }
 else {
          for (          AmenityIndexRepository r : repos) {
            if (r instanceof AmenityIndexRepositoryOdb) {
              ((AmenityIndexRepositoryOdb)r).updateAmenities(amenities,leftLon,topLat,rightLon,bottomLat);
            }
          }
          showToast(MessageFormat.format(getString(R.string.update_poi_success),amenities.size()));
          mapView.refreshMap();
        }
      }
 catch (      Exception e) {
        Log.e(LogUtil.TAG,"Error updating local data",e);
        showToast(getString(R.string.update_poi_error_local));
      }
 finally {
        Dialog prog=mapActivity.getProgressDlg();
        if (prog != null) {
          prog.dismiss();
          mapActivity.setProgressDlg(prog);
        }
      }
    }
  }
,"LoadingPOI").start();
}
