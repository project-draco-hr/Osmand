{
  final ContextMenuAdapter adapter=iadapter == null ? new ContextMenuAdapter(mapActivity) : iadapter;
  adapter.item(R.string.context_menu_item_directions_to).icons(R.drawable.ic_action_gdirections_dark,R.drawable.ic_action_gdirections_light).reg();
  final TargetPointsHelper targets=getMyApplication().getTargetPointsHelper();
  if (targets.getPointToNavigate() != null) {
    adapter.item(R.string.context_menu_item_destination_point).icons(R.drawable.ic_action_flag_dark,R.drawable.ic_action_flag_light).reg();
    adapter.item(R.string.context_menu_item_intermediate_point).icons(R.drawable.ic_action_flage_dark,R.drawable.ic_action_flage_light).reg();
  }
 else {
    adapter.item(R.string.context_menu_item_destination_point).icons(R.drawable.ic_action_flag_dark,R.drawable.ic_action_flag_light).reg();
  }
  if (!mapActivity.getRoutingHelper().isFollowingMode()) {
    adapter.item(R.string.context_menu_item_directions_from).icons(R.drawable.ic_action_gdirections_dark,R.drawable.ic_action_gdirections_light).reg();
  }
  adapter.item(R.string.context_menu_item_search).icons(R.drawable.ic_action_search_dark,R.drawable.ic_action_search_light).reg();
  adapter.item(R.string.context_menu_item_share_location).icons(R.drawable.ic_action_gshare_dark,R.drawable.ic_action_gshare_light).reg();
  adapter.item(R.string.context_menu_item_add_favorite).icons(R.drawable.ic_action_fav_dark,R.drawable.ic_action_fav_light).reg();
  OsmandPlugin.registerMapContextMenu(mapActivity,latitude,longitude,adapter,selectedObj);
  final Builder builder=new AlertDialog.Builder(mapActivity);
  ListAdapter listAdapter;
  if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB) {
    listAdapter=adapter.createListAdapter(mapActivity,R.layout.list_menu_item,getMyApplication().getSettings().isLightContentMenu());
  }
 else {
    listAdapter=adapter.createListAdapter(mapActivity,R.layout.list_menu_item_native,getMyApplication().getSettings().isLightContentMenu());
  }
  builder.setAdapter(listAdapter,new DialogInterface.OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      int standardId=adapter.getItemId(which);
      OnContextMenuClick click=adapter.getClickAdapter(which);
      if (click != null) {
        click.onContextMenuClick(standardId,which,false,dialog);
      }
 else       if (standardId == R.string.context_menu_item_search) {
        Intent intent=new Intent(mapActivity,OsmandIntents.getSearchActivity());
        intent.putExtra(SearchActivity.SEARCH_LAT,latitude);
        intent.putExtra(SearchActivity.SEARCH_LON,longitude);
        intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
        mapActivity.startActivity(intent);
      }
 else       if (standardId == R.string.context_menu_item_directions_to) {
        if (!routingHelper.isRouteBeingCalculated() && !routingHelper.isRouteCalculated()) {
          Location loc=new Location("map");
          loc.setLatitude(latitude);
          loc.setLongitude(longitude);
          String name=mapActivity.getMapLayers().getContextMenuLayer().getSelectedObjectName();
          new NavigateAction(mapActivity).getDirections(loc,name,DirectionDialogStyle.create().gpxRouteEnabled().routeToMapPoint());
        }
 else {
          String name=mapActivity.getMapLayers().getContextMenuLayer().getSelectedObjectName();
          targets.navigateToPoint(new LatLon(latitude,longitude),true,-1,name);
        }
      }
 else       if (standardId == R.string.context_menu_item_directions_from) {
        if (targets.checkPointToNavigate(getMyApplication())) {
          Location loc=new Location("map");
          loc.setLatitude(latitude);
          loc.setLongitude(longitude);
          ApplicationMode mode=settings.DEFAULT_APPLICATION_MODE.get();
          if (mode == ApplicationMode.DEFAULT) {
            mode=ApplicationMode.CAR;
          }
          OsmandApplication app=mapActivity.getMyApplication();
          app.getSettings().APPLICATION_MODE.set(mode);
          app.getRoutingHelper().setAppMode(mode);
          settings.FOLLOW_THE_ROUTE.set(false);
          settings.FOLLOW_THE_GPX_ROUTE.set(null);
          app.getRoutingHelper().setFollowingMode(false);
          app.getRoutingHelper().setFinalAndCurrentLocation(targets.getPointToNavigate(),targets.getIntermediatePoints(),loc,null);
          String name=mapActivity.getMapLayers().getContextMenuLayer().getSelectedObjectName();
        }
      }
 else       if (standardId == R.string.context_menu_item_intermediate_point || standardId == R.string.context_menu_item_destination_point) {
        boolean dest=standardId == R.string.context_menu_item_destination_point;
        String selected=mapActivity.getMapLayers().getContextMenuLayer().getSelectedObjectName();
        targets.navigateToPoint(new LatLon(latitude,longitude),true,dest ? -1 : targets.getIntermediatePoints().size(),selected);
        if (targets.getIntermediatePoints().size() > 0) {
          IntermediatePointsDialog.openIntermediatePointsDialog(mapActivity);
        }
      }
 else       if (standardId == R.string.context_menu_item_share_location) {
        enhance(dialogBundle,latitude,longitude,mapActivity.getMapView().getZoom());
        new ShareLocation(mapActivity).run();
      }
 else       if (standardId == R.string.context_menu_item_add_favorite) {
        addFavouritePoint(latitude,longitude);
      }
    }
  }
);
  builder.create().show();
}
