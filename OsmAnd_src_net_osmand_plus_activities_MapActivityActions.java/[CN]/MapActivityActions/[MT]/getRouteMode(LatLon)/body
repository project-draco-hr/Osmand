{
  ApplicationMode mode=settings.DEFAULT_APPLICATION_MODE.get();
  ApplicationMode selected=settings.APPLICATION_MODE.get();
  OsmandApplication app=mapActivity.getMyApplication();
  TargetPointsHelper targets=app.getTargetPointsHelper();
  if (from == null) {
    Location ll=app.getLocationProvider().getLastKnownLocation();
    if (ll != null) {
      from=new LatLon(ll.getLatitude(),ll.getLongitude());
    }
  }
  if (selected != ApplicationMode.DEFAULT) {
    mode=selected;
  }
 else   if (mode == ApplicationMode.DEFAULT) {
    mode=ApplicationMode.CAR;
    if (settings.LAST_ROUTING_APPLICATION_MODE != null && settings.LAST_ROUTING_APPLICATION_MODE != ApplicationMode.DEFAULT) {
      mode=settings.LAST_ROUTING_APPLICATION_MODE;
    }
  }
  return mode;
}
