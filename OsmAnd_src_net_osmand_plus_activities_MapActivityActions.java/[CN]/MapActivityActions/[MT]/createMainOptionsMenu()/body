{
  final OsmandMapTileView mapView=mapActivity.getMapView();
  final OsmandApplication app=mapActivity.getMyApplication();
  ContextMenuAdapter optionsMenuHelper=new ContextMenuAdapter(app);
  optionsMenuHelper.item(R.string.home).iconColor(R.drawable.map_dashboard).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      mapActivity.closeDrawer();
      mapActivity.getDashboard().setDashboardVisibility(true,DashboardType.DASHBOARD);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.map_markers).iconColor(R.drawable.ic_action_waypoint).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      Intent newIntent=new Intent(mapActivity,mapActivity.getMyApplication().getAppCustomization().getMapMarkersActivity());
      newIntent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT);
      mapActivity.startActivity(newIntent);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.get_directions).iconColor(R.drawable.ic_action_gdirections_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      if (!routingHelper.isFollowingMode() && !routingHelper.isRoutePlanningMode()) {
        enterRoutePlanningMode(null,null);
      }
 else {
        mapActivity.getMapViewTrackingUtilities().switchToRoutePlanningMode();
        mapActivity.refreshMap();
      }
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.search_button).iconColor(R.drawable.ic_action_search_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      Intent newIntent=new Intent(mapActivity,mapActivity.getMyApplication().getAppCustomization().getSearchActivity());
      LatLon loc=mapActivity.getMapLocation();
      newIntent.putExtra(SearchActivity.SEARCH_LAT,loc.getLatitude());
      newIntent.putExtra(SearchActivity.SEARCH_LON,loc.getLongitude());
      if (mapActivity.getMapViewTrackingUtilities().isMapLinkedToLocation()) {
        newIntent.putExtra(SearchActivity.SEARCH_NEARBY,true);
      }
      newIntent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT);
      mapActivity.startActivity(newIntent);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.shared_string_my_places).iconColor(R.drawable.ic_action_fav_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      Intent newIntent=new Intent(mapActivity,mapActivity.getMyApplication().getAppCustomization().getFavoritesActivity());
      newIntent.setFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT);
      mapActivity.startActivity(newIntent);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.show_point_options).iconColor(R.drawable.ic_action_marker_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      mapActivity.getMapLayers().getContextMenuLayer().showContextMenu(mapView.getLatitude(),mapView.getLongitude(),true);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.configure_map).iconColor(R.drawable.ic_action_layers_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      mapActivity.getDashboard().setDashboardVisibility(true,DashboardType.CONFIGURE_MAP);
      return false;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.layer_map_appearance).iconColor(R.drawable.ic_configure_screen_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      mapActivity.getDashboard().setDashboardVisibility(true,DashboardType.CONFIGURE_SCREEN);
      return false;
    }
  }
).reg();
  String d=getString(R.string.index_settings);
  if (app.getDownloadThread().getIndexes().isDownloadedFromInternet) {
    List<IndexItem> updt=app.getDownloadThread().getIndexes().getItemsToUpdate();
    if (updt != null && updt.size() > 0) {
      d+=" (" + updt.size() + ")";
    }
  }
  optionsMenuHelper.item(R.string.index_settings).name(d).iconColor(R.drawable.ic_type_archive).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      Intent newIntent=new Intent(mapActivity,mapActivity.getMyApplication().getAppCustomization().getDownloadActivity());
      mapActivity.startActivity(newIntent);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.osm_live).iconColor(R.drawable.ic_action_osm_live).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      Intent intent=new Intent(mapActivity,OsmLiveActivity.class);
      mapActivity.startActivity(intent);
      return false;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.prefs_plugins).iconColor(R.drawable.ic_extension_dark).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      Intent newIntent=new Intent(mapActivity,mapActivity.getMyApplication().getAppCustomization().getPluginsActivity());
      mapActivity.startActivity(newIntent);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.shared_string_settings).iconColor(R.drawable.ic_action_settings).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      final Intent settings=new Intent(mapActivity,getMyApplication().getAppCustomization().getSettingsActivity());
      mapActivity.startActivity(settings);
      return true;
    }
  }
).reg();
  optionsMenuHelper.item(R.string.shared_string_help).iconColor(R.drawable.ic_action_help).listen(new OnContextMenuClick(){
    @Override public boolean onContextMenuClick(    ArrayAdapter<?> adapter,    int itemId,    int pos,    boolean isChecked){
      mapActivity.startActivity(new Intent(mapActivity,HelpActivity.class));
      return true;
    }
  }
).reg();
  OsmandPlugin.registerOptionsMenu(mapActivity,optionsMenuHelper);
  getMyApplication().getAppCustomization().prepareOptionsMenu(mapActivity,optionsMenuHelper);
  return optionsMenuHelper;
}
