{
  String tag=rt.tagValuePattern.tag;
  String val=rt.tagValuePattern.value;
  String keyVal=constructRuleKey(tag,val);
  if (types.containsKey(keyVal)) {
    MapRulType mapRulType=types.get(keyVal);
    if (mapRulType.isAdditional() || mapRulType.isText()) {
      rt.id=mapRulType.id;
      if (rt.applyToTagValue != null) {
        if (mapRulType.applyToTagValue == null) {
          rt.applyToTagValue=null;
        }
 else {
          rt.applyToTagValue.addAll(mapRulType.applyToTagValue);
        }
      }
      return rt;
    }
 else {
      throw new RuntimeException("Duplicate " + keyVal);
    }
  }
 else {
    rt.id=types.size();
    types.put(keyVal,rt);
    typeList.add(rt);
    return rt;
  }
}
