{
  handler.removeMessages(1);
  long ms=SystemClock.elapsedRealtime();
  boolean useInternet=getSettings().USE_INTERNET_TO_DOWNLOAD_TILES.get();
  if (useInternet) {
    if (application != null) {
      application.getResourceManager().getMapTileDownloader().refuseAllPreviousRequests();
    }
  }
  SurfaceHolder holder=getHolder();
synchronized (holder) {
    Canvas canvas=holder.lockCanvas();
    if (canvas != null) {
      try {
        updateLatLonBounds();
        boolean nightMode=application.getDaynightHelper().isNightMode();
        if (nightMode) {
          canvas.drawARGB(255,100,100,100);
        }
 else {
          canvas.drawARGB(255,225,225,225);
        }
        drawOverMap(canvas,latlonRect,tilesRect,new DrawSettings(nightMode,updateVectorRendering));
      }
  finally {
        holder.unlockCanvasAndPost(canvas);
      }
    }
    if (MEASURE_FPS) {
      fpsMeasureMs+=SystemClock.elapsedRealtime() - ms;
      fpsMeasureCount++;
      if (fpsMeasureCount > 10 || (ms - fpsFirstMeasurement) > 400) {
        fpsFirstMeasurement=ms;
        fps=(1000f * fpsMeasureCount / fpsMeasureMs);
        fpsMeasureCount=0;
        fpsMeasureMs=0;
      }
    }
  }
}
