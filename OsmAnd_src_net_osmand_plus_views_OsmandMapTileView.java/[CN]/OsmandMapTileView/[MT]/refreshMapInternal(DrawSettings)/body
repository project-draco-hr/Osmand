{
  SurfaceHolder holder=getHolder();
  long ms=SystemClock.elapsedRealtime();
synchronized (holder) {
    Canvas canvas=holder.lockCanvas();
    if (canvas != null) {
      try {
        final float ratioy=mapPosition == OsmandSettings.BOTTOM_CONSTANT ? 0.9f : 0.5f;
        final int cy=(int)(ratioy * getHeight());
        if (currentViewport.getPixWidth() != getWidth() || currentViewport.getPixHeight() != getHeight() || currentViewport.getCenterPixelY() != cy) {
          currentViewport.setPixelDimensions(getWidth(),getHeight(),0.5f,ratioy);
          refreshBufferImage(drawSettings);
        }
        RotatedTileBox viewportToDraw=currentViewport.copy();
        fillCanvas(canvas,drawSettings);
        drawOverMap(canvas,viewportToDraw,drawSettings);
      }
  finally {
        holder.unlockCanvasAndPost(canvas);
      }
    }
    if (MEASURE_FPS) {
      main.calculateFPS(ms,SystemClock.elapsedRealtime());
    }
  }
}
