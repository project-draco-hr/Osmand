{
  final float ratioy=mapPosition == OsmandSettings.BOTTOM_CONSTANT ? 0.85f : 0.5f;
  final int cy=(int)(ratioy * view.getHeight());
  if (currentViewport.getPixWidth() != view.getWidth() || currentViewport.getPixHeight() != view.getHeight() || currentViewport.getCenterPixelY() != cy) {
    currentViewport.setPixelDimensions(view.getWidth(),view.getHeight(),0.5f,ratioy);
    refreshBufferImage(drawSettings);
  }
  if (view instanceof SurfaceView) {
    SurfaceHolder holder=((SurfaceView)view).getHolder();
    long ms=SystemClock.elapsedRealtime();
synchronized (holder) {
      Canvas canvas=holder.lockCanvas();
      if (canvas != null) {
        try {
          RotatedTileBox viewportToDraw=currentViewport.copy();
          drawOverMap(canvas,viewportToDraw,drawSettings);
        }
  finally {
          holder.unlockCanvasAndPost(canvas);
        }
      }
      if (MEASURE_FPS) {
        main.calculateFPS(ms,SystemClock.elapsedRealtime());
      }
    }
  }
 else {
    view.invalidate();
  }
}
