{
  List<City> citiesToFill=new ArrayList<City>();
  if (cities.isEmpty()) {
    preloadCities(resultMatcher);
    citiesToFill.addAll(cities.values());
  }
  preloadCities(null);
  if (name.length() == 0) {
    citiesToFill.addAll(cities.values());
    return citiesToFill;
  }
  try {
    if (searchVillages) {
      String uName=name.toUpperCase();
      List<City> foundCities=file.getCities(region,BinaryMapIndexReader.buildAddressRequest(resultMatcher),new CollatorStringMatcher(uName,StringMatcherMode.CHECK_CONTAINS),false,BinaryMapAddressReaderAdapter.POSTCODES_TYPE);
      for (      City code : foundCities) {
        citiesToFill.add(code);
        if (resultMatcher.isCancelled()) {
          return citiesToFill;
        }
      }
    }
    name=name.toLowerCase();
    for (    City c : cities.values()) {
      String cName=c.getName(useEnglishNames);
      if (CollatorStringMatcher.cmatches(collator,cName,name,StringMatcherMode.CHECK_STARTS_FROM_SPACE)) {
        if (resultMatcher.publish(c)) {
          citiesToFill.add(c);
        }
      }
      if (resultMatcher.isCancelled()) {
        return citiesToFill;
      }
    }
    int initialsize=citiesToFill.size();
    if (searchVillages) {
      List<City> foundCities=file.getCities(region,BinaryMapIndexReader.buildAddressRequest(new ResultMatcher<City>(){
        List<City> cache=new ArrayList<City>();
        @Override public boolean publish(        City c){
          if (c.getLocation() != null) {
            City ct=getClosestCity(c.getLocation(),cache);
            c.setClosestCity(ct);
          }
          return resultMatcher.publish(c);
        }
        @Override public boolean isCancelled(){
          return resultMatcher.isCancelled();
        }
      }
),new CollatorStringMatcher(name,StringMatcherMode.CHECK_STARTS_FROM_SPACE),useEnglishNames,BinaryMapAddressReaderAdapter.VILLAGES_TYPE);
      for (      City c : foundCities) {
        citiesToFill.add(c);
        if (resultMatcher.isCancelled()) {
          return citiesToFill;
        }
      }
    }
    log.debug("Loaded citites " + (citiesToFill.size() - initialsize));
  }
 catch (  IOException e) {
    log.error("Disk operation failed",e);
  }
  return citiesToFill;
}
