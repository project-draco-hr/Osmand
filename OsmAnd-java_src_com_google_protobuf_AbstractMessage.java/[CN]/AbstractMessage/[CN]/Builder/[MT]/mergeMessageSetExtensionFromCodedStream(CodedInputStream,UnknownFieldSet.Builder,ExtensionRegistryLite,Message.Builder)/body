{
  final Descriptor type=builder.getDescriptorForType();
  int typeId=0;
  ByteString rawBytes=null;
  Message.Builder subBuilder=null;
  FieldDescriptor field=null;
  while (true) {
    final int tag=input.readTag();
    if (tag == 0) {
      break;
    }
    if (tag == WireFormat.MESSAGE_SET_TYPE_ID_TAG) {
      typeId=input.readUInt32();
      if (typeId != 0) {
        final ExtensionRegistry.ExtensionInfo extension;
        if (extensionRegistry instanceof ExtensionRegistry) {
          extension=((ExtensionRegistry)extensionRegistry).findExtensionByNumber(type,typeId);
        }
 else {
          extension=null;
        }
        if (extension != null) {
          field=extension.descriptor;
          subBuilder=extension.defaultInstance.newBuilderForType();
          final Message originalMessage=(Message)builder.getField(field);
          if (originalMessage != null) {
            subBuilder.mergeFrom(originalMessage);
          }
          if (rawBytes != null) {
            subBuilder.mergeFrom(CodedInputStream.newInstance(rawBytes.newInput()));
            rawBytes=null;
          }
        }
 else {
          if (rawBytes != null) {
            unknownFields.mergeField(typeId,UnknownFieldSet.Field.newBuilder().addLengthDelimited(rawBytes).build());
            rawBytes=null;
          }
        }
      }
    }
 else     if (tag == WireFormat.MESSAGE_SET_MESSAGE_TAG) {
      if (typeId == 0) {
        rawBytes=input.readBytes();
      }
 else       if (subBuilder == null) {
        unknownFields.mergeField(typeId,UnknownFieldSet.Field.newBuilder().addLengthDelimited(input.readBytes()).build());
      }
 else {
        input.readMessage(subBuilder,extensionRegistry);
      }
    }
 else {
      if (!input.skipField(tag)) {
        break;
      }
    }
  }
  input.checkLastTagWas(WireFormat.MESSAGE_SET_ITEM_END_TAG);
  if (subBuilder != null) {
    builder.setField(field,subBuilder.build());
  }
}
