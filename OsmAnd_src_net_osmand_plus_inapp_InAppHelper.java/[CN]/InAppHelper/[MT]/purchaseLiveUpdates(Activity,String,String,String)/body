{
  if (!mHelper.subscriptionsSupported()) {
    complain("Subscriptions not supported on your device yet. Sorry!");
    if (callbacks != null) {
      callbacks.onError("Subscriptions not supported on your device yet. Sorry!");
    }
    if (stopAfterResult) {
      stop();
    }
    return;
  }
  if (callbacks != null) {
    callbacks.showProgress();
  }
  new AsyncTask<Void,Void,String>(){
    private String userId;
    @Override protected String doInBackground(    Void... params){
      userId=ctx.getSettings().BILLING_USER_ID.get();
      if (Algorithms.isEmpty(userId)) {
        try {
          Map<String,String> parameters=new HashMap<>();
          parameters.put("visibleName",userName);
          parameters.put("preferredCountry",countryDownloadName);
          parameters.put("email",email);
          parameters.put("status","new");
          return sendRequest("http://download.osmand.net/subscription/register.php",parameters,"Requesting userId...");
        }
 catch (        Exception e) {
          Log.e(TAG,"sendRequest Error",e);
          return null;
        }
      }
 else {
        return null;
      }
    }
    @Override protected void onPostExecute(    String response){
      if (Algorithms.isEmpty(userId)) {
        Log.d(TAG,"Response=" + response);
        if (response == null) {
          complain("Cannot retrieve userId from server.");
          if (callbacks != null) {
            callbacks.dismissProgress();
            callbacks.onError("Cannot retrieve userId from server.");
          }
          if (stopAfterResult) {
            stop();
          }
          return;
        }
 else {
          try {
            JSONObject obj=new JSONObject(response);
            userId=obj.getString("userid");
            ctx.getSettings().BILLING_USER_ID.set(userId);
            Log.d(TAG,"UserId=" + userId);
          }
 catch (          JSONException e) {
            String message="JSON parsing error: " + (e.getMessage() == null ? "unknown" : e.getMessage());
            complain(message);
            if (callbacks != null) {
              callbacks.dismissProgress();
              callbacks.onError(message);
            }
            if (stopAfterResult) {
              stop();
            }
          }
        }
      }
      if (callbacks != null) {
        callbacks.dismissProgress();
      }
      if (!Algorithms.isEmpty(userId)) {
        Log.d(TAG,"Launching purchase flow for live updates subscription for userId=" + userId);
        String payload=userId;
        if (mHelper != null) {
          mHelper.launchPurchaseFlow(activity,SKU_LIVE_UPDATES,IabHelper.ITEM_TYPE_SUBS,RC_REQUEST,mPurchaseFinishedListener,payload);
        }
      }
 else {
        if (callbacks != null) {
          callbacks.onError("Empty userId");
        }
        if (stopAfterResult) {
          stop();
        }
      }
    }
  }
.execute((Void)null);
}
