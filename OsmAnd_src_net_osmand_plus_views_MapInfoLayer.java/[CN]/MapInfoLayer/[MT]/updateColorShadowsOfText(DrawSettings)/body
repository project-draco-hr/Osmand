{
  boolean transparent=view.getSettings().TRANSPARENT_MAP_THEME.get();
  boolean nightMode=drawSettings == null ? false : drawSettings.isNightMode();
  boolean following=routeLayer.getHelper().isFollowingMode();
  int calcThemeId=(transparent ? 4 : 0) | (nightMode ? 2 : 0) | (following ? 1 : 0);
  if (themeId != calcThemeId) {
    themeId=calcThemeId;
    boolean textBold=following;
    int textColor=nightMode ? view.getResources().getColor(R.color.widgettext_night) : Color.BLACK;
    int textShadowColor=nightMode ? view.getResources().getColor(R.color.widgettext_shadow_night) : Color.WHITE;
    if (!transparent && !nightMode) {
      textShadowColor=Color.TRANSPARENT;
    }
    int boxTop;
    int rightRes;
    int leftRes;
    int expand;
    int boxFree;
    if (transparent) {
      boxTop=R.drawable.btn_flat_trans;
      rightRes=R.drawable.btn_left_round_trans;
      leftRes=R.drawable.btn_right_round_trans;
      expand=R.drawable.btn_inset_circle_trans;
      boxFree=R.drawable.btn_round_trans;
    }
 else     if (nightMode) {
      boxTop=R.drawable.btn_flat_night;
      rightRes=R.drawable.btn_left_round_night;
      leftRes=R.drawable.btn_right_round_night;
      expand=R.drawable.btn_inset_circle_night;
      boxFree=R.drawable.btn_round_night;
    }
 else {
      boxTop=R.drawable.btn_flat;
      rightRes=R.drawable.btn_left_round;
      leftRes=R.drawable.btn_right_round;
      expand=R.drawable.btn_inset_circle;
      boxFree=R.drawable.btn_round;
    }
    for (int i=0; i < rightStack.getChildCount(); i++) {
      View v=rightStack.getChildAt(i).findViewById(R.id.widget_bg);
      if (v != null) {
        v.setBackgroundResource(rightRes);
        updateTextColor(v.findViewById(R.id.widget_text_small),textColor,textShadowColor,textBold);
        updateTextColor(v.findViewById(R.id.widget_text),textColor,textShadowColor,textBold);
      }
    }
    for (int i=0; i < leftStack.getChildCount(); i++) {
      View v=leftStack.getChildAt(i).findViewById(R.id.widget_bg);
      if (v != null) {
        v.setBackgroundResource(leftRes);
        updateTextColor(v.findViewById(R.id.widget_text_small),textColor,textShadowColor,textBold);
        updateTextColor(v.findViewById(R.id.widget_text),textColor,textShadowColor,textBold);
      }
    }
    this.expand.setBackgroundResource(expand);
    rightStack.invalidate();
    leftStack.invalidate();
  }
}
