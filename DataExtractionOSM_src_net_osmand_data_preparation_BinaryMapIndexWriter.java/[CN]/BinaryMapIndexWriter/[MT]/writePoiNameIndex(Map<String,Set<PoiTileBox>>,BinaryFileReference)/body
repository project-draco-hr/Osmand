{
  checkPeekState(POI_INDEX_INIT);
  codedOutStream.writeTag(OsmandOdb.OsmAndPoiIndex.NAMEINDEX_FIELD_NUMBER,WireFormat.WIRETYPE_FIXED32_LENGTH_DELIMITED);
  preserveInt32Size();
  Map<String,Integer> indexedTable=new LinkedHashMap<String,Integer>();
  Map<PoiTileBox,List<BinaryFileReference>> fpToWriteSeeks=new LinkedHashMap<PoiTileBox,List<BinaryFileReference>>();
  int previousSize=0;
  for (  Map.Entry<String,Set<PoiTileBox>> e : namesIndex.entrySet()) {
    OsmAndPoiNameIndex.OsmAndPoiNameIndexData.Builder builder=OsmAndPoiNameIndex.OsmAndPoiNameIndexData.newBuilder();
    List<PoiTileBox> tileBoxes=new ArrayList<PoiTileBox>(e.getValue());
    for (    PoiTileBox box : tileBoxes) {
      OsmandOdb.OsmAndPoiNameIndexDataAtom.Builder bs=OsmandOdb.OsmAndPoiNameIndexDataAtom.newBuilder();
      bs.setX(box.getX());
      bs.setY(box.getY());
      bs.setZoom(box.getZoom());
      bs.setShiftTo(0);
      OsmAndPoiNameIndexDataAtom atom=bs.build();
      builder.addAtoms(atom);
    }
    OsmAndPoiNameIndex.OsmAndPoiNameIndexData msg=builder.build();
    codedOutStream.writeMessage(OsmandOdb.OsmAndPoiNameIndex.DATA_FIELD_NUMBER,msg);
    long endPointer=codedOutStream.getWrittenBytes();
    indexedTable.put(e.getKey(),(int)(endPointer - msg.getSerializedSize() - startPoiIndex.getStartPointer()));
    int accumulateSize=4;
    for (int i=tileBoxes.size() - 1; i >= 0; i--) {
      PoiTileBox box=tileBoxes.get(i);
      if (!fpToWriteSeeks.containsKey(box)) {
        fpToWriteSeeks.put(box,new ArrayList<BinaryFileReference>());
      }
      fpToWriteSeeks.get(box).add(BinaryFileReferences.createShiftReference(endPointer - accumulateSize,startPoiIndex.getStartPointer()));
      accumulateSize+=CodedOutputStream.computeMessageSize(OsmAndPoiNameIndex.OsmAndPoiNameIndexData.ATOMS_FIELD_NUMBER,msg.getAtoms(i));
    }
  }
  writeInt32Size();
  writeIndexedTable(OsmandOdb.OsmAndPoiIndex.TABLE_FIELD_NUMBER,indexedTable);
  return fpToWriteSeeks;
}
