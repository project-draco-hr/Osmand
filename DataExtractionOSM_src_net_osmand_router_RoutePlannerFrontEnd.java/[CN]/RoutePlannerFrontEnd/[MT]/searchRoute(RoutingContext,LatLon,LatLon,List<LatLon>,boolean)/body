{
  if (ctx.calculationProgress == null) {
    ctx.calculationProgress=new RouteCalculationProgress();
  }
  if ((intermediates == null || intermediates.isEmpty()) && useOldVersion && ctx.nativeLib != null) {
    ctx.startX=MapUtils.get31TileNumberX(start.getLongitude());
    ctx.startY=MapUtils.get31TileNumberY(start.getLatitude());
    ctx.targetX=MapUtils.get31TileNumberX(end.getLongitude());
    ctx.targetY=MapUtils.get31TileNumberY(end.getLatitude());
    List<RouteSegmentResult> res=runNativeRouting(ctx,leftSideNavigation);
    if (res != null) {
      new RouteResultPreparation().printResults(ctx,start,end,res);
    }
    return res;
  }
  int indexNotFound=0;
  List<RouteSegment> points=new ArrayList<BinaryRoutePlanner.RouteSegment>();
  if (!addSegment(start,ctx,indexNotFound++,points)) {
    return null;
  }
  if (intermediates != null) {
    for (    LatLon l : intermediates) {
      if (!addSegment(l,ctx,indexNotFound++,points)) {
        return null;
      }
    }
  }
  if (!addSegment(end,ctx,indexNotFound++,points)) {
    return null;
  }
  List<RouteSegmentResult> res=searchRoute(ctx,points,leftSideNavigation);
  if (res != null) {
    new RouteResultPreparation().printResults(ctx,start,end,res);
  }
  return res;
}
