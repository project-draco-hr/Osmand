{
  Point popupMenuPoint=map.getPopupMenuPoint();
  double fy=(popupMenuPoint.y - map.getCenterPointY()) / map.getTileSize();
  double fx=(popupMenuPoint.x - map.getCenterPointX()) / map.getTileSize();
  final double latitude=MapUtils.getLatitudeFromTile(map.getZoom(),map.getYTile() + fy);
  final double longitude=MapUtils.getLongitudeFromTile(map.getZoom(),map.getXTile() + fx);
  final ClusteringContext clusterCtx=new ClusteringContext();
  new Thread(new Runnable(){
    @Override public void run(){
      try {
        final DataTileManager<Way> points=new DataTileManager<Way>(11);
        List<RouteSegment> ways=clustering(clusterCtx,latitude,longitude,points);
        for (        RouteSegment s : ways) {
          Way w=new Way(-1);
          int st=s.getSegmentStart();
          int end=s.getParentSegmentEnd();
          if (st > end) {
            int t=st;
            st=end;
            end=t;
          }
          for (int i=st; i <= end; i++) {
            net.osmand.osm.Node n=new net.osmand.osm.Node(MapUtils.get31LatitudeY(s.getRoad().getPoint31YTile(i)),MapUtils.get31LongitudeX(s.getRoad().getPoint31XTile(i)),-1);
            w.addNode(n);
          }
          LatLon n=w.getLatLon();
          points.registerObject(n.getLatitude(),n.getLongitude(),w);
        }
        map.setPoints(points);
        map.repaint();
      }
 catch (      IOException e) {
        e.printStackTrace();
      }
    }
  }
).start();
}
