{
  getMyApplication().applyTheme(this);
  super.onCreate(savedInstanceState);
  requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);
  setProgressBarIndeterminateVisibility(false);
  setContentView(R.layout.tab_content);
  OsmandSettings settings=((OsmandApplication)getApplication()).getSettings();
  tabHost=(TabHost)findViewById(android.R.id.tabhost);
  tabHost.setup();
  ViewPager viewPager=(ViewPager)findViewById(R.id.pager);
  mTabsAdapter=new FavouritesActivity.TabsAdapter(this,tabHost,viewPager,settings,false);
  if (getMyApplication().getAppCustomization().onlyTourDownload()) {
    mTabsAdapter.addTab(tabHost.newTabSpec("DOWNLOADS").setIndicator("Downloads"),DownloadIndexFragment.class,null);
  }
 else {
    mTabsAdapter.addTab(tabHost.newTabSpec("LOCAL_INDEX").setIndicator("Local"),LocalIndexesFragment.class,null);
    mTabsAdapter.addTab(tabHost.newTabSpec("DOWNLOADS").setIndicator("Downloads"),DownloadIndexFragment.class,null);
    mTabsAdapter.addTab(tabHost.newTabSpec("UPDATES").setIndicator("Updates"),UpdatesIndexFragment.class,null);
  }
  tabHost.setCurrentTab(0);
  if (downloadListIndexThread == null) {
    downloadListIndexThread=new DownloadIndexesThread(this);
  }
  if (downloadListIndexThread.getCachedIndexFiles() != null && downloadListIndexThread.isDownloadedFromInternet()) {
    downloadListIndexThread.runCategorization(type);
  }
 else {
    downloadListIndexThread.runReloadIndexFiles();
  }
  downloadListIndexThread.setUiActivity(this);
  settings=((OsmandApplication)getApplication()).getSettings();
  indeterminateProgressBar=(ProgressBar)findViewById(R.id.IndeterminateProgressBar);
  determinateProgressBar=(ProgressBar)findViewById(R.id.DeterminateProgressBar);
  progressView=findViewById(R.id.ProgressView);
  progressMessage=(TextView)findViewById(R.id.ProgressMessage);
  progressPercent=(TextView)findViewById(R.id.ProgressPercent);
  cancel=(ImageView)findViewById(R.id.Cancel);
  int d=settings.isLightContent() ? R.drawable.a_1_navigation_cancel_small_light : R.drawable.a_1_navigation_cancel_small_dark;
  cancel.setImageDrawable(getResources().getDrawable(d));
  cancel.setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      makeSureUserCancelDownload();
    }
  }
);
  findViewById(R.id.DownloadButton).setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      downloadFilesCheckFreeVersion();
    }
  }
);
  final List<DownloadActivityType> downloadTypes=getDownloadTypes();
  final Intent intent=getIntent();
  setType(downloadTypes.get(0));
  if (intent != null && intent.getExtras() != null) {
    final String filter=intent.getExtras().getString(FILTER_KEY);
    final String filterCat=intent.getExtras().getString(FILTER_CAT);
    if (filterCat != null) {
      DownloadActivityType type=DownloadActivityType.getIndexType(filterCat.toLowerCase());
      if (type != null) {
        setType(type);
        downloadTypes.remove(type);
        downloadTypes.add(0,type);
      }
    }
  }
  if (getMyApplication().getResourceManager().getIndexFileNames().isEmpty()) {
    boolean showedDialog=false;
    if (Build.VERSION.SDK_INT < OsmandSettings.VERSION_DEFAULTLOCATION_CHANGED) {
      SuggestExternalDirectoryDialog.showDialog(this,null,null);
    }
    if (!showedDialog) {
      showDialogOfFreeDownloadsIfNeeded();
    }
  }
 else {
    showDialogOfFreeDownloadsIfNeeded();
  }
  if (Build.VERSION.SDK_INT >= OsmandSettings.VERSION_DEFAULTLOCATION_CHANGED) {
    final String currentStorage=settings.getExternalStorageDirectory().getAbsolutePath();
    String primaryStorage=settings.getDefaultExternalStorageLocation();
    if (!currentStorage.startsWith(primaryStorage)) {
      boolean currentDirectoryNotWritable=true;
      for (      String writeableDirectory : settings.getWritableSecondaryStorageDirectorys()) {
        if (currentStorage.startsWith(writeableDirectory)) {
          currentDirectoryNotWritable=false;
          break;
        }
      }
      if (currentDirectoryNotWritable) {
        currentDirectoryNotWritable=!OsmandSettings.isWritable(settings.getExternalStorageDirectory());
      }
      if (currentDirectoryNotWritable) {
        final String newLoc=settings.getMatchingExternalFilesDir(currentStorage);
        if (newLoc != null && newLoc.length() != 0) {
          AccessibleAlertBuilder ab=new AccessibleAlertBuilder(this);
          ab.setMessage(getString(R.string.android_19_location_disabled,settings.getExternalStorageDirectory()));
          ab.setPositiveButton(R.string.default_buttons_yes,new DialogInterface.OnClickListener(){
            @Override public void onClick(            DialogInterface dialog,            int which){
              copyFilesForAndroid19(newLoc);
            }
          }
);
          ab.setNegativeButton(R.string.default_buttons_cancel,null);
          ab.show();
        }
      }
    }
  }
  getSupportActionBar().setHomeButtonEnabled(true);
  getSupportActionBar().setDisplayHomeAsUpEnabled(true);
}
