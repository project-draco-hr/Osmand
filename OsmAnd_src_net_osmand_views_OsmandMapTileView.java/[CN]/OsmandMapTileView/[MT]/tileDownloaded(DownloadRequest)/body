{
  if (request == null || rotate != 0) {
    refreshMap();
    return;
  }
  if (request.error) {
    return;
  }
  if (request.zoom != getZoom()) {
    return;
  }
  float w=getCenterPointX();
  float h=getCenterPointY();
  float tileX=getXTile();
  float tileY=getYTile();
  SurfaceHolder holder=getHolder();
synchronized (holder) {
    tilesRect.set(request.xTile,request.yTile,request.xTile + 1,request.yTile + 1);
    calculatePixelRectangle(boundsRect,w,h,tileX,tileY,tilesRect);
    if (boundsRect.left > getWidth() || boundsRect.right < 0 || boundsRect.bottom < 0 || boundsRect.top > getHeight()) {
      return;
    }
    Canvas canvas=holder.lockCanvas(boundsRect);
    if (canvas != null) {
      canvas.save();
      canvas.rotate(rotate,w,h);
      try {
        Bitmap bmp=null;
        if (map != null) {
          ResourceManager mgr=getApplication().getResourceManager();
          bmp=mgr.getTileImageForMapSync(null,map,request.xTile,request.yTile,request.zoom,false);
        }
        float x=(request.xTile - tileX) * getTileSize() + w;
        float y=(request.yTile - tileY) * getTileSize() + h;
        float tileSize=getTileSize();
        if (bmp == null) {
          drawEmptyTile(canvas,x,y,tileSize);
        }
 else {
          bitmapToZoom.set(0,0,getSourceTileSize(),getSourceTileSize());
          bitmapToDraw.set(x,y,x + tileSize,y + tileSize);
          canvas.drawBitmap(bmp,bitmapToZoom,bitmapToDraw,paintBitmap);
        }
        drawOverMap(canvas,latlonRect);
      }
  finally {
        holder.unlockCanvasAndPost(canvas);
      }
    }
  }
}
