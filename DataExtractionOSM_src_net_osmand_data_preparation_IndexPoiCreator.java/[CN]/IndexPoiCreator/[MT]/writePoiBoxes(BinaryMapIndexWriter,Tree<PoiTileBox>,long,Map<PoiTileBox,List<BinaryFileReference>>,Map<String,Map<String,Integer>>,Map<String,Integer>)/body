{
  int x=tree.getNode().x;
  int y=tree.getNode().y;
  int zoom=tree.getNode().zoom;
  boolean end=zoom == ZOOM_TO_SAVE_END;
  BinaryFileReference fileRef=writer.startWritePoiBox(zoom,x,y,startFpPoiIndex,end);
  if (fileRef != null) {
    if (!fpToWriteSeeks.containsKey(tree.getNode())) {
      fpToWriteSeeks.put(tree.getNode(),new ArrayList<BinaryFileReference>());
    }
    fpToWriteSeeks.get(tree.getNode()).add(fileRef);
  }
  if (zoom >= ZOOM_TO_WRITE_CATEGORIES_START && zoom <= ZOOM_TO_WRITE_CATEGORIES_END) {
    TIntArrayList types=new TIntArrayList();
    for (    Map.Entry<String,Map<String,Integer>> cats : tree.getNode().categories.entrySet()) {
      for (      String subcat : cats.getValue().keySet()) {
        String cat=cats.getKey();
        buildTypeIds(cat,subcat,categories,catIndexes,types);
      }
    }
    writer.writePoiCategories(types);
  }
  if (!end) {
    for (    Tree<PoiTileBox> subTree : tree.getSubtrees()) {
      writePoiBoxes(writer,subTree,startFpPoiIndex,fpToWriteSeeks,categories,catIndexes);
    }
  }
  writer.endWritePoiBox();
}
