{
  ViewTreeObserver vto=view.getViewTreeObserver();
  vto.addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener(){
    @Override public void onGlobalLayout(){
      ViewTreeObserver obs=view.getViewTreeObserver();
      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
        obs.removeOnGlobalLayoutListener(this);
      }
 else {
        obs.removeGlobalOnLayoutListener(this);
      }
      if (getActivity() == null) {
        return;
      }
      int newMenuTopViewHeight=view.findViewById(R.id.context_menu_top_view).getHeight();
      menuTopShadowHeight=view.findViewById(R.id.context_menu_top_shadow).getHeight();
      menuTopShadowAllHeight=view.findViewById(R.id.context_menu_top_shadow_all).getHeight();
      menuFullHeight=view.findViewById(R.id.context_menu_main).getHeight();
      int dy=0;
      if (!menu.isLandscapeLayout() && menuTopViewHeight != 0) {
        dy=Math.max(0,newMenuTopViewHeight - menuTopViewHeight);
      }
      menuTopViewHeight=newMenuTopViewHeight;
      menuTitleHeight=menuTopShadowHeight + menuTopShadowAllHeight + dy;
      menuBottomViewHeight=view.findViewById(R.id.context_menu_bottom_view).getHeight();
      menuFullHeightMax=menuTitleHeight + (menuBottomViewHeight > 0 ? menuBottomViewHeight : -dpToPx(SHADOW_HEIGHT_BOTTOM_DP));
      if (origMarkerX == 0 && origMarkerY == 0) {
        origMarkerX=view.getWidth() / 2;
        origMarkerY=view.getHeight() / 2;
      }
      doLayoutMenu();
    }
  }
);
}
