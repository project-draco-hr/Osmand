{
  float val=event.values[0];
  if (currentScreenOrientation == 1) {
    val+=90;
  }
 else   if (currentScreenOrientation == 2) {
    val+=180;
  }
 else   if (currentScreenOrientation == 3) {
    val+=270;
  }
  Location l=getLastKnownLocation();
  if (l != null && previousCorrectionValue == 360) {
    GeomagneticField gf=new GeomagneticField((float)l.getLatitude(),(float)l.getLongitude(),(float)l.getAltitude(),System.currentTimeMillis());
    previousCorrectionValue=gf.getDeclination();
  }
  if (previousCorrectionValue != 360) {
    val+=previousCorrectionValue;
  }
  previousSensorValue=val;
  if (settings.ROTATE_MAP.get() == OsmandSettings.ROTATE_MAP_COMPASS) {
    if (Math.abs(MapUtils.degreesDiff(mapView.getRotate(),-val)) > 15) {
      mapView.setRotate(-val);
    }
  }
  if (settings.SHOW_VIEW_ANGLE.get().booleanValue()) {
    if (mapLayers.getLocationLayer().getHeading() == null || Math.abs(mapLayers.getLocationLayer().getHeading() - val) > 10) {
      mapLayers.getLocationLayer().setHeading(val);
    }
  }
}
