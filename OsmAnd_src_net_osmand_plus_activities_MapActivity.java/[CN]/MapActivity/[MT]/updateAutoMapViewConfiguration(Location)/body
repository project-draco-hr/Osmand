{
  long now=System.currentTimeMillis();
  if (isMapLinkedToLocation()) {
    if (settings.AUTO_ZOOM_MAP.get() && location.hasSpeed()) {
      float zdelta=defineZoomFromSpeed(location.getSpeed());
      if (Math.abs(zdelta) >= OsmandMapTileView.ZOOM_DELTA_1) {
        if (zdelta >= 2) {
          zdelta-=3 * OsmandMapTileView.ZOOM_DELTA_1;
        }
 else         if (zdelta <= -2) {
          zdelta+=3 * OsmandMapTileView.ZOOM_DELTA_1;
        }
        if (now - lastTimeAutoZooming > 4500) {
          lastTimeAutoZooming=now;
          float newZoom=Math.round((mapView.getFloatZoom() + zdelta) * OsmandMapTileView.ZOOM_DELTA) * OsmandMapTileView.ZOOM_DELTA_1;
          mapView.setZoom(newZoom);
        }
      }
    }
    int currentMapRotation=settings.ROTATE_MAP.get();
    if (currentMapRotation == OsmandSettings.ROTATE_MAP_BEARING) {
      if (location.hasBearing()) {
        if (location.getBearing() != 0f) {
          mapView.setRotate(-location.getBearing());
        }
      }
 else       if (routingHelper.isFollowingMode() && settings.USE_COMPASS_IN_NAVIGATION.get()) {
        if (previousSensorValue != 0 && Math.abs(MapUtils.degreesDiff(mapView.getRotate(),-previousSensorValue)) > 15) {
          if (now - lastTimeSensorRotation > 1500 && now - lastTimeSensorRotation < 15000) {
            lastTimeSensorRotation=now;
            mapView.setRotate(-previousSensorValue);
          }
        }
      }
    }
    mapView.setLatLon(location.getLatitude(),location.getLongitude());
  }
 else {
    if (!mapLayers.getMapInfoLayer().getBackToLocation().isEnabled()) {
      mapLayers.getMapInfoLayer().getBackToLocation().setEnabled(true);
    }
    if (settings.AUTO_FOLLOW_ROUTE.get() > 0 && routingHelper.isFollowingMode() && !uiHandler.hasMessages(AUTO_FOLLOW_MSG_ID)) {
      backToLocationWithDelay(1);
    }
  }
}
