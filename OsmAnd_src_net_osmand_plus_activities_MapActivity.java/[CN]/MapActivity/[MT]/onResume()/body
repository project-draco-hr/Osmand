{
  super.onResume();
  if (settings.MAP_SCREEN_ORIENTATION.get() != getRequestedOrientation()) {
    setRequestedOrientation(settings.MAP_SCREEN_ORIENTATION.get());
  }
  mapLayers.getNavigationLayer().setPointToNavigate(settings.getPointToNavigate());
  currentScreenOrientation=getWindow().getWindowManager().getDefaultDisplay().getOrientation();
  if (settings.AUDIO_STREAM_GUIDANCE.get() != null) {
    setVolumeControlStream(settings.AUDIO_STREAM_GUIDANCE.get());
  }
 else {
    setVolumeControlStream(AudioManager.STREAM_MUSIC);
  }
  mapLayers.updateMapSource(mapView,null);
  updateApplicationModeSettings();
  mapLayers.getPoiMapLayer().setFilter(settings.getPoiFilterForMap((OsmandApplication)getApplication()));
  backToLocation.setVisibility(View.INVISIBLE);
  isMapLinkedToLocation=false;
  if (routingHelper.isFollowingMode()) {
    isMapLinkedToLocation=true;
  }
  routingHelper.setUiActivity(this);
  if (routingHelper.isFollowingMode() && !Algoritms.objectEquals(settings.getPointToNavigate(),routingHelper.getFinalLocation())) {
    routingHelper.setFinalAndCurrentLocation(settings.getPointToNavigate(),routingHelper.getCurrentLocation());
  }
  LocationManager service=(LocationManager)getSystemService(LOCATION_SERVICE);
  try {
    service.requestLocationUpdates(LocationManager.GPS_PROVIDER,GPS_TIMEOUT_REQUEST,GPS_DIST_REQUEST,gpsListener);
  }
 catch (  IllegalArgumentException e) {
    Log.d(LogUtil.TAG,"GPS location provider not available");
  }
  if (!useOnlyGPS()) {
    try {
      service.requestLocationUpdates(LocationManager.NETWORK_PROVIDER,GPS_TIMEOUT_REQUEST,GPS_DIST_REQUEST,networkListener);
    }
 catch (    IllegalArgumentException e) {
      Log.d(LogUtil.TAG,"Network location provider not available");
    }
  }
  if (settings != null && settings.isLastKnownMapLocation()) {
    LatLon l=settings.getLastKnownMapLocation();
    mapView.setLatLon(l.getLatitude(),l.getLongitude());
    mapView.setZoom(settings.getLastKnownMapZoom());
  }
  settings.MAP_ACTIVITY_ENABLED.set(true);
  checkExternalStorage();
  showAndHideMapPosition();
  LatLon cur=new LatLon(mapView.getLatitude(),mapView.getLongitude());
  LatLon latLon=settings.getAndClearMapLocationToShow();
  if (latLon != null && !latLon.equals(cur)) {
    mapView.getAnimatedDraggingThread().startMoving(latLon.getLatitude(),latLon.getLongitude(),settings.getMapZoomToShow(),true);
  }
  View progress=findViewById(R.id.ProgressBar);
  if (progress != null) {
    getMyApplication().getResourceManager().setBusyIndicator(new BusyIndicator(this,progress));
  }
  getMyApplication().getDaynightHelper().onMapResume();
}
