{
  super.onResume();
  if (settings.MAP_SCREEN_ORIENTATION.get() != getRequestedOrientation()) {
    setRequestedOrientation(settings.MAP_SCREEN_ORIENTATION.get());
  }
  currentScreenOrientation=getWindow().getWindowManager().getDefaultDisplay().getOrientation();
  boolean showTiles=!settings.isUsingMapVectorData();
  ITileSource source=showTiles ? settings.getMapTileSource() : null;
  if (showTiles != !rendererLayer.isVisible() || !Algoritms.objectEquals(mapView.getMap(),source)) {
    updateMapSource();
  }
  updateApplicationModeSettings();
  poiMapLayer.setFilter(settings.getPoiFilterForMap((OsmandApplication)getApplication()));
  backToLocation.setVisibility(View.INVISIBLE);
  routingHelper.setUiActivity(this);
  LocationManager service=(LocationManager)getSystemService(LOCATION_SERVICE);
  try {
    service.requestLocationUpdates(LocationManager.GPS_PROVIDER,GPS_TIMEOUT_REQUEST,GPS_DIST_REQUEST,gpsListener);
    currentLocationProvider=LocationManager.GPS_PROVIDER;
  }
 catch (  IllegalArgumentException e) {
    Log.d(LogUtil.TAG,"GPS location provider not available");
  }
  if (!useOnlyGPS()) {
    try {
      service.requestLocationUpdates(LocationManager.NETWORK_PROVIDER,GPS_TIMEOUT_REQUEST,GPS_DIST_REQUEST,networkListener);
      currentLocationProvider=LocationManager.NETWORK_PROVIDER;
    }
 catch (    IllegalArgumentException e) {
      Log.d(LogUtil.TAG,"Network location provider not available");
    }
  }
  LocationProvider prov=service.getProvider(currentLocationProvider);
  providerSupportsBearing=prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
  providerSupportsSpeed=prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
  if (settings != null && settings.isLastKnownMapLocation()) {
    LatLon l=settings.getLastKnownMapLocation();
    mapView.setLatLon(l.getLatitude(),l.getLongitude());
    mapView.setZoom(settings.getLastKnownMapZoom());
  }
  if (wakeLock == null) {
    PowerManager powerManager=(PowerManager)getSystemService(POWER_SERVICE);
    wakeLock=powerManager.newWakeLock(PowerManager.SCREEN_BRIGHT_WAKE_LOCK,"net.osmand.map");
    wakeLock.acquire();
  }
  settings.MAP_ACTIVITY_ENABLED.set(true);
  checkExternalStorage();
  showAndHideMapPosition();
  LatLon cur=new LatLon(mapView.getLatitude(),mapView.getLongitude());
  LatLon latLon=settings.getAndClearMapLocationToShow();
  if (latLon != null && !latLon.equals(cur)) {
    mapView.getAnimatedDraggingThread().startMoving(cur.getLatitude(),cur.getLongitude(),latLon.getLatitude(),latLon.getLongitude(),mapView.getZoom(),settings.getMapZoomToShow(),mapView.getSourceTileSize(),mapView.getRotate(),true);
  }
  View progress=findViewById(R.id.ProgressBar);
  if (progress != null) {
    ((OsmandApplication)getApplication()).getResourceManager().setBusyIndicator(new BusyIndicator(this,progress));
  }
  ((OsmandApplication)getApplication()).getDaynightHelper().onMapResume();
}
