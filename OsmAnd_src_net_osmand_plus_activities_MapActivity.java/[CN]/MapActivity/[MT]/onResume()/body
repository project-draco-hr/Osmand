{
  super.onResume();
  cancelNotification();
  if (getSupportActionBar() != null) {
    getSupportActionBar().hide();
  }
  if (settings.MAP_SCREEN_ORIENTATION.get() != getRequestedOrientation()) {
    setRequestedOrientation(settings.MAP_SCREEN_ORIENTATION.get());
  }
  app.getLocationProvider().checkIfLastKnownLocationIsValid();
  if (settings.AUDIO_STREAM_GUIDANCE.get() != null) {
    setVolumeControlStream(settings.AUDIO_STREAM_GUIDANCE.get());
  }
 else {
    setVolumeControlStream(AudioManager.STREAM_MUSIC);
  }
  changeKeyguardFlags();
  applicationModeListener=new StateChangedListener<ApplicationMode>(){
    @Override public void stateChanged(    ApplicationMode change){
      updateApplicationModeSettings();
    }
  }
;
  settings.APPLICATION_MODE.addListener(applicationModeListener);
  updateApplicationModeSettings();
  String filterId=settings.getPoiFilterForMap();
  PoiLegacyFilter poiFilter=app.getPoiFilters().getFilterById(filterId);
  if (poiFilter == null) {
    poiFilter=new PoiLegacyFilter(null,app);
  }
  mapLayers.getPoiMapLayer().setFilter(poiFilter);
  TargetPointsHelper targets=app.getTargetPointsHelper();
  RoutingHelper routingHelper=app.getRoutingHelper();
  if (routingHelper.isFollowingMode() && (!Algorithms.objectEquals(targets.getPointToNavigate().point,routingHelper.getFinalLocation()) || !Algorithms.objectEquals(targets.getIntermediatePointsLatLon(),routingHelper.getIntermediatePoints()))) {
    targets.updateRouteAndReferesh(true);
  }
  app.getLocationProvider().resumeAllUpdates();
  if (settings != null && settings.isLastKnownMapLocation() && !intentLocation) {
    LatLon l=settings.getLastKnownMapLocation();
    mapView.setLatLon(l.getLatitude(),l.getLongitude());
    mapView.setIntZoom(settings.getLastKnownMapZoom());
  }
 else {
    intentLocation=false;
  }
  settings.MAP_ACTIVITY_ENABLED.set(true);
  checkExternalStorage();
  showAndHideMapPosition();
  LatLon cur=new LatLon(mapView.getLatitude(),mapView.getLongitude());
  LatLon latLonToShow=settings.getAndClearMapLocationToShow();
  PointDescription mapLabelToShow=settings.getAndClearMapLabelToShow();
  Object toShow=settings.getAndClearObjectToShow();
  int status=settings.isRouteToPointNavigateAndClear();
  if (status != 0) {
    Location loc=new Location("map");
    loc.setLatitude(mapView.getLatitude());
    loc.setLongitude(mapView.getLongitude());
    getMapActions().enterRoutePlanningMode(null,null,status == OsmandSettings.NAVIGATE_CURRENT_GPX);
  }
  if (mapLabelToShow != null && latLonToShow != null) {
    mapLayers.getContextMenuLayer().setSelectedObject(toShow);
    mapLayers.getContextMenuLayer().setLocation(latLonToShow,mapLabelToShow.getFullPlainName(this,latLonToShow.getLatitude(),latLonToShow.getLongitude()));
  }
  if (latLonToShow != null && !latLonToShow.equals(cur)) {
    mapView.getAnimatedDraggingThread().startMoving(latLonToShow.getLatitude(),latLonToShow.getLongitude(),settings.getMapZoomToShow(),true);
  }
  if (latLonToShow != null) {
    mapViewTrackingUtilities.setMapLinkedToLocation(false);
  }
  final Intent intent=getIntent();
  if (intent != null) {
    if (Intent.ACTION_VIEW.equals(intent.getAction())) {
      if (intent.getData() != null) {
        final Uri data=intent.getData();
        final String scheme=data.getScheme();
        if ("file".equals(scheme)) {
          gpxImportHelper.handleFileImport(data,new File(data.getPath()).getName());
          setIntent(null);
        }
 else         if ("content".equals(scheme)) {
          gpxImportHelper.handleContenImport(data);
          setIntent(null);
        }
 else         if ("google.navigation".equals(scheme) || "osmand.navigation".equals(scheme)) {
          final String schemeSpecificPart=data.getSchemeSpecificPart();
          final Matcher matcher=Pattern.compile("(?:q|ll)=([\\-0-9.]+),([\\-0-9.]+)(?:.*)").matcher(schemeSpecificPart);
          if (matcher.matches()) {
            try {
              final double lat=Double.valueOf(matcher.group(1));
              final double lon=Double.valueOf(matcher.group(2));
              getMyApplication().getTargetPointsHelper().navigateToPoint(new LatLon(lat,lon),false,-1);
              getMapActions().enterRoutePlanningMode(null,null,false);
            }
 catch (            NumberFormatException e) {
              AccessibleToast.makeText(this,getString(R.string.navigation_intent_invalid,schemeSpecificPart),Toast.LENGTH_LONG).show();
            }
          }
 else {
            AccessibleToast.makeText(this,getString(R.string.navigation_intent_invalid,schemeSpecificPart),Toast.LENGTH_LONG).show();
          }
          setIntent(null);
        }
      }
    }
  }
  View progress=mapLayers.getMapInfoLayer().getProgressBar();
  if (progress != null) {
    app.getResourceManager().setBusyIndicator(new BusyIndicator(this,progress));
  }
  OsmandPlugin.onMapActivityResume(this);
  mapView.refreshMap(true);
  if (atlasMapRendererView != null) {
    atlasMapRendererView.handleOnResume();
  }
  getMyApplication().getAppCustomization().resumeActivity(MapActivity.class,this);
}
