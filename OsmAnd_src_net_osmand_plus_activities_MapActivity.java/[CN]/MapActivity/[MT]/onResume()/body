{
  super.onResume();
  cancelNotification();
  if (settings.MAP_SCREEN_ORIENTATION.get() != getRequestedOrientation()) {
    setRequestedOrientation(settings.MAP_SCREEN_ORIENTATION.get());
  }
  net.osmand.Location loc=getLastKnownLocation();
  if (loc != null && (System.currentTimeMillis() - loc.getTime()) > 30 * 1000) {
    setLocation(null);
  }
  currentScreenOrientation=getWindow().getWindowManager().getDefaultDisplay().getOrientation();
  if (settings.AUDIO_STREAM_GUIDANCE.get() != null) {
    setVolumeControlStream(settings.AUDIO_STREAM_GUIDANCE.get());
  }
 else {
    setVolumeControlStream(AudioManager.STREAM_MUSIC);
  }
  updateApplicationModeSettings();
  String filterId=settings.getPoiFilterForMap();
  PoiFilter poiFilter=getMyApplication().getPoiFilters().getFilterById(filterId);
  if (poiFilter == null) {
    poiFilter=new PoiFilter(null,getMyApplication());
  }
  mapLayers.getPoiMapLayer().setFilter(poiFilter);
  mapLayers.getMapInfoLayer().getBackToLocation().setEnabled(false);
  TargetPointsHelper targets=getTargetPoints();
  if (routingHelper.isFollowingMode() && (!Algoritms.objectEquals(targets.getPointToNavigate(),routingHelper.getFinalLocation()) || !Algoritms.objectEquals(targets.getIntermediatePoints(),routingHelper.getIntermediatePoints()))) {
    routingHelper.setFinalAndCurrentLocation(targets.getPointToNavigate(),targets.getIntermediatePoints(),getLastKnownLocation(),routingHelper.getCurrentGPXRoute());
  }
  startLocationRequests();
  if (settings != null && settings.isLastKnownMapLocation()) {
    LatLon l=settings.getLastKnownMapLocation();
    mapView.setLatLon(l.getLatitude(),l.getLongitude());
    mapView.setZoom(settings.getLastKnownMapZoom());
  }
  settings.MAP_ACTIVITY_ENABLED.set(true);
  checkExternalStorage();
  showAndHideMapPosition();
  LatLon cur=new LatLon(mapView.getLatitude(),mapView.getLongitude());
  LatLon latLonToShow=settings.getAndClearMapLocationToShow();
  String mapLabelToShow=settings.getAndClearMapLabelToShow();
  Object toShow=settings.getAndClearObjectToShow();
  if (settings.isRouteToPointNavigateAndClear()) {
    mapActions.getDirections(null,null,false);
  }
  if (mapLabelToShow != null && latLonToShow != null) {
    mapLayers.getContextMenuLayer().setSelectedObject(toShow);
    mapLayers.getContextMenuLayer().setLocation(latLonToShow,mapLabelToShow);
  }
  if (latLonToShow != null && !latLonToShow.equals(cur)) {
    mapView.getAnimatedDraggingThread().startMoving(latLonToShow.getLatitude(),latLonToShow.getLongitude(),settings.getMapZoomToShow(),true);
  }
  if (latLonToShow != null) {
    setMapLinkedToLocation(false);
  }
 else {
    setMapLinkedToLocation(isMapLinkedToLocation);
  }
  View progress=mapLayers.getMapInfoLayer().getProgressBar();
  if (progress != null) {
    getMyApplication().getResourceManager().setBusyIndicator(new BusyIndicator(this,progress));
  }
  OsmandPlugin.onMapActivityResume(this);
  getMyApplication().getDaynightHelper().onMapResume();
  mapView.refreshMap(true);
}
