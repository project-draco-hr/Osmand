{
  if (Log.isLoggable(LogUtil.TAG,Log.DEBUG)) {
    Log.d(LogUtil.TAG,"Location changed " + location.getProvider());
  }
  if (location != null) {
    if (!location.hasAccuracy() || location.getAccuracy() < ACCURACY_FOR_GPX_AND_ROUTING) {
      if (settings.SAVE_TRACK_TO_GPX.get()) {
        savingTrackHelper.insertData(location.getLatitude(),location.getLongitude(),location.getAltitude(),location.getSpeed(),location.getAccuracy(),location.getTime(),settings);
        if (settings.SHOW_CURRENT_GPX_TRACK.get()) {
          WptPt pt=new GPXUtilities.WptPt(location.getLatitude(),location.getLongitude(),location.getTime(),location.getAltitude(),location.getSpeed(),location.getAccuracy());
          mapLayers.getGpxLayer().addTrackPoint(pt);
        }
      }
    }
    if (settings.LIVE_MONITORING.get()) {
      liveMonitoringHelper.insertData(location.getLatitude(),location.getLongitude(),location.getAltitude(),location.getSpeed(),location.getAccuracy(),location.getTime(),settings);
    }
  }
  registerUnregisterSensor(location);
  updateSpeedBearing(location);
  mapLayers.getLocationLayer().setLastKnownLocation(location);
  navigationInfo.setLocation(location);
  if (routingHelper.isFollowingMode()) {
    if (location == null || !location.hasAccuracy() || location.getAccuracy() < ACCURACY_FOR_GPX_AND_ROUTING) {
      routingHelper.setCurrentLocation(location);
      if (location != null && routingHelper.getLeftDistance() > 0) {
        Message msg=Message.obtain(uiHandler,new Runnable(){
          @Override public void run(){
            if (routingHelper.getLeftDistance() > 0 && settings.MAP_ACTIVITY_ENABLED.get()) {
              routingHelper.getVoiceRouter().gpsLocationLost();
            }
          }
        }
);
        msg.what=LOST_LOCATION_MSG_ID;
        uiHandler.removeMessages(LOST_LOCATION_MSG_ID);
        uiHandler.sendMessageDelayed(msg,LOST_LOCATION_CHECK_DELAY);
      }
    }
  }
  if (location != null) {
    if (isMapLinkedToLocation()) {
      if (settings.AUTO_ZOOM_MAP.get() && location.hasSpeed()) {
        int z=defineZoomFromSpeed(location.getSpeed(),mapView.getZoom());
        if (mapView.getZoom() != z && !mapView.mapIsAnimating()) {
          long now=System.currentTimeMillis();
          if (Math.abs(mapView.getZoom() - z) > 1 || (now - lastTimeAutoZooming) > 6500) {
            lastTimeAutoZooming=now;
            mapView.setZoom(z);
          }
        }
      }
      int currentMapRotation=settings.ROTATE_MAP.get();
      if (location.hasBearing() && currentMapRotation == OsmandSettings.ROTATE_MAP_BEARING) {
        mapView.setRotate(-location.getBearing());
      }
      mapView.setLatLon(location.getLatitude(),location.getLongitude());
    }
 else {
      if (!mapLayers.getMapInfoLayer().getBackToLocation().isEnabled()) {
        mapLayers.getMapInfoLayer().getBackToLocation().setEnabled(true);
      }
      if (settings.AUTO_FOLLOW_ROUTE.get() > 0 && routingHelper.isFollowingMode() && !uiHandler.hasMessages(AUTO_FOLLOW_MSG_ID)) {
        backToLocationWithDelay(1);
      }
    }
  }
 else {
    if (mapLayers.getMapInfoLayer().getBackToLocation().isEnabled()) {
      mapLayers.getMapInfoLayer().getBackToLocation().setEnabled(false);
    }
  }
  mapView.refreshMap();
}
