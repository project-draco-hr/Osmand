{
  PointLocationLayer locationLayer=mapLayers.getLocationLayer();
  if (isRunningOnEmulator() && locationLayer.getLastKnownLocation() != null) {
    if (locationLayer.getLastKnownLocation().distanceTo(location) > 3) {
      float d=location.distanceTo(locationLayer.getLastKnownLocation());
      long time=location.getTime() - locationLayer.getLastKnownLocation().getTime();
      float speed;
      if (time == 0) {
        speed=0;
      }
 else {
        speed=((float)d * 1000) / time;
      }
      if (speed > 100) {
        speed=100;
      }
      location.setSpeed(speed);
    }
  }
  if (locationLayer.getLastKnownLocation() != null && location.hasBearing()) {
    if (locationLayer.getLastKnownLocation().distanceTo(location) > 10 && !isRunningOnEmulator()) {
      location.setBearing(locationLayer.getLastKnownLocation().bearingTo(location));
    }
  }
}
