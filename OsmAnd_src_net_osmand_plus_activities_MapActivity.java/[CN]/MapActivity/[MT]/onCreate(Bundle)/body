{
  super.onCreate(savedInstanceState);
  settings=getMyApplication().getSettings();
  requestWindowFeature(Window.FEATURE_NO_TITLE);
  setContentView(R.layout.main);
  startProgressDialog=new ProgressDialog(this);
  startProgressDialog.setCancelable(true);
  ((OsmandApplication)getApplication()).checkApplicationIsBeingInitialized(this,startProgressDialog);
  startProgressDialog.setOnDismissListener(new DialogInterface.OnDismissListener(){
    @Override public void onDismiss(    DialogInterface dialog){
      OsmandApplication app=((OsmandApplication)getApplication());
      if (settings.MAP_VECTOR_DATA.get() && app.getResourceManager().getRenderer().isEmpty()) {
        Toast.makeText(MapActivity.this,getString(R.string.no_vector_map_loaded),Toast.LENGTH_LONG).show();
      }
    }
  }
);
  parseLaunchIntentLocation();
  mapView=(OsmandMapTileView)findViewById(R.id.MapView);
  mapView.setTrackBallDelegate(new OsmandMapTileView.OnTrackBallListener(){
    @Override public boolean onTrackBallEvent(    MotionEvent e){
      showAndHideMapPosition();
      return MapActivity.this.onTrackballEvent(e);
    }
  }
);
  MapTileDownloader.getInstance().addDownloaderCallback(new IMapDownloaderCallback(){
    @Override public void tileDownloaded(    DownloadRequest request){
      if (request != null && !request.error && request.fileToSave != null) {
        ResourceManager mgr=getMyApplication().getResourceManager();
        mgr.tileDownloaded(request);
      }
      mapView.tileDownloaded(request);
    }
  }
);
  savingTrackHelper=new SavingTrackHelper(this);
  routingHelper=getMyApplication().getRoutingHelper();
  routingHelper.getVoiceRouter().onActivityInit(this);
  LatLon pointToNavigate=settings.getPointToNavigate();
  if (!Algoritms.objectEquals(routingHelper.getFinalLocation(),pointToNavigate)) {
    routingHelper.setFollowingMode(false);
    routingHelper.setFinalAndCurrentLocation(pointToNavigate,null);
  }
  if (settings.FOLLOW_TO_THE_ROUTE.get()) {
    if (pointToNavigate == null) {
      settings.FOLLOW_TO_THE_ROUTE.set(false);
    }
 else     if (!routingHelper.isRouteCalculated()) {
      Builder builder=new AlertDialog.Builder(this);
      builder.setMessage(R.string.continue_follow_previous_route);
      builder.setPositiveButton(R.string.default_buttons_yes,new DialogInterface.OnClickListener(){
        @Override public void onClick(        DialogInterface dialog,        int which){
          routingHelper.setFollowingMode(true);
          getMyApplication().showDialogInitializingCommandPlayer(MapActivity.this);
        }
      }
);
      builder.setNegativeButton(R.string.default_buttons_no,new DialogInterface.OnClickListener(){
        @Override public void onClick(        DialogInterface dialog,        int which){
          settings.FOLLOW_TO_THE_ROUTE.set(false);
          settings.APPLICATION_MODE.set(ApplicationMode.DEFAULT);
          updateApplicationModeSettings();
          routingHelper.setFinalLocation(null);
          mapView.refreshMap();
        }
      }
);
      builder.show();
    }
  }
  mapView.setMapLocationListener(this);
  mapLayers.createLayers(mapView);
  if (!settings.isLastKnownMapLocation()) {
    LocationManager service=(LocationManager)getSystemService(LOCATION_SERVICE);
    Location location=null;
    try {
      location=service.getLastKnownLocation(LocationManager.GPS_PROVIDER);
    }
 catch (    IllegalArgumentException e) {
      Log.d(LogUtil.TAG,"GPS location provider not available");
    }
    if (location == null) {
      try {
        location=service.getLastKnownLocation(LocationManager.NETWORK_PROVIDER);
      }
 catch (      IllegalArgumentException e) {
        Log.d(LogUtil.TAG,"Network location provider not available");
      }
    }
    if (location != null) {
      mapView.setLatLon(location.getLatitude(),location.getLongitude());
      mapView.setZoom(14);
    }
  }
  backToLocation=(ImageButton)findViewById(R.id.BackToLocation);
  backToLocation.setOnClickListener(new OnClickListener(){
    @Override public void onClick(    View v){
      backToLocationImpl();
    }
  }
);
}
