{
  app=getMyApplication();
  settings=app.getSettings();
  app.applyTheme(this);
  super.onCreate(savedInstanceState);
  mapActions=new MapActivityActions(this);
  mapLayers=new MapActivityLayers(this);
  requestWindowFeature(Window.FEATURE_NO_TITLE);
  startProgressDialog=new ProgressDialog(this);
  startProgressDialog.setCancelable(true);
  app.checkApplicationIsBeingInitialized(this,startProgressDialog);
  parseLaunchIntentLocation();
  if (settings.USE_NATIVE_RENDER.get()) {
    setContentView(R.layout.activity_gl);
    mapViewController=new NativeViewController((GLSurfaceView)findViewById(R.id.glSurfaceView),this);
  }
 else {
    setContentView(R.layout.main);
    mapViewController=new JavaViewController((OsmandMapTileView)findViewById(R.id.MapView),this);
  }
  mapViewController.setTrackBallDelegate(new JavaViewController.OnTrackBallListener(){
    @Override public boolean onTrackBallEvent(    MotionEvent e){
      showAndHideMapPosition();
      return MapActivity.this.onTrackballEvent(e);
    }
  }
);
  mapViewController.setAccessibilityActions(new MapAccessibilityActions(this));
  if (mapViewTrackingUtilities == null) {
    mapViewTrackingUtilities=new MapViewTrackingUtilities(app);
  }
  mapViewController.setTrackingUtilities(mapViewTrackingUtilities);
  startProgressDialog.setOnDismissListener(new DialogInterface.OnDismissListener(){
    @Override public void onDismiss(    DialogInterface dialog){
      app.getResourceManager().getRenderer().clearCache();
      mapViewController.refreshMap(true);
    }
  }
);
  app.getResourceManager().getMapTileDownloader().addDownloaderCallback(new IMapDownloaderCallback(){
    @Override public void tileDownloaded(    DownloadRequest request){
      if (request != null && !request.error && request.fileToSave != null) {
        ResourceManager mgr=app.getResourceManager();
        mgr.tileDownloaded(request);
      }
      if (request == null || !request.error) {
        mapViewController.tileDownloaded(request);
      }
    }
  }
);
  createProgressBarForRouting();
  mapViewController.createLayers(mapLayers);
  if (settings.FOLLOW_THE_ROUTE.get() && !app.getRoutingHelper().isRouteCalculated() && !app.getRoutingHelper().isRouteBeingCalculated()) {
    FailSafeFuntions.restoreRoutingMode(this);
  }
  if (!settings.isLastKnownMapLocation()) {
    net.osmand.Location location=app.getLocationProvider().getFirstTimeRunDefaultLocation();
    if (location != null) {
      mapViewController.setLatLon(location.getLatitude(),location.getLongitude());
      mapViewController.setIntZoom(14);
    }
  }
  addDialogProvider(mapActions);
  OsmandPlugin.onMapActivityCreate(this);
  if (lockView != null) {
    mapViewController.addView(lockView);
  }
  gpxImportHelper=new GpxImportHelper(this,getMyApplication(),getMapView());
}
