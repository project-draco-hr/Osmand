{
  long tm=System.currentTimeMillis();
  app=getMyApplication();
  settings=app.getSettings();
  app.applyTheme(this);
  supportRequestWindowFeature(Window.FEATURE_NO_TITLE);
  super.onCreate(savedInstanceState);
  setContentView(R.layout.main);
  mapActions=new MapActivityActions(this);
  mapLayers=new MapActivityLayers(this);
  dashboardOnMap=new DashboardOnMap(this);
  dashboardOnMap.createDashboardView();
  if (app.isApplicationInitializing()) {
    dashboardOnMap.setDashboardVisibility(true);
    findViewById(R.id.init_progress).setVisibility(View.VISIBLE);
    initListener=new AppInitializeListener(){
      @Override public void onProgress(      AppInitializer init,      InitEvents event){
        String tn=init.getCurrentInitTaskName();
        if (tn != null) {
          ((TextView)findViewById(R.id.ProgressMessage)).setText(tn);
        }
        if (event == InitEvents.MAPS_INITIALIZED) {
          mapView.refreshMap(true);
        }
      }
      @Override public void onFinish(      AppInitializer init){
        applicationInitialized();
        mapView.refreshMap();
      }
    }
;
    getMyApplication().checkApplicationIsBeingInitialized(this,initListener);
  }
  parseLaunchIntentLocation();
  if (settings.USE_OPENGL_RENDER.get() && NativeCoreContext.isInit()) {
    ViewStub stub=(ViewStub)findViewById(R.id.atlasMapRendererViewStub);
    atlasMapRendererView=(AtlasMapRendererView)stub.inflate();
    OsmAndMapLayersView ml=(OsmAndMapLayersView)findViewById(R.id.MapLayersView);
    ml.setVisibility(View.VISIBLE);
    atlasMapRendererView.setAzimuth(0);
    atlasMapRendererView.setElevationAngle(90);
    NativeCoreContext.getMapRendererContext().setMapRendererView(atlasMapRendererView);
    mapView=ml.getMapView();
    mapView.setMapRender(atlasMapRendererView);
  }
 else {
    OsmAndMapSurfaceView surf=(OsmAndMapSurfaceView)findViewById(R.id.MapView);
    surf.setVisibility(View.VISIBLE);
    mapView=surf.getMapView();
  }
  mapView.setTrackBallDelegate(new OsmandMapTileView.OnTrackBallListener(){
    @Override public boolean onTrackBallEvent(    MotionEvent e){
      showAndHideMapPosition();
      return MapActivity.this.onTrackballEvent(e);
    }
  }
);
  mapView.setAccessibilityActions(new MapAccessibilityActions(this));
  if (mapViewTrackingUtilities == null) {
    mapViewTrackingUtilities=new MapViewTrackingUtilities(app);
  }
  mapViewTrackingUtilities.setMapView(mapView);
  app.getResourceManager().getMapTileDownloader().addDownloaderCallback(new IMapDownloaderCallback(){
    @Override public void tileDownloaded(    DownloadRequest request){
      if (request != null && !request.error && request.fileToSave != null) {
        ResourceManager mgr=app.getResourceManager();
        mgr.tileDownloaded(request);
      }
      if (request == null || !request.error) {
        mapView.tileDownloaded(request);
      }
    }
  }
);
  createProgressBarForRouting();
  mapLayers.createLayers(mapView);
  if (settings.FOLLOW_THE_ROUTE.get() && !app.getRoutingHelper().isRouteCalculated() && !app.getRoutingHelper().isRouteBeingCalculated()) {
    FailSafeFuntions.restoreRoutingMode(this);
  }
  if (!settings.isLastKnownMapLocation()) {
    net.osmand.Location location=app.getLocationProvider().getFirstTimeRunDefaultLocation();
    if (location != null) {
      mapView.setLatLon(location.getLatitude(),location.getLongitude());
      mapView.setIntZoom(14);
    }
  }
  addDialogProvider(mapActions);
  OsmandPlugin.onMapActivityCreate(this);
  if (lockView != null) {
    ((FrameLayout)mapView.getParent()).addView(lockView);
  }
  gpxImportHelper=new GpxImportHelper(this,getMyApplication(),getMapView());
  mapActions.prepareStartOptionsMenu();
  wakeLockHelper=new WakeLockHelper(getMyApplication());
  if (System.currentTimeMillis() - tm > 50) {
    System.err.println("OnCreate for MapActivity took " + (System.currentTimeMillis() - tm) + " ms");
  }
}
