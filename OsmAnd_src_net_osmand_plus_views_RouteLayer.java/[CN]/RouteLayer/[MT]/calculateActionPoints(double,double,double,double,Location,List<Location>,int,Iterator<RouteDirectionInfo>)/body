{
  RouteDirectionInfo nf=null;
  double DISTANCE_ACTION=35;
  double actionDist=0;
  Location previousAction=null;
  actionPoints.clear();
  for (int i=0; i < routeNodes.size(); i++) {
    Location ls=routeNodes.get(i);
    if (nf != null && nf.routePointOffset < i + cd) {
      nf=null;
    }
    while (nf == null && it.hasNext()) {
      nf=it.next();
      if (nf.routePointOffset < i + cd) {
        nf=null;
      }
    }
    boolean action=nf != null && nf.routePointOffset == i + cd;
    if (!action && previousAction == null) {
      continue;
    }
    boolean visible=leftLongitude <= ls.getLongitude() && ls.getLongitude() <= rightLongitude && bottomLatitude <= ls.getLatitude() && ls.getLatitude() <= topLatitude;
    if (!action) {
      if (previousAction != null) {
        float loc=ls.distanceTo(previousAction);
        actionDist+=loc;
        if (actionDist >= DISTANCE_ACTION) {
          actionPoints.add(calculateProjection(1 - (actionDist - DISTANCE_ACTION) / loc,previousAction,ls));
          actionPoints.add(null);
          previousAction=null;
          actionDist=0;
        }
 else {
          actionPoints.add(ls);
          previousAction=ls;
        }
      }
    }
 else {
      if (visible) {
        int ind=actionPoints.size();
        actionPoints.add(ls);
        if (previousAction == null) {
          Location lp=ls;
          double dist=0;
          for (int k=i - 1; k >= -1; k--) {
            Location l=k == -1 ? lastProjection : routeNodes.get(k);
            float loc=lp.distanceTo(l);
            dist+=loc;
            if (dist >= DISTANCE_ACTION) {
              if (loc > 1) {
                actionPoints.add(ind,calculateProjection(1 - (dist - DISTANCE_ACTION) / loc,lp,l));
              }
              break;
            }
 else {
              actionPoints.add(ind,l);
              lp=l;
            }
          }
        }
        previousAction=ls;
        actionDist=0;
      }
    }
  }
}
