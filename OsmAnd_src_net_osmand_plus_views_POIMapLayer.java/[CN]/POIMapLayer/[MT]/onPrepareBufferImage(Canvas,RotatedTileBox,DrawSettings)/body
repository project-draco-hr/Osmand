{
  if (!Algorithms.objectEquals(this.settings.SELECTED_POI_FILTER_FOR_MAP.get(),filter == null ? null : filter.getFilterId())) {
    if (this.settings.SELECTED_POI_FILTER_FOR_MAP.get() == null) {
      this.filter=null;
    }
 else {
      PoiFiltersHelper pfh=app.getPoiFilters();
      this.filter=pfh.getFilterById(this.settings.SELECTED_POI_FILTER_FOR_MAP.get());
    }
    data.clearCache();
  }
  List<Amenity> objects=Collections.emptyList();
  if (filter != null) {
    if (tileBox.getZoom() >= startZoom) {
      data.queryNewData(tileBox);
      objects=data.getResults();
      if (objects != null) {
        int iconSize=poiBackground.getWidth() * 3 / 2;
        List<Amenity> fullObjects=new ArrayList<>();
        QuadRect bounds=new QuadRect(0,0,tileBox.getPixWidth(),tileBox.getPixHeight());
        QuadTree<RectF> boundIntersections=new QuadTree<RectF>(bounds,4,0.6f);
        List<RectF> result=new ArrayList<RectF>();
        for (        Amenity o : objects) {
          int x=(int)tileBox.getPixXFromLatLon(o.getLocation().getLatitude(),o.getLocation().getLongitude());
          int y=(int)tileBox.getPixYFromLatLon(o.getLocation().getLatitude(),o.getLocation().getLongitude());
          boolean intersects=false;
          RectF visibleRect=calculateRect(x,y,iconSize,iconSize);
          boundIntersections.queryInBox(new QuadRect(visibleRect.left,visibleRect.top,visibleRect.right,visibleRect.bottom),result);
          for (          RectF r : result) {
            if (r.intersects(visibleRect.left,visibleRect.top,visibleRect.right,visibleRect.bottom)) {
              intersects=true;
              break;
            }
          }
          if (intersects) {
            canvas.drawBitmap(poiBackgroundSmall,x - poiBackgroundSmall.getWidth() / 2,y - poiBackgroundSmall.getHeight() / 2,paintIconBackground);
          }
 else {
            boundIntersections.insert(visibleRect,new QuadRect(visibleRect.left,visibleRect.top,visibleRect.right,visibleRect.bottom));
            fullObjects.add(o);
          }
        }
        for (        Amenity o : fullObjects) {
          int x=(int)tileBox.getPixXFromLatLon(o.getLocation().getLatitude(),o.getLocation().getLongitude());
          int y=(int)tileBox.getPixYFromLatLon(o.getLocation().getLatitude(),o.getLocation().getLongitude());
          canvas.drawBitmap(poiBackground,x - poiBackground.getWidth() / 2,y - poiBackground.getHeight() / 2,paintIconBackground);
          String id=null;
          PoiType st=o.getType().getPoiTypeByKeyName(o.getSubType());
          if (st != null) {
            if (RenderingIcons.containsSmallIcon(st.getIconKeyName())) {
              id=st.getIconKeyName();
            }
 else             if (RenderingIcons.containsSmallIcon(st.getOsmTag() + "_" + st.getOsmValue())) {
              id=st.getOsmTag() + "_" + st.getOsmValue();
            }
          }
          if (id != null) {
            Bitmap bmp=RenderingIcons.getIcon(view.getContext(),id,false);
            if (bmp != null) {
              paintIcon.setColorFilter(new PorterDuffColorFilter(Color.WHITE,PorterDuff.Mode.SRC_IN));
              canvas.drawBitmap(bmp,x - bmp.getWidth() / 2,y - bmp.getHeight() / 2,paintIcon);
            }
          }
        }
      }
    }
  }
  mapTextLayer.putData(this,objects);
}
