{
  float val=0;
switch (event.sensor.getType()) {
case Sensor.TYPE_ACCELEROMETER:
    if (mGravs == null) {
      mGravs=new float[3];
    }
  System.arraycopy(event.values,0,mGravs,0,3);
break;
case Sensor.TYPE_MAGNETIC_FIELD:
if (mGeoMags == null) {
mGeoMags=new float[3];
}
System.arraycopy(event.values,0,mGeoMags,0,3);
break;
case Sensor.TYPE_ORIENTATION:
val=event.values[0];
if (mGravs != null && mGeoMags != null) {
return;
}
break;
default :
return;
}
if (mGravs != null && mGeoMags != null) {
float[] mRotationM=new float[9];
boolean success=SensorManager.getRotationMatrix(mRotationM,null,mGravs,mGeoMags);
if (!success) {
return;
}
float[] orientation=SensorManager.getOrientation(mRotationM,new float[3]);
val=(float)Math.toDegrees(orientation[0]);
}
 else if (event.sensor.getType() != Sensor.TYPE_ORIENTATION) {
return;
}
if (currentScreenOrientation == 1) {
val+=90;
}
 else if (currentScreenOrientation == 2) {
val+=180;
}
 else if (currentScreenOrientation == 3) {
val-=90;
}
if (previousCorrectionValue == 360 && getLastKnownLocation() != null) {
net.osmand.Location l=getLastKnownLocation();
GeomagneticField gf=new GeomagneticField((float)l.getLatitude(),(float)l.getLongitude(),(float)l.getAltitude(),System.currentTimeMillis());
previousCorrectionValue=gf.getDeclination();
}
if (previousCorrectionValue != 360) {
val+=previousCorrectionValue;
}
val=MapUtils.unifyRotationTo360(val);
if (previousCompassValuesAvg == 0 && previousCompassInd == 0) {
Arrays.fill(previousCompassValues,val);
previousCompassValuesAvg=val;
}
 else {
if (USE_KALMAN_FILTER) {
previousCompassValuesAvg=KALMAN_COEFFICIENT * val + previousCompassValuesAvg * (1 - KALMAN_COEFFICIENT);
}
 else {
int l=previousCompassValues.length;
previousCompassInd=(previousCompassInd + 1) % l;
previousCompassValuesAvg=previousCompassValuesAvg + (-previousCompassValues[previousCompassInd] + val) / l;
previousCompassValues[previousCompassInd]=val;
previousCompassValuesAvg=MapUtils.unifyRotationTo360(previousCompassValuesAvg);
}
}
heading=previousCompassValuesAvg;
updateCompassValue(heading.floatValue());
}
