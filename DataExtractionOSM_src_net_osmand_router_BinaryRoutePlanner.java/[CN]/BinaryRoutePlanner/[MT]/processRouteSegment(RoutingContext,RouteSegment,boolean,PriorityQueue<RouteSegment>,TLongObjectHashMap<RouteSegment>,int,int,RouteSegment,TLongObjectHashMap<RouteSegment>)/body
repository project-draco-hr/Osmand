{
  final RouteDataObject road=segment.road;
  final int middle=segment.segmentStart;
  int middlex=road.getPoint31XTile(middle);
  int middley=road.getPoint31YTile(middle);
  long nt=(road.getId() << 8l) + middle;
  visitedSegments.put(nt,null);
  if (oppositeSegments.contains(nt) && oppositeSegments.get(nt) != null) {
    segment.segmentEnd=middle;
    RouteSegment opposite=oppositeSegments.get(nt);
    opposite.segmentEnd=middle;
    return new RoutePair(segment,opposite);
  }
  int oneway=ctx.getRouter().isOneWay(road);
  boolean minusAllowed;
  boolean plusAllowed;
  if (!reverseWaySearch) {
    minusAllowed=oneway <= 0;
    plusAllowed=oneway >= 0;
  }
 else {
    minusAllowed=oneway >= 0;
    plusAllowed=oneway <= 0;
  }
  int d=plusAllowed ? 1 : -1;
  while (minusAllowed || plusAllowed) {
    int segmentEnd=middle + d;
    if (!minusAllowed && d > 0) {
      d++;
    }
 else     if (!plusAllowed && d < 0) {
      d--;
    }
 else {
      if (d <= 0) {
        d=-d + 1;
      }
 else {
        d=-d;
      }
    }
    if (segmentEnd < 0) {
      minusAllowed=false;
      continue;
    }
    if (segmentEnd >= road.getPointsLength()) {
      plusAllowed=false;
      continue;
    }
    long nts=(road.getId() << 8l) + segmentEnd;
    if (oppositeSegments.contains(nts) && oppositeSegments.get(nt) != null) {
      segment.segmentEnd=segmentEnd;
      RouteSegment opposite=oppositeSegments.get(nts);
      opposite.segmentEnd=segmentEnd;
      return new RoutePair(segment,opposite);
    }
    visitedSegments.put(nts,segment);
    int x=road.getPoint31XTile(segmentEnd);
    int y=road.getPoint31YTile(segmentEnd);
    loadRoutes(ctx,x,y,null);
    long l=(((long)x) << 31) + (long)y;
    RouteSegment next=ctx.routes.get(l);
    if (next != null) {
      double distOnRoadToPass=squareRootDist(x,y,middlex,middley);
      double distToFinalPoint=squareRootDist(x,y,targetEndX,targetEndY);
      RouteSegment foundIntersection=processIntersectionsWithWays(ctx,graphSegments,visitedSegments,oppositeSegments,distOnRoadToPass,distToFinalPoint,segment,road,d == 0,segmentEnd,next,reverseWaySearch);
      if (foundIntersection != null) {
        segment.segmentEnd=segmentEnd;
        return new RoutePair(segment,foundIntersection);
      }
    }
  }
  return null;
}
