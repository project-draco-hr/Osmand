{
  String title="";
  if (preference.getKey() != null && preference instanceof PreferenceScreen && SettingsActivity.SCREEN_ID_NAVIGATION_SETTINGS.equals(preference.getKey())) {
    final ApplicationMode appMode=osmandSettings.getApplicationMode();
    PreferenceScreen scr=(PreferenceScreen)preference;
    title=scr.getTitle().toString();
    if (title.startsWith("-")) {
      title=title.substring(1);
    }
    Builder builder=new AlertDialog.Builder(this);
    View view=getLayoutInflater().inflate(R.layout.calculate_route,null);
    builder.setView(view);
    final AlertDialog dlg=builder.show();
    final ToggleButton[] buttons=new ToggleButton[ApplicationMode.values().length];
    buttons[ApplicationMode.CAR.ordinal()]=(ToggleButton)view.findViewById(R.id.CarButton);
    buttons[ApplicationMode.BICYCLE.ordinal()]=(ToggleButton)view.findViewById(R.id.BicycleButton);
    buttons[ApplicationMode.PEDESTRIAN.ordinal()]=(ToggleButton)view.findViewById(R.id.PedestrianButton);
    for (int i=0; i < buttons.length; i++) {
      if (buttons[i] != null) {
        final int ind=i;
        ToggleButton b=buttons[i];
        b.setChecked(appMode == ApplicationMode.values()[i]);
        b.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener(){
          @Override public void onCheckedChanged(          CompoundButton buttonView,          boolean isChecked){
            if (isChecked) {
              for (int j=0; j < buttons.length; j++) {
                if (buttons[j] != null) {
                  if (buttons[j].isChecked() != (ind == j)) {
                    buttons[j].setChecked(ind == j);
                  }
                }
              }
            }
 else {
              boolean revert=true;
              for (int j=0; j < buttons.length; j++) {
                if (buttons[j] != null) {
                  if (buttons[j].isChecked()) {
                    revert=false;
                    break;
                  }
                }
              }
              if (revert) {
                buttons[ind].setChecked(true);
              }
            }
            dlg.dismiss();
          }
        }
);
      }
    }
    scr.getDialog().setTitle("   " + title + " ["+ osmandSettings.APPLICATION_MODE.get().toHumanString(this)+ "]");
    scr.getDialog().setOnDismissListener(new OnDismissListener(){
      @Override public void onDismiss(      DialogInterface dialog){
        osmandSettings.APPLICATION_MODE.set(appMode);
      }
    }
);
  }
 else   if (preference instanceof PreferenceScreen) {
    final PreferenceScreen scr=(PreferenceScreen)preference;
    title=scr.getTitle().toString();
    scr.getDialog().setTitle("   " + title);
  }
  if (preference instanceof PreferenceScreen) {
    final PreferenceScreen scr=(PreferenceScreen)preference;
    CustomTitleBarView titleBar=new CustomTitleBarView(title,R.drawable.tab_settings_screen_icon,null){
      @Override public void backPressed(){
        scr.getDialog().dismiss();
      }
    }
;
    View titleView=getLayoutInflater().inflate(titleBar.getTitleBarLayout(),null);
    titleBar.init(titleView);
    View dv=scr.getDialog().getWindow().getDecorView();
    ListView ls=(ListView)dv.findViewById(android.R.id.list);
    if (ls != null) {
      ls.addFooterView(titleView);
    }
  }
  if (preference == applicationDir) {
    return true;
  }
  return super.onPreferenceTreeClick(preferenceScreen,preference);
}
