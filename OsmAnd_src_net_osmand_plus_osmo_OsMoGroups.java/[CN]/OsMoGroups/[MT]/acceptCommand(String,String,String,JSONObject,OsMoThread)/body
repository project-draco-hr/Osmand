{
  boolean processed=false;
  String operation=command + ":" + gid;
  OsMoGroup group=null;
  if (command.equalsIgnoreCase("GP")) {
    group=storage.getGroup(gid);
    if (group != null) {
      List<OsMoDevice> delta=mergeGroup(group,obj,false);
      String mygid=service.getMyGroupTrackerId();
      StringBuilder b=new StringBuilder();
      for (      OsMoDevice d : delta) {
        if (d.getDeletedTimestamp() != 0 && d.isEnabled()) {
          if (group.name != null && !d.getTrackerId().equals(mygid)) {
            b.append(app.getString(R.string.osmo_user_left,d.getVisibleName(),group.getVisibleName(app))).append("\n");
          }
          disconnectImpl(d);
        }
 else         if (!d.isActive()) {
          if (group.name != null && !d.getTrackerId().equals(mygid)) {
            b.append(app.getString(R.string.osmo_user_joined,d.getVisibleName(),group.getVisibleName(app))).append("\n");
          }
          connectDeviceImpl(d);
        }
      }
      if (b.length() > 0 && app.getSettings().OSMO_SHOW_GROUP_NOTIFICATIONS.get()) {
        app.showToastMessage(b.toString().trim());
      }
      storage.save();
    }
    processed=true;
  }
 else   if (command.equalsIgnoreCase("GROUP_DISCONNECT")) {
    group=storage.getGroup(gid);
    if (group != null) {
      disconnectAllGroupUsers(group);
    }
    processed=true;
  }
 else   if (command.equalsIgnoreCase("GROUP_CONNECT")) {
    group=storage.getGroup(gid);
    if (group != null) {
      mergeGroup(group,obj,true);
      group.active=true;
      for (      OsMoDevice d : group.getGroupUsers(null)) {
        if (d.isEnabled()) {
          d.active=false;
          connectDeviceImpl(d);
        }
      }
      storage.save();
    }
    processed=true;
  }
 else   if (command.equalsIgnoreCase("GROUP_CREATE") || command.equalsIgnoreCase("GROUP_JOIN")) {
    if (command.equalsIgnoreCase("GROUP_CREATE")) {
      operation=command;
      try {
        gid=obj.getString(GROUP_ID);
      }
 catch (      JSONException e) {
        e.printStackTrace();
        service.showErrorMessage(e.getMessage());
        return true;
      }
    }
    group=storage.getGroup(gid);
    if (group == null) {
      group=new OsMoGroup();
      group.groupId=gid;
      storage.addGroup(group);
    }
    connectGroupImpl(group);
    storage.save();
    processed=true;
  }
 else   if (command.equals("GROUP_LEAVE")) {
    group=storage.getGroup(gid);
    if (group != null) {
      storage.deleteGroup(group);
    }
    storage.save();
    processed=true;
  }
 else   if (command.equals("GROUP_GET_ALL")) {
    try {
      JSONArray arr=new JSONArray(data);
      int arrLength=arr.length();
      if (arrLength > 0) {
        Map<String,OsMoGroup> receivedGroups=new HashMap<String,OsMoGroupsStorage.OsMoGroup>();
        for (int i=0; i < arrLength; i++) {
          JSONObject o=arr.getJSONObject(i);
          OsMoGroup parsedGroup=parseGroup(o);
          receivedGroups.put(parsedGroup.getGroupId(),parsedGroup);
        }
        storage.mergeGroups(receivedGroups);
        storage.save();
      }
      processed=true;
      for (      OsMoGroup g : storage.getGroups()) {
        if (!g.isMainGroup() && g.isEnabled()) {
          connectGroupImpl(g);
        }
      }
    }
 catch (    JSONException e) {
      e.printStackTrace();
      service.showErrorMessage(e.getMessage());
      return processed;
    }
  }
 else   if (command.equals("DEVICE_GET_ALL")) {
    try {
      JSONArray arr=new JSONArray(data);
      int arrLength=arr.length();
      if (arrLength > 0) {
        OsMoGroup mainGroup=storage.getMainGroup();
        String mid=service.getMyTrackerId();
        Set<String> toDelete=new HashSet<String>(mainGroup.users.keySet());
        for (int i=0; i < arrLength; i++) {
          JSONObject o=arr.getJSONObject(i);
          OsMoDevice device=parseDevice(o);
          device.group=mainGroup;
          String trackerId=device.getTrackerId();
          if (!mid.equals(trackerId)) {
            if (toDelete.contains(trackerId)) {
              toDelete.remove(trackerId);
              OsMoDevice dv=mainGroup.users.get(trackerId);
              dv.serverColor=device.userColor;
              dv.serverName=device.userName;
            }
 else {
              mainGroup.users.put(trackerId,device);
            }
          }
        }
        for (        String id : toDelete) {
          mainGroup.users.remove(id);
        }
        storage.save();
        for (        OsMoDevice d : mainGroup.getGroupUsers(null)) {
          if (d.isEnabled() && !d.isActive()) {
            connectDeviceImpl(d);
          }
        }
      }
      processed=true;
    }
 catch (    JSONException e) {
      e.printStackTrace();
      service.showErrorMessage(e.getMessage());
      return processed;
    }
  }
 else   if (command.equals("SUBSCRIBE")) {
    OsMoGroup mainGroup=storage.getMainGroup();
    OsMoDevice device=mainGroup.users.get(gid);
    if (device != null) {
      if (OK.equals(data)) {
        connectDeviceImpl(device);
      }
 else {
        mainGroup.users.remove(gid);
        storage.save();
        if (obj == null) {
          app.showToastMessage(app.getString(R.string.osmo_device_not_found));
        }
      }
    }
    processed=true;
  }
 else   if (command.equals("UNSUBSCRIBE")) {
    OsMoGroup mainGroup=storage.getMainGroup();
    OsMoDevice device=mainGroup.users.get(gid);
    if (device != null) {
      mainGroup.users.remove(gid);
      storage.save();
    }
    if (!OK.equals(data)) {
      if (obj == null) {
        app.showToastMessage(app.getString(R.string.osmo_device_not_found));
      }
    }
    processed=true;
  }
  if (processed && uiListeners != null) {
    for (    OsMoGroupsUIListener listener : uiListeners) {
      listener.groupsListChange(operation,group);
    }
  }
  return processed;
}
