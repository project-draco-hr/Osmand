{
  if (req.tileId == null || req.dirWithTiles == null) {
    return null;
  }
  if (cacheOfImages.size() > maxImgCacheSize) {
    clearTiles();
  }
  if (req.dirWithTiles.canRead() && !downloader.isFileCurrentlyDownloaded(req.fileToSave)) {
    long time=System.currentTimeMillis();
    Bitmap bmp=null;
    if (req.tileSource instanceof SQLiteTileSource) {
      bmp=((SQLiteTileSource)req.tileSource).getImage(req.xTile,req.yTile,req.zoom);
    }
 else {
      File en=new File(req.dirWithTiles,req.tileId);
      if (en.exists()) {
        try {
          bmp=BitmapFactory.decodeFile(en.getAbsolutePath());
        }
 catch (        OutOfMemoryError e) {
          log.error("Out of memory error",e);
          clearTiles();
        }
      }
    }
    if (bmp != null) {
      cacheOfImages.put(req.tileId,bmp);
      if (log.isDebugEnabled()) {
        log.debug("Loaded file : " + req.tileId + " "+ -(time - System.currentTimeMillis())+ " ms "+ cacheOfImages.size());
      }
    }
    if (cacheOfImages.get(req.tileId) == null && req.url != null) {
      downloader.requestToDownload(req);
    }
  }
  return cacheOfImages.get(req.tileId);
}
