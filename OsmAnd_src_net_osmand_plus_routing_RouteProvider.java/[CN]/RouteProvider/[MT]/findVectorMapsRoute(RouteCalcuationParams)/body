{
  OsmandApplication app=(OsmandApplication)params.ctx.getApplicationContext();
  BinaryMapIndexReader[] files=app.getResourceManager().getRoutingMapFiles();
  BinaryRoutePlanner router=new BinaryRoutePlanner();
  File routingXml=app.getSettings().extendOsmandPath(ResourceManager.ROUTING_XML);
  RoutingConfiguration.Builder config;
  if (routingXml.exists() && routingXml.canRead()) {
    try {
      config=RoutingConfiguration.parseFromInputStream(new FileInputStream(routingXml));
    }
 catch (    SAXException e) {
      throw new IllegalStateException(e);
    }
  }
 else {
    config=RoutingConfiguration.getDefault();
  }
  GeneralRouterProfile p;
  if (params.mode == ApplicationMode.BICYCLE) {
    p=GeneralRouterProfile.BICYCLE;
  }
 else   if (params.mode == ApplicationMode.PEDESTRIAN) {
    p=GeneralRouterProfile.PEDESTRIAN;
  }
 else {
    p=GeneralRouterProfile.CAR;
  }
  List<String> specs=new ArrayList<String>();
  if (!app.getSettings().FAST_ROUTE_MODE.get()) {
    specs.add(GeneralRouter.USE_SHORTEST_WAY);
  }
  if (app.getSettings().AVOID_FERRIES.get()) {
    specs.add(GeneralRouter.AVOID_FERRIES);
  }
  if (app.getSettings().AVOID_TOLL_ROADS.get()) {
    specs.add(GeneralRouter.AVOID_TOLL);
  }
  if (app.getSettings().AVOID_MOTORWAY.get()) {
    specs.add(GeneralRouter.AVOID_MOTORWAY);
  }
  if (app.getSettings().AVOID_UNPAVED_ROADS.get()) {
    specs.add(GeneralRouter.AVOID_UNPAVED);
  }
  String[] specialization=specs.toArray(new String[specs.size()]);
  float mb=(1 << 20);
  Runtime rt=Runtime.getRuntime();
  int memoryLimit=(int)(0.95 * ((rt.maxMemory() - rt.totalMemory()) + rt.freeMemory()) / mb);
  log.warn("Use " + memoryLimit + " MB Free "+ rt.freeMemory() / mb + " of " + rt.totalMemory() / mb + " max " + rt.maxMemory() / mb);
  RoutingConfiguration cf=config.build(p.name().toLowerCase(),params.start.hasBearing() ? params.start.getBearing() / 180d * Math.PI : null,memoryLimit,specialization);
  if (!params.optimal) {
    cf.heuristicCoefficient*=1.5;
  }
  RoutingContext ctx=new RoutingContext(cf,NativeOsmandLibrary.getLoadedLibrary(),files);
  ctx.interruptable=params.interruptable;
  if (params.previousToRecalculate != null) {
    ctx.previouslyCalculatedRoute=params.previousToRecalculate.getOriginalRoute();
  }
  RouteSegment st=router.findRouteSegment(params.start.getLatitude(),params.start.getLongitude(),ctx);
  if (st == null) {
    return new RouteCalculationResult(app.getString(R.string.starting_point_too_far));
  }
  RouteSegment en=router.findRouteSegment(params.end.getLatitude(),params.end.getLongitude(),ctx);
  if (en == null) {
    return new RouteCalculationResult(app.getString(R.string.ending_point_too_far));
  }
  List<RouteSegment> inters=new ArrayList<BinaryRoutePlanner.RouteSegment>();
  if (params.intermediates != null) {
    int ind=1;
    for (    LatLon il : params.intermediates) {
      RouteSegment is=router.findRouteSegment(il.getLatitude(),il.getLongitude(),ctx);
      if (is == null) {
        return new RouteCalculationResult(app.getString(R.string.intermediate_point_too_far,"'" + ind + "'"));
      }
      inters.add(is);
      ind++;
    }
  }
  try {
    List<RouteSegmentResult> result;
    if (inters.size() > 0) {
      result=router.searchRoute(ctx,st,en,inters,params.leftSide);
    }
 else {
      result=router.searchRoute(ctx,st,en,params.leftSide);
    }
    if (result == null || result.isEmpty()) {
      return new RouteCalculationResult("Empty result");
    }
 else {
      return new RouteCalculationResult(result,params.start,params.end,params.intermediates,app,params.leftSide);
    }
  }
 catch (  InterruptedException e) {
    return new RouteCalculationResult("Route calculation was interrupted");
  }
catch (  OutOfMemoryError e) {
    int max=(int)(Runtime.getRuntime().maxMemory() / (1 << 20));
    int avl=(int)(Runtime.getRuntime().freeMemory() / (1 << 20));
    String s=" (" + avl + " MB available of "+ max+ ") ";
    return new RouteCalculationResult("Not enough process memory " + s);
  }
}
